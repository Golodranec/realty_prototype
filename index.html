<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.4</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--bad:#dc2626;--border:#e5e7eb}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
h1{font-size:26px;margin:8px 0 4px}.sub{color:var(--muted);margin:0 0 14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 4px 18px rgba(0,0,0,.04)}
.row{display:flex;gap:10px;flex-wrap:wrap}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button,textarea{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;background:#fff;color:var(--text)}
input[type=number]{width:130px}
.btn{cursor:pointer}.btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
.btn-ghost{background:#fff}.btn-danger{background:#fff;color:var(--bad);border-color:#fecaca}
.grid{display:grid;gap:10px}@media(min-width:1000px){.grid-2{grid-template-columns:1.1fr .9fr}}
.list{display:grid;gap:10px}.item{display:grid;gap:8px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
.hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.muted{color:var(--muted)} .section-title{font-weight:700;margin:8px 0}.empty{color:var(--muted);padding:10px}
.footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.price{font-weight:800}
.thumb{width:100%;max-width:300px;height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.link{color:#2563eb;text-decoration:none}.link:hover{text-decoration:underline}
.gallery{position:relative;display:inline-block}
.gallery .nav{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;user-select:none}
.gallery .prev{left:6px}.gallery .next{right:6px}
.drafts{display:flex;gap:8px;flex-wrap:wrap}
.draft{position:relative;border:1px dashed var(--border);border-radius:10px;overflow:hidden}
.draft img{width:120px;height:80px;object-fit:cover;display:block}
.draft .x{position:absolute;top:4px;right:4px;background:#fff;border:1px solid var(--border);border-radius:8px;cursor:pointer;padding:2px 6px;font-size:12px}
.draft.drag{opacity:.6;border-color:#2563eb}
.help{font-size:12px;color:var(--muted);margin-top:4px}
.settings{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:12px;margin:10px 0}
.map-sm{width:100%;height:220px;border:1px solid var(--border);border-radius:12px}
.map-md{width:100%;height:260px;border:1px solid var(--border);border-radius:12px}
.dim{opacity:.45;pointer-events:none;filter:grayscale(10%)}
.modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
.modal .box{max-width:960px;width:100%;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.2)}
.modal .head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.modal .close{cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px}
.modal .body{display:grid;gap:12px}
.badge{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.section-hint{font-size:12px;color:var(--muted);margin:4px 0 8px}
.small{font-size:12px;color:var(--muted)}
hr{border:0;border-top:1px solid var(--border);margin:10px 0}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;margin:4px 6px 0 0}
.tag .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;padding:0 5px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div>
      <h1>üè† –ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>
      <div class="sub">–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ (localStorage). –ö–∞—Ä—Ç—ã ‚Äî Leaflet + OpenStreetMap.</div>
    </div>
    <div class="controls">
      <div class="settings card">
        <div>
          <label>–í–∞–ª—é—Ç–∞</label>
          <select id="s_currency"><option value="USD">USD</option><option value="UZS">UZS</option></select>
        </div>
        <div>
          <label>–ö—É—Ä—Å (UZS –∑–∞ 1 USD)</label>
          <input id="s_rate" type="number" min="1" value="12700" />
        </div>
        <button class="btn btn-ghost" id="btnSaveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <span class="muted" id="settingsInfo"></span>
      </div>
      <button class="btn btn-ghost" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <label class="btn btn-ghost" style="cursor:pointer">–ò–º–ø–æ—Ä—Ç
        <input type="file" accept="application/json" id="fileImport" style="display:none">
      </label>
      <button class="btn btn-danger" id="btnWipe">–°–±—Ä–æ—Å</button>
    </div>
  </div>

  <div id="notice" class="warn" style="display:none"></div>

  <div class="grid grid-2">
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card" id="filtersCard">
      <div class="section-title">–§–∏–ª—å—Ç—Ä</div>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
      <div class="row">
        <div>
          <label><input type="radio" name="mode" value="area" id="mode_area" checked> –ü–æ —Ä–∞–π–æ–Ω–∞–º/–∫–≤–∞—Ä—Ç–∞–ª–∞–º</label>
        </div>
        <div>
          <label><input type="radio" name="mode" value="radius" id="mode_radius"> –ü–æ —Ä–∞–¥–∏—É—Å—É</label>
        </div>
      </div>

      <!-- –†–ê–ô–û–ù–´ -->
      <div id="sec_districts">
        <div class="section-title" style="margin-top:0">–†–∞–π–æ–Ω—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</div>
        <div class="row" id="f_districts" style="gap:8px"></div>
      </div>

      <!-- –ö–í–ê–†–¢–ê–õ–´/–ú–ê–•–ê–õ–õ–ò -->
      <div id="sec_quarters">
        <div class="section-title">–ö–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏</div>
        <div class="section-hint" id="q_hint">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–∞–π–æ–Ω—ã ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∫–≤–∞—Ä—Ç–∞–ª–æ–≤ –∏ –º–∞—Ö–∞–ª–ª–µ–π —ç—Ç–∏—Ö —Ä–∞–π–æ–Ω–æ–≤ (–∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞).</div>
        <div class="row" id="f_quarters_box" style="gap:8px"></div>
        <div class="row">
          <div><label>–î–∏–∞–ø–∞–∑–æ–Ω –∫–≤–∞—Ä—Ç–∞–ª–æ–≤ –æ—Ç</label><input id="f_quarter_from" type="number" min="0" placeholder="–Ω–∞–ø—Ä. 5"></div>
          <div><label>–¥–æ</label><input id="f_quarter_to" type="number" min="0" placeholder="–Ω–∞–ø—Ä. 12"></div>
          <div style="flex:1"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç</label><input id="f_quarter_text" placeholder="–Ω–∞–ø—Ä. –ö—É–π–ª—é–∫, –ß–æ—Ä—Å—É..."></div>
        </div>
      </div>

      <!-- –†–ê–î–ò–£–° -->
      <div id="sec_radius" class="dim">
        <div class="section-title">–ü–æ–∏—Å–∫ –ø–æ —Ä–∞–¥–∏—É—Å—É</div>
        <div class="row">
          <div style="flex:1">
            <div id="f_map" class="map-sm"></div>
            <div class="help">–ü–æ—Å—Ç–∞–≤—å —Ç–æ—á–∫—É (—Ü–µ–Ω—Ç—Ä), —É–∫–∞–∂–∏ —Ä–∞–¥–∏—É—Å –Ω–∏–∂–µ. –í —Ä–µ–∂–∏–º —Ä–∞–¥–∏—É—Å–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –≤—ã—à–µ.</div>
          </div>
          <div>
            <label>–†–∞–¥–∏—É—Å (–∫–º)</label>
            <input id="f_radius" type="number" min="0" step="0.1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 5">
          </div>
        </div>
      </div>

      <!-- –æ–±—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <div class="row">
        <div><label>–¢–∏–ø</label>
          <select id="f_type"><option value="">–õ—é–±–æ–π</option><option value="flat">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option><option value="house">–î–æ–º</option><option value="land">–ó–µ–º–ª—è</option></select>
        </div>
        <div><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="f_status"><option value="">–õ—é–±–æ–π</option><option value="sale">–ü—Ä–æ–¥–∞—ë—Ç—Å—è</option><option value="rent">–ê—Ä–µ–Ω–¥–∞</option></select>
        </div>
      </div>

      <div class="row">
        <div><label>–¶–µ–Ω–∞ –æ—Ç</label><input id="f_price_from" type="number" min="0"></div>
        <div><label>–¶–µ–Ω–∞ –¥–æ</label><input id="f_price_to" type="number" min="0"></div>
        <div><label>–í–∞–ª—é—Ç–∞</label>
          <select id="f_currency"><option value="USD">USD</option><option value="UZS">UZS</option></select>
        </div>
      </div>

      <div class="row">
        <div><label>–ü–ª–æ—â–∞–¥—å –æ—Ç (–º¬≤)</label><input id="f_area_from" type="number" min="0"></div>
        <div><label>–ü–ª–æ—â–∞–¥—å –¥–æ (–º¬≤)</label><input id="f_area_to" type="number" min="0"></div>
      </div>

      <div class="row">
        <div><label>–ö–æ–º–Ω–∞—Ç –æ—Ç</label><input id="f_rooms_from" type="number" min="1"></div>
        <div><label>–ö–æ–º–Ω–∞—Ç –¥–æ</label><input id="f_rooms_to" type="number" min="1"></div>
      </div>

      <div class="row">
        <div><label>–≠—Ç–∞–∂ –æ—Ç</label><input id="f_floor_from" type="number" min="1"></div>
        <div><label>–≠—Ç–∞–∂ –¥–æ</label><input id="f_floor_to" type="number" min="1"></div>
      </div>

      <div class="row">
        <div><label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –æ—Ç</label><input id="f_floors_from" type="number" min="1"></div>
        <div><label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ</label><input id="f_floors_to" type="number" min="1"></div>
      </div>

      <div class="row">
        <div>
          <label>–ü–∞—Ä–∫–æ–≤–∫–∞</label>
          <select id="f_parking"><option value="">–õ—é–±–∞—è</option><option value="yes">–ï—Å—Ç—å</option><option value="no">–ù–µ—Ç</option></select>
        </div>
        <div>
          <label>–°–∞–Ω—É–∑–µ–ª</label>
          <select id="f_bath"><option value="">–õ—é–±–æ–π</option><option value="combined">–°–æ–≤–º–µ—â—ë–Ω–Ω—ã–π</option><option value="separate">–†–∞–∑–¥–µ–ª—å–Ω—ã–π</option><option value="multiple">–ù–µ—Å–∫–æ–ª—å–∫–æ</option></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="f_sort">
            <option value="date_desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
            <option value="date_asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
            <option value="price_asc">–¶–µ–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
            <option value="price_desc">–¶–µ–Ω–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            <option value="area_asc">–ü–ª–æ—â–∞–¥—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
            <option value="area_desc">–ü–ª–æ—â–∞–¥—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="btnApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnResetFilters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      </div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ -->
    <div class="card">
      <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</div>
      <div class="row">
        <div><label>–¢–∏–ø</label>
          <select id="a_type"><option value="flat">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option><option value="house">–î–æ–º</option><option value="land">–ó–µ–º–ª—è</option></select>
        </div>
        <div><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="a_status"><option value="sale">–ü—Ä–æ–¥–∞—ë—Ç—Å—è</option><option value="rent">–ê—Ä–µ–Ω–¥–∞</option></select>
        </div>
        <div style="flex:1"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="a_title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4-–∫–æ–º–Ω, –Æ–Ω—É—Å–∞–±–∞–¥ 9, —Ä–µ–º–æ–Ω—Ç"></div>
      </div>

      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="a_district"></select></div>
        <div><label>–ö–≤–∞—Ä—Ç–∞–ª/–º–∞—Ö–∞–ª—è</label><input id="a_quarter" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 9 –∫–≤–∞—Ä—Ç–∞–ª –∏–ª–∏ –ö—É–π–ª—é–∫ 5"></div>
        <div><label>–¶–µ–Ω–∞ (USD)</label><input id="a_price" type="number" min="0"></div>
        <div><label>–ü–ª–æ—â–∞–¥—å (–º¬≤)</label><input id="a_area" type="number" min="0"></div>
      </div>

      <div class="row">
        <div><label>–ö–æ–º–Ω–∞—Ç</label><input id="a_rooms" type="number" min="0"></div>
        <div><label>–≠—Ç–∞–∂</label><input id="a_floor" type="number" min="0"></div>
        <div><label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</label><input id="a_floors" type="number" min="0"></div>
      </div>

      <div class="row">
        <div>
          <label>–ü–∞—Ä–∫–æ–≤–∫–∞</label>
          <select id="a_parking"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option><option value="yes">–ï—Å—Ç—å</option><option value="no">–ù–µ—Ç</option></select>
        </div>
        <div>
          <label>–°–∞–Ω—É–∑–µ–ª</label>
          <select id="a_bath"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option><option value="combined">–°–æ–≤–º–µ—â—ë–Ω–Ω—ã–π</option><option value="separate">–†–∞–∑–¥–µ–ª—å–Ω—ã–π</option><option value="multiple">–ù–µ—Å–∫–æ–ª—å–∫–æ</option></select>
        </div>
      </div>

      <!-- –ö–∞—Ä—Ç–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ -->
      <div class="section-title">–õ–æ–∫–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      <div id="a_map" class="map-md"></div>
      <div class="row">
        <div><label>–®–∏—Ä–æ—Ç–∞</label><input id="a_lat" type="number" step="0.000001" placeholder="–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è"></div>
        <div><label>–î–æ–ª–≥–æ—Ç–∞</label><input id="a_lng" type="number" step="0.000001" placeholder="–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è"></div>
      </div>

      <div class="row">
        <div style="flex:1"><label>–§–æ—Ç–æ (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤)</label>
          <input id="a_files" type="file" accept="image/*" multiple>
          <div class="help">–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ. –ù–∏–∂–µ –ø—Ä–µ–≤—å—é ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –∏ –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º.</div>
          <div id="drafts" class="drafts"></div>
        </div>
      </div>

      <div class="row">
        <div style="flex:1"><label>–§–æ—Ç–æ –ø–æ URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input id="a_photos" placeholder="https://.../1.jpg, https://.../2.jpg"></div>
      </div>

      <div class="row">
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="a_phone" placeholder="+998..."></div>
        <div><label>Telegram username</label><input id="a_tg" placeholder="–±–µ–∑ @, –Ω–∞–ø—Ä–∏–º–µ—Ä: golodranec"></div>
      </div>

      <div class="row">
        <div style="flex:1"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="a_desc" rows="3" placeholder="–ö–ª—é—á–µ–≤—ã–µ –ø–ª—é—Å—ã, —á—Ç–æ —Ä—è–¥–æ–º"></textarea></div>
      </div>

      <div class="row">
        <button class="btn btn-primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnDemo">–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn btn-danger" id="btnClearObjects">–û—á–∏—Å—Ç–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã</button>
      </div>
      <div class="sub">–§–æ—Ç–æ –∏ –±–∞–∑–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ. –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç JSON –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤—Å—ë (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ç–æ base64).</div>

      <hr>

      <!-- –°–ü–†–ê–í–û–ß–ù–ò–ö –õ–û–ö–ê–¶–ò–ô -->
      <div class="section-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π –ø–æ —Ä–∞–π–æ–Ω–∞–º</div>
      <div class="small">–û—Ç—Å—é–¥–∞ –±–µ—Ä—É—Ç—Å—è –≥–∞–ª–æ—á–∫–∏ ¬´–∫–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏¬ª –≤ —Ñ–∏–ª—å—Ç—Ä–µ. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Å–µ–±—è.</div>
      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="loc_district"></select></div>
        <div style="flex:1"><label>–î–æ–±–∞–≤–∏—Ç—å –∫–≤–∞—Ä—Ç–∞–ª/–º–∞—Ö–∞–ª–ª—é</label><input id="loc_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö—É–π–ª—é–∫ 5 –∫–≤–∞—Ä—Ç–∞–ª"></div>
        <div><label>&nbsp;</label><button class="btn btn-ghost" id="loc_add">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </div>
      <div id="loc_tags"></div>
      <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–∞–π –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.</div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div class="card">
    <div class="hdr">
      <div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div class="muted">–ù–∞–π–¥–µ–Ω–æ: <span id="count">0</span></div>
    </div>
    <div id="results" class="list"></div>
    <div id="empty" class="empty" style="display:none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div id="modal" class="modal">
  <div class="box">
    <div class="head">
      <div id="m_title" class="section-title">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</div>
      <button id="m_close" class="close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="body">
      <div id="m_gallery"></div>
      <div id="m_meta" class="muted"></div>
      <div id="m_desc"></div>
      <div id="m_map" class="map-md" style="display:none"></div>
      <div id="m_actions" class="footer"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
(function(){
  console.log("v1.4 init");
  const DISTRICTS=["–Æ–Ω—É—Å–∞–±–∞–¥","–ú–∏—Ä–∑–æ-–£–ª—É–≥–±–µ–∫","–ß–∏–ª–∞–Ω–∑–∞—Ä","–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä","–Ø–∫–∫–∞—Å–∞—Ä–∞–π","–£—á—Ç–µ–ø–∞","–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π","–ê–ª–º–∞–∑–∞—Ä","–ë–µ–∫—Ç–µ–º–∏—Ä","–ú–∏—Ä–∞–±–∞–¥","–Ø—à–Ω–∞–±–∞–¥"];
  const LS_KEY="realty_objects_v7";
  const LS_SETTINGS="realty_settings_v1";
  const LS_LOC="realty_locations_v1";
  let objects=[];
  let settings={currency:"USD", rate:12700};
  // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π)
  let LOC_DIR = {
    "–Æ–Ω—É—Å–∞–±–∞–¥": Array.from({length:19},(_,i)=> (i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–ß–∏–ª–∞–Ω–∑–∞—Ä": Array.from({length:30},(_,i)=> (i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π": Array.from({length:10},(_,i)=> "–ö—É–π–ª—é–∫ "+(i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä": ["–ß–æ—Ä—Å—É","–≠—Å–∫–∏ —à–∞—Ö–∞—Ä"],
    "–Ø–∫–∫–∞—Å–∞—Ä–∞–π": ["–ö–∞–¥—ã—à–µ–≤–∞","–ì–ª–∏–Ω–∫–∞"],
    "–£—á—Ç–µ–ø–∞": [],
    "–ê–ª–º–∞–∑–∞—Ä": [],
    "–ë–µ–∫—Ç–µ–º–∏—Ä": [],
    "–ú–∏—Ä–∞–±–∞–¥": [],
    "–ú–∏—Ä–∑–æ-–£–ª—É–≥–±–µ–∫": [],
    "–Ø—à–Ω–∞–±–∞–¥": []
  };
  let galleryDraft=[];

  // –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞
  let mode="area"; // 'area' | 'radius'

  // –ö–∞—Ä—Ç—ã
  let fMap, fMarker=null, fCenter=null; // —Ñ–∏–ª—å—Ç—Ä —Ä–∞–¥–∏—É—Å–∞
  let aMap, aMarker=null; // –∞–¥–º–∏–Ω —Ç–æ—á–∫–∞
  let mLeaf=null; // –∫–∞—Ä—Ç–∞ –º–æ–¥–∞–ª–∫–∏

  // helpers
  const $=id=>document.getElementById(id);
  const el=(t,a={},h="")=>{const e=document.createElement(t);for(const k in a){k==="class"?e.className=a[k]:e.setAttribute(k,a[k])} if(h) e.innerHTML=h; return e};
  const typeLabel=t=>t==='flat'?'–ö–≤–∞—Ä—Ç–∏—Ä–∞':t==='house'?'–î–æ–º':t==='land'?'–ó–µ–º–ª—è':'‚Äî';
  const statusLabel=s=>s==='sale'?'–ü—Ä–æ–¥–∞—ë—Ç—Å—è':s==='rent'?'–ê—Ä–µ–Ω–¥–∞':'‚Äî';
  const esc=s=>(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
  const fmtUSD=n=>new Intl.NumberFormat('ru-RU',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
  const fmtUZS=n=>new Intl.NumberFormat('ru-RU').format(n)+" —Å—É–º";
  const toDisplayCurrency=usd=>(usd||usd===0)?(settings.currency==="USD"?fmtUSD(usd):fmtUZS(Math.round(usd*(settings.rate||12700)))):"";
  const normalizeFilterPrice=(val,cur)=>{const num=parseFloat(val);if(isNaN(num))return NaN;return cur==="USD"?num:num/(settings.rate||12700)};
  const distanceKm=(lat1,lon1,lat2,lon2)=>{const R=6371;const d2r=Math.PI/180;const dLat=(lat2-lat1)*d2r;const dLon=(lon2-lon1)*d2r;const a=Math.sin(dLat/2)**2+Math.cos(lat1*d2r)*Math.cos(lat2*d2r)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(a));};

  function showNotice(msg){ const n=$("notice"); n.textContent=msg; n.style.display="block"; }
  function hideNotice(){ $("notice").style.display="none"; }

  // --- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  function loadLocDir(){
    try{
      const saved = JSON.parse(localStorage.getItem(LS_LOC)||"{}");
      if(saved && typeof saved==="object"){
        LOC_DIR = Object.assign({}, LOC_DIR, saved);
      }
    }catch(_){}
  }
  function saveLocDir(){
    localStorage.setItem(LS_LOC, JSON.stringify(LOC_DIR));
  }

  // --- UI —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
  function initLocDirectoryUI(){
    const sel=$("loc_district");
    sel.innerHTML="";
    DISTRICTS.forEach(d=>{
      const o=el("option",{},d); o.value=d; sel.appendChild(o);
    });
    sel.addEventListener("change", renderLocTags);
    $("loc_add").addEventListener("click", ()=>{
      const d=sel.value;
      const name=($("loc_new").value||"").trim();
      if(!name) return;
      const list = LOC_DIR[d] || (LOC_DIR[d]=[]);
      if(!list.includes(name)) list.push(name);
      $("loc_new").value="";
      saveLocDir();
      renderLocTags();
      // –æ–±–Ω–æ–≤–∏–º —á–µ–∫–±–æ–∫—Å—ã —Ñ–∏–ª—å—Ç—Ä–∞, –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ä–∞–π–æ–Ω –≤—ã–±—Ä–∞–Ω
      renderQuarterCheckboxes();
    });
    renderLocTags();
  }
  function renderLocTags(){
    const d=$("loc_district").value;
    const box=$("loc_tags"); box.innerHTML="";
    const list = LOC_DIR[d] || [];
    if(list.length===0){
      box.innerHTML = '<div class="small">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∫–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏ –≤—ã—à–µ.</div>';
      return;
    }
    list.forEach((name,idx)=>{
      const t=el("span",{class:"tag"},`<span>${esc(name)}</span>`);
      const x=el("span",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{
        LOC_DIR[d].splice(idx,1);
        saveLocDir();
        renderLocTags();
        renderQuarterCheckboxes();
      });
      t.appendChild(x);
      box.appendChild(t);
    });
  }

  function initDistricts(){
    const box=$("f_districts"), sel=$("a_district");
    box.innerHTML=""; sel.innerHTML="";
    DISTRICTS.forEach(d=>{
      const label=el("label"); const input=el("input",{type:"checkbox","data-district":d}); const span=el("span",{},d);
      label.appendChild(input); label.appendChild(span); box.appendChild(label);
      const o=el("option",{},d); o.value=d; sel.appendChild(o);
    });
    $("f_districts").addEventListener("change",()=>{ renderQuarterCheckboxes(); });
  }

  function getChosenDistricts(){ return Array.from($("f_districts").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-district")); }

  // –°–æ–±–∏—Ä–∞–µ–º –∫–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏: –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ + –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–∞–π–æ–Ω–∞–º
  function collectQuartersFor(districts){
    const set=new Set();
    // –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    districts.forEach(d=>{
      (LOC_DIR[d]||[]).forEach(q=> set.add(q));
    });
    // –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    objects.forEach(o=>{
      if(!o.district) return;
      if(districts.length && !districts.includes(o.district)) return;
      if(o.quarter && o.quarter.trim()){
        o.quarter.split(",").map(s=>s.trim()).filter(Boolean).forEach(q=>set.add(q));
      }
    });
    return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
  }

  function renderQuarterCheckboxes(){
    const chosen=getChosenDistricts();
    const box=$("f_quarters_box");
    const hint=$("q_hint");
    box.innerHTML="";
    if(chosen.length===0){
      hint.textContent="–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–∞–π–æ–Ω—ã ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∫–≤–∞—Ä—Ç–∞–ª–æ–≤ –∏ –º–∞—Ö–∞–ª–ª–µ–π —ç—Ç–∏—Ö —Ä–∞–π–æ–Ω–æ–≤ (–∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞).";
      return;
    }
    const quarters=collectQuartersFor(chosen);
    if(quarters.length===0){
      hint.textContent="–í –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö –ø–æ–∫–∞ –Ω–µ—Ç –ø—É–Ω–∫—Ç–æ–≤ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ. –î–æ–±–∞–≤—å –∏—Ö –Ω–∏–∂–µ –≤ ¬´–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –ª–æ–∫–∞—Ü–∏–π¬ª.";
      return;
    }
    hint.textContent="–û—Ç–º–µ—Ç—å –Ω—É–∂–Ω—ã–µ –∫–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ).";
    quarters.forEach(q=>{
      const label=el("label");
      const input=el("input",{type:"checkbox","data-quarter":q});
      const span=el("span",{},q);
      label.appendChild(input); label.appendChild(span); box.appendChild(label);
    });
  }

  function load(){
    try{objects=JSON.parse(localStorage.getItem(LS_KEY)||"[]")}catch(_){objects=[]}
    try{settings=Object.assign(settings, JSON.parse(localStorage.getItem(LS_SETTINGS)||"{}"))}catch(_){}
    loadLocDir();
    $("s_currency").value=settings.currency;
    $("s_rate").value=String(settings.rate||12700);
    $("settingsInfo").textContent=`–ü–æ–∫–∞–∑: ${settings.currency}, –∫—É—Ä—Å ${settings.rate} UZS`;
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(objects)); }
  function saveSettings(){
    settings.currency=$("s_currency").value;
    settings.rate=parseFloat($("s_rate").value)||12700;
    localStorage.setItem(LS_SETTINGS, JSON.stringify(settings));
    $("settingsInfo").textContent=`–ü–æ–∫–∞–∑: ${settings.currency}, –∫—É—Ä—Å ${settings.rate} UZS`;
    apply();
  }

  function permalinkFor(o){ const base=location.origin+location.pathname; return `${base}#id=${encodeURIComponent(o.id)}`; }
  function bathLabel(v){ return v==="combined"?"—Å–æ–≤–º–µ—â—ë–Ω–Ω—ã–π":v==="separate"?"—Ä–∞–∑–¥–µ–ª—å–Ω—ã–π":"–Ω–µ—Å–∫–æ–ª—å–∫–æ"; }

  function galleryNode(photos){
    if(!photos||!photos.length) return null;
    let idx=0;
    const img=el("img",{class:"thumb",src:photos[0],alt:"photo"});
    const g=el("div",{class:"gallery"});
    const prev=el("div",{class:"nav prev"},"‚Äπ");
    const next=el("div",{class:"nav next"},"‚Ä∫");
    const update=()=>{ img.src=photos[idx]; };
    prev.addEventListener("click",()=>{ idx=(idx-1+photos.length)%photos.length; update(); });
    next.addEventListener("click",()=>{ idx=(idx+1)%photos.length; update(); });
    g.appendChild(img);
    if(photos.length>1){ g.appendChild(prev); g.appendChild(next); }
    return g;
  }

  // –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê
  function render(list=objects){
    const res=$("results"), empty=$("empty");
    res.innerHTML=""; $("count").textContent=String(list.length);
    empty.style.display=list.length?"none":"block";
    list.forEach(o=>{
      const it=el("div",{class:"item", id:`card-${o.id}`});
      const head=el("div",{class:"row"});
      head.innerHTML=`
        <div class="pill">${typeLabel(o.type)}</div>
        <div class="pill">${statusLabel(o.status)}</div>
        <div class="pill">${o.district}${o.quarter?(", "+esc(o.quarter)):""}</div>
        ${o.type==='flat'&&o.rooms?`<div class="pill">${o.rooms} –∫–æ–º–Ω</div>`:""}
        ${o.type==='flat'&&(o.floor||o.floors)?`<div class="pill">—ç—Ç–∞–∂ ${o.floor||"-"}/${o.floors||"-"}</div>`:""}
        ${o.parking?`<div class="pill">–ü–∞—Ä–∫–æ–≤–∫–∞: ${o.parking==='yes'?'–µ—Å—Ç—å':'–Ω–µ—Ç'}</div>`:""}
        ${o.bath?`<div class="pill">–°/—É: ${bathLabel(o.bath)}</div>`:""}
      `;
      const titleLink=el("a",{href:"#",class:"section-title"},esc(o.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"));
      titleLink.addEventListener("click",(e)=>{e.preventDefault(); openModal(o);});
      const meta=el("div",{class:"muted"},`–ü–ª–æ—â–∞–¥—å: ${o.area?o.area+" –º¬≤":"‚Äî"} ‚Ä¢ <span class="price">${(o.price||o.price===0)?toDisplayCurrency(o.price):"–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</span>`);

      const gal=galleryNode(o.photos);
      const actions=el("div",{class:"footer"});
      const openBtn=el("button",{class:"btn btn-ghost"},"–û—Ç–∫—Ä—ã—Ç—å"); openBtn.addEventListener("click",()=>openModal(o));
      const del=el("button",{class:"btn btn-danger"},"–£–¥–∞–ª–∏—Ç—å"); del.addEventListener("click",()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?")){ objects=objects.filter(x=>x.id!==o.id); save(); apply(); }});
      actions.appendChild(openBtn);
      actions.appendChild(el("a",{href:permalinkFor(o),class:"link"},"–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ"));
      actions.appendChild(del);

      it.appendChild(head);
      it.appendChild(titleLink);
      if(gal) it.appendChild(gal);
      it.appendChild(meta);
      it.appendChild(actions);
      res.appendChild(it);
    });

    if(location.hash.startsWith("#id=")){
      const id=decodeURIComponent(location.hash.slice(4));
      const elCard = document.getElementById(`card-${id}`);
      if(elCard) elCard.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  // –ú–û–î–ê–õ–ö–ê
  let m, m_close, m_title, m_gallery, m_meta, m_desc, m_map, m_actions, mLeaf=null;
  function initModal(){
    m=$("modal"); m_close=$("m_close"); m_title=$("m_title"); m_gallery=$("m_gallery"); m_meta=$("m_meta"); m_desc=$("m_desc"); m_map=$("m_map"); m_actions=$("m_actions");
    m_close.addEventListener("click",closeModal);
    m.addEventListener("click",(e)=>{ if(e.target===m) closeModal(); });
  }
  function openModal(o){
    m_title.textContent=o.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
    m_gallery.innerHTML=""; m_meta.innerHTML=""; m_desc.innerHTML=""; m_actions.innerHTML="";
    const g=galleryNode(o.photos); if(g) m_gallery.appendChild(g);
    m_meta.innerHTML = `
      <div>–¢–∏–ø: <b>${typeLabel(o.type)}</b>, —Å—Ç–∞—Ç—É—Å: <b>${statusLabel(o.status)}</b></div>
      <div>–ê–¥—Ä–µ—Å: <b>${esc(o.district)}${o.quarter?(", "+esc(o.quarter)):""}</b></div>
      <div>–ü–ª–æ—â–∞–¥—å: <b>${o.area||"-"} –º¬≤</b> ‚Ä¢ –¶–µ–Ω–∞: <b>${(o.price||o.price===0)?toDisplayCurrency(o.price):"–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</b></div>
      ${o.type==='flat'?`<div>–ö–æ–º–Ω–∞—Ç: <b>${o.rooms||"-"}</b> ‚Ä¢ –≠—Ç–∞–∂: <b>${o.floor||"-"}</b> / <b>${o.floors||"-"}</b></div>`:""}
      ${o.parking?`<div>–ü–∞—Ä–∫–æ–≤–∫–∞: <b>${o.parking==='yes'?'–µ—Å—Ç—å':'–Ω–µ—Ç'}</b></div>`:""}
      ${o.bath?`<div>–°/—É: <b>${bathLabel(o.bath)}</b></div>`:""}
    `;
    if(o.desc) m_desc.textContent=o.desc;

    if(o.lat && o.lng){
      m_map.style.display="block";
      setTimeout(()=>{
        if(mLeaf){ mLeaf.remove(); mLeaf=null; }
        mLeaf = L.map('m_map').setView([o.lat,o.lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(mLeaf);
        L.marker([o.lat,o.lng]).addTo(mLeaf);
      }, 50);
    }else{
      m_map.style.display="none";
      if(mLeaf){ mLeaf.remove(); mLeaf=null; }
    }

    if(o.phone) m_actions.appendChild(el("a",{href:`tel:${o.phone}`,class:"link"},"–ü–æ–∑–≤–æ–Ω–∏—Ç—å"));
    if(o.tg){
      const text=encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ${permalinkFor(o)}`);
      const tg=`https://t.me/${encodeURIComponent(o.tg)}?text=${text}`;
      m_actions.appendChild(el("a",{href:tg,target:"_blank",rel:"noopener",class:"link"},"–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram"));
    }
    m_actions.appendChild(el("a",{href:permalinkFor(o),class:"link"},"–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ"));
    const del=el("button",{class:"btn btn-danger"},"–£–¥–∞–ª–∏—Ç—å");
    del.addEventListener("click",()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?")){ objects=objects.filter(x=>x.id!==o.id); save(); closeModal(); apply(); }});
    m_actions.appendChild(del);

    m.style.display="flex";
  }
  function closeModal(){ m.style.display="none"; if(mLeaf){ mLeaf.remove(); mLeaf=null; } }

  // –§–ò–õ–¨–¢–†
  function getChosenQuarters(){ return Array.from($("f_quarters_box").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-quarter").toLowerCase()); }

  function apply(){
    const type=$("f_type").value, status=$("f_status").value;
    const fcur=$("f_currency").value;
    const price_from= normalizeFilterPrice($("f_price_from").value, fcur);
    const price_to  = normalizeFilterPrice($("f_price_to").value,   fcur);
    const area_from=parseFloat($("f_area_from").value), area_to=parseFloat($("f_area_to").value);
    const rooms_from=parseInt($("f_rooms_from").value), rooms_to=parseInt($("f_rooms_to").value);
    const floor_from=parseInt($("f_floor_from").value), floor_to=parseInt($("f_floor_to").value);
    const floors_from=parseInt($("f_floors_from").value), floors_to=parseInt($("f_floors_to").value);
    const fParking=$("f_parking").value, fBath=$("f_bath").value;
    const sort=$("f_sort").value;

    const chosenD=getChosenDistricts();
    const chosenQ=getChosenQuarters();
    const qFrom=parseInt($("f_quarter_from").value), qTo=parseInt($("f_quarter_to").value);
    const qText=($("f_quarter_text").value||"").toLowerCase().trim();

    const radiusKm=parseFloat($("f_radius").value);
    const radiusActive=(mode==="radius" && fCenter && !isNaN(radiusKm) && radiusKm>0);

    let list=objects.filter(o=>{
      if(type && o.type!==type) return false;
      if(status && o.status!==status) return false;

      if(mode==="area"){
        if(chosenD.length>0 && !chosenD.includes(o.district)) return false;

        const oq=(o.quarter||"").toLowerCase();
        if(chosenQ.length>0){
          let ok=false; for(const q of chosenQ){ if(oq.includes(q)) { ok=true; break; } }
          if(!ok) return false;
        }
        if(!isNaN(qFrom)||!isNaN(qTo)){
          const num=parseInt(oq.replace(/[^\d]/g,""));
          if(!isNaN(qFrom) && (!num || num<qFrom)) return false;
          if(!isNaN(qTo)   && (!num || num>qTo))   return false;
        }
        if(qText && !oq.includes(qText)) return false;
      }else{
        if(!radiusActive) return false;
        if(!(o.lat&&o.lng)) return false;
        const d=distanceKm(fCenter.lat,fCenter.lng,o.lat,o.lng);
        if(d>radiusKm) return false;
      }

      if(!isNaN(price_from) && o.price && o.price<price_from) return false;
      if(!isNaN(price_to)   && o.price && o.price>price_to)   return false;
      if(!isNaN(area_from)  && o.area  && o.area<area_from)   return false;
      if(!isNaN(area_to)    && o.area  && o.area>area_to)     return false;

      if(o.type==='flat'){
        if(!isNaN(rooms_from)&& o.rooms && o.rooms<rooms_from) return false;
        if(!isNaN(rooms_to)  && o.rooms && o.rooms>rooms_to)   return false;
        if(!isNaN(floor_from)&& o.floor && o.floor<floor_from) return false;
        if(!isNaN(floor_to)  && o.floor && o.floor>floor_to)   return false;
        if(!isNaN(floors_from)&&o.floors&& o.floors<floors_from) return false;
        if(!isNaN(floors_to)  &&o.floors&& o.floors>floors_to)   return false;
      }

      if(fParking && (o.parking||"")!==fParking) return false;
      if(fBath && (o.bath||"")!==fBath) return false;

      return true;
    });

    const by = {
      date_desc:(a,b)=> (b.created||0)-(a.created||0),
      date_asc:(a,b)=> (a.created||0)-(b.created||0),
      price_asc:(a,b)=> (a.price||0)-(b.price||0),
      price_desc:(a,b)=> (b.price||0)-(a.price||0),
      area_asc:(a,b)=> (a.area||0)-(b.area||0),
      area_desc:(a,b)=> (b.area||0)-(a.area||0),
    }[sort] || ((a,b)=>0);
    list.sort(by);

    render(list);
  }

  function resetFilters(){
    ["f_type","f_status","f_price_from","f_price_to","f_area_from","f_area_to","f_rooms_from","f_rooms_to","f_floor_from","f_floor_to","f_floors_from","f_floors_to","f_quarter_from","f_quarter_to","f_quarter_text","f_parking","f_bath","f_currency","f_sort","f_radius"].forEach(id=>{$(id).value=""});
    $("f_currency").value="USD"; $("f_sort").value="date_desc";
    $("f_districts").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
    $("f_quarters_box").innerHTML="";
    fCenter=null; if(fMarker){ fMap.removeLayer(fMarker); fMarker=null; }
    render(objects);
  }

  // –ß–µ—Ä–Ω–æ–≤–∏–∫ –≥–∞–ª–µ—Ä–µ–∏
  function renderDrafts(){
    const box=$("drafts"); box.innerHTML="";
    galleryDraft.forEach((it,idx)=>{
      const d=el("div",{class:"draft",draggable:"true","data-idx":idx});
      const img=el("img",{src:it.dataURL,alt:"photo"});
      const x=el("div",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{ galleryDraft.splice(idx,1); renderDrafts(); });
      d.appendChild(img); d.appendChild(x);

      d.addEventListener("dragstart",e=>{ d.classList.add("drag"); e.dataTransfer.setData("text/plain", String(idx)); });
      d.addEventListener("dragend",()=>{ d.classList.remove("drag"); });
      d.addEventListener("dragover",e=>{ e.preventDefault(); d.classList.add("drag"); });
      d.addEventListener("dragleave",()=>{ d.classList.remove("drag"); });
      d.addEventListener("drop",e=>{
        e.preventDefault();
        const from=Number(e.dataTransfer.getData("text/plain"));
        const to=idx;
        if(from===to) return;
        const [moved]=galleryDraft.splice(from,1);
        galleryDraft.splice(to,0,moved);
        renderDrafts();
      });

      box.appendChild(d);
    });
  }

  async function filesToDataURLs(files){
    const arr=[];
    for(const f of files){
      const data = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
      arr.push({dataURL:data, id:Date.now()+"-"+Math.random().toString(16).slice(2)});
    }
    return arr;
  }
  async function handleFiles(){
    const input=$("a_files");
    const files=input.files;
    if(!files || !files.length) return;
    const items = await filesToDataURLs(files);
    galleryDraft = galleryDraft.concat(items);
    input.value="";
    renderDrafts();
  }

  async function addObject(){
    const urlsRaw=$("a_photos").value.trim();
    const urlPhotos = urlsRaw? urlsRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];
    const draftPhotos = galleryDraft.map(x=>x.dataURL);

    const o={
      id:String(Date.now()),
      created:Date.now(),
      type:$("a_type").value, status:$("a_status").value, title:$("a_title").value.trim(),
      district:$("a_district").value, quarter:$("a_quarter").value.trim(),
      price:parseFloat($("a_price").value)||0, area:parseFloat($("a_area").value)||0,
      rooms:parseInt($("a_rooms").value)||0, floor:parseInt($("a_floor").value)||0, floors:parseInt($("a_floors").value)||0,
      parking:$("a_parking").value, bath:$("a_bath").value,
      photos:[...draftPhotos, ...urlPhotos],
      phone:$("a_phone").value.trim(), tg:$("a_tg").value.trim(),
      lat: parseFloat($("a_lat").value)||null, lng: parseFloat($("a_lng").value)||null,
      desc:$("a_desc").value.trim()
    };
    objects.push(o); save();

    ["a_title","a_quarter","a_price","a_area","a_rooms","a_floor","a_floors","a_photos","a_phone","a_tg","a_desc","a_lat","a_lng"].forEach(id=>{$(id).value=""});
    ["a_parking","a_bath"].forEach(id=>{$(id).value=""});
    $("a_files").value="";
    galleryDraft=[]; renderDrafts();

    renderQuarterCheckboxes();
    apply();
  }

  function clearObjects(){ if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã?")){ objects=[]; save(); render(objects); renderQuarterCheckboxes(); } }
  function exportJSON(){ const data=JSON.stringify(objects,null,2); const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([data],{type:"application/json"})); a.download="realty_backup.json"; a.click(); }
  function importJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){objects=arr; save(); renderQuarterCheckboxes(); apply(); alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ")} else alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"); }catch(_){ alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ"); } }; r.readAsText(file); }

  function demo(){
    if(objects.length>0) return;
    objects=[
      {id:"1",created:Date.now()-400000,type:"flat",status:"sale",title:"5-–∫–æ–º–Ω, –Æ–Ω—É—Å–∞–±–∞–¥ 9, —Ä–µ–º–æ–Ω—Ç",district:"–Æ–Ω—É—Å–∞–±–∞–¥",quarter:"9 –∫–≤–∞—Ä—Ç–∞–ª",price:120000,area:106,rooms:5,floor:3,floors:4,parking:"yes",bath:"separate",
        photos:["https://picsum.photos/seed/a1/600/400","https://picsum.photos/seed/a2/600/400"],phone:"+998901234567",tg:"golodranec",lat:41.366, lng:69.286, desc:"–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, 2 —Å–∞–Ω—É–∑–ª–∞, –ø–∞—Ä–∫–æ–≤–∫–∞"},
      {id:"2",created:Date.now()-300000,type:"flat",status:"rent",title:"2-–∫–æ–º–Ω, –°–µ—Ä–≥–µ–ª–∏, –ö—É–π–ª—é–∫ 5",district:"–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π",quarter:"–ö—É–π–ª—é–∫ 5 –∫–≤–∞—Ä—Ç–∞–ª",price:600,area:65,rooms:2,floor:5,floors:9,parking:"no",bath:"combined",
        photos:["https://picsum.photos/seed/b1/600/400"],phone:"+998931112233",tg:"",lat:41.246, lng:69.214, desc:"–°–≤–µ—Ç–ª–∞—è, —Ä—è–¥–æ–º —à–∫–æ–ª–∞ –∏ –º–µ—Ç—Ä–æ"},
      {id:"3",created:Date.now()-200000,type:"house",status:"sale",title:"–î–æ–º, –®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä, –ß–æ—Ä—Å—É",district:"–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä",quarter:"–ß–æ—Ä—Å—É",price:95000,area:120,rooms:4,parking:"yes",bath:"multiple",
        photos:["https://picsum.photos/seed/c1/600/400"],phone:"",tg:"",lat:41.327, lng:69.23, desc:"–ú–æ–∂–Ω–æ –∂–∏—Ç—å, –∫–∏—Ä–ø–∏—á, –¥–≤–æ—Ä"},
      {id:"4",created:Date.now()-100000,type:"land",status:"sale",title:"–£—á–∞—Å—Ç–æ–∫ 6 —Å–æ—Ç–æ–∫",district:"–ê–ª–º–∞–∑–∞—Ä",quarter:"",price:70000,area:600,
        photos:["https://picsum.photos/seed/d1/600/400"],desc:"–ü–æ–¥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ —Ä—è–¥–æ–º", lat:41.354, lng:69.203}
    ];
    save();
  }

  // –ö–∞—Ä—Ç—ã
  function initFilterMap(){
    fMap = L.map('f_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(fMap);
    fMap.on('click', (e)=>{
      fCenter = e.latlng;
      if(!fMarker){ fMarker=L.marker(fCenter,{draggable:true}).addTo(fMap); fMarker.on('dragend', ()=>{ fCenter=fMarker.getLatLng(); }); }
      else { fMarker.setLatLng(fCenter); }
    });
  }
  function initAdminMap(){
    aMap = L.map('a_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(aMap);
    aMap.on('click',(e)=>{
      const lat=e.latlng.lat, lng=e.latlng.lng;
      $("a_lat").value=lat.toFixed(6);
      $("a_lng").value=lng.toFixed(6);
      if(!aMarker){ aMarker=L.marker(e.latlng,{draggable:true}).addTo(aMap); aMarker.on('dragend',()=>{ const p=aMarker.getLatLng(); $("a_lat").value=p.lat.toFixed(6); $("a_lng").value=p.lng.toFixed(6); }); }
      else { aMarker.setLatLng(e.latlng); }
    });
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
  function setMode(newMode){
    mode=newMode;
    const secD=$("sec_districts"), secQ=$("sec_quarters"), secR=$("sec_radius");
    if(mode==="area"){
      secD.classList.remove("dim"); secQ.classList.remove("dim");
      secR.classList.add("dim");
    }else{
      secD.classList.add("dim"); secQ.classList.add("dim");
      secR.classList.remove("dim");
    }
  }

  document.addEventListener("DOMContentLoaded",()=>{
    load(); demo();
    initDistricts(); hideNotice();
    initModal();
    initFilterMap();
    initAdminMap();
    initLocDirectoryUI();

    render(objects);
    renderQuarterCheckboxes();

    $("btnApply").addEventListener("click",apply);
    $("btnResetFilters").addEventListener("click",resetFilters);
    $("btnAdd").addEventListener("click",()=>{addObject().catch(console.error)});
    $("btnDemo").addEventListener("click",()=>{ if(confirm("–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–º–æ? (–¥–æ–±–∞–≤–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–∏–º)")){ demo(); renderQuarterCheckboxes(); apply(); }});
    $("btnClearObjects").addEventListener("click",clearObjects);
    $("btnExport").addEventListener("click",exportJSON);
    $("fileImport").addEventListener("change",e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });
    $("btnWipe").addEventListener("click",()=>{ if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë (–æ–±—ä–µ–∫—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä—ã)?")){ localStorage.removeItem(LS_KEY); objects=[]; render(objects); renderQuarterCheckboxes(); }});
    $("a_files").addEventListener("change",()=>{handleFiles().catch(console.error)});
    $("btnSaveSettings").addEventListener("click",saveSettings);

    $("mode_area").addEventListener("change",e=>{ if(e.target.checked) setMode("area"); });
    $("mode_radius").addEventListener("change",e=>{ if(e.target.checked) setMode("radius"); });

    if(location.hash.startsWith("#id=")){
      const id=decodeURIComponent(location.hash.slice(4));
      const o=objects.find(x=>x.id===id);
      if(o) setTimeout(()=>openModal(o),150);
    }

    // –°–µ–ª–µ–∫—Ç–æ—Ä —Ä–∞–π–æ–Ω–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä —Ä–∞–π–æ–Ω–∞ –≤ –∞–¥–º–∏–Ω–∫–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ —Å–ø–∏—Å–∫—É DISTRICTS
    const locSel=$("loc_district"), adSel=$("a_district");
    adSel.innerHTML=""; DISTRICTS.forEach(d=>{const o=el("option",{},d); o.value=d; adSel.appendChild(o);});
  });
})();
</script>
</body>
</html>
