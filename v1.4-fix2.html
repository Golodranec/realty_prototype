<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.4-fix2</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--bad:#dc2626;--border:#e5e7eb}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
h1{font-size:26px;margin:8px 0 4px}.sub{color:var(--muted);margin:0 0 14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 4px 18px rgba(0,0,0,.04)}
.row{display:flex;gap:10px;flex-wrap:wrap}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button,textarea{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;background:#fff;color:var(--text)}
input[type=number]{width:130px}
.btn{cursor:pointer}.btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
.btn-ghost{background:#fff}.btn-danger{background:#fff;color:var(--bad);border-color:#fecaca}
.grid{display:grid;gap:10px}@media(min-width:1000px){.grid-2{grid-template-columns:1.1fr .9fr}}
.list{display:grid;gap:10px}.item{display:grid;gap:8px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
.hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.muted{color:var(--muted)} .section-title{font-weight:700;margin:8px 0}.empty{color:var(--muted);padding:10px}
.footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.price{font-weight:800}
.thumb{width:100%;max-width:300px;height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.link{color:#2563eb;text-decoration:none}.link:hover{text-decoration:underline}
.gallery{position:relative;display:inline-block}
.gallery .nav{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;user-select:none}
.gallery .prev{left:6px}.gallery .next{right:6px}
.counter{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div>
      <h1>üè† –ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ v1.4-fix2</h1>
      <div class="sub">–§–∏–ª—å—Ç—Ä—ã + –∫–≤–∞—Ä—Ç–∞–ª—ã + Telegram + –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ</div>
    </div>
  </div>

  <div class="grid grid-2">
    <div class="card" id="filtersCard">
      <div class="section-title">–§–∏–ª—å—Ç—Ä</div>
      <div class="row" id="f_districts"></div>
      <div class="row" id="f_quarters"></div>
      <div class="row">
        <div><label>–¢–∏–ø</label>
          <select id="f_type"><option value="">–õ—é–±–æ–π</option><option value="flat">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option><option value="house">–î–æ–º</option><option value="land">–ó–µ–º–ª—è</option></select>
        </div>
        <div><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="f_status"><option value="">–õ—é–±–æ–π</option><option value="sale">–ü—Ä–æ–¥–∞—ë—Ç—Å—è</option><option value="rent">–ê—Ä–µ–Ω–¥–∞</option></select>
        </div>
      </div>
      <div class="row">
        <div><label>–¶–µ–Ω–∞ –æ—Ç</label><input id="f_price_from" type="number"></div>
        <div><label>–¥–æ</label><input id="f_price_to" type="number"></div>
      </div>
      <div class="row">
        <div><label>–ü–ª–æ—â–∞–¥—å –æ—Ç</label><input id="f_area_from" type="number"></div>
        <div><label>–¥–æ</label><input id="f_area_to" type="number"></div>
      </div>
      <div class="row">
        <button class="btn btn-primary" id="btnApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</div>
      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="a_district"></select></div>
        <div><label>–ö–≤–∞—Ä—Ç–∞–ª</label><input id="a_quarter"></div>
        <div><label>–¶–µ–Ω–∞</label><input id="a_price" type="number"></div>
      </div>
      <div class="row">
        <div><label>–§–æ—Ç–æ URL</label><input id="a_photos"></div>
        <div><label>Telegram</label><input id="a_tg"></div>
      </div>
      <div class="row">
        <button class="btn btn-primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnDemo">–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="hdr">
      <div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div class="muted">–ù–∞–π–¥–µ–Ω–æ: <span id="count">0</span></div>
    </div>
    <div id="results" class="list"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const districts = {
    "–Æ–Ω—É—Å–∞–±–∞–¥": Array.from({length:19},(_,i)=> (i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–ß–∏–ª–∞–Ω–∑–∞—Ä": Array.from({length:30},(_,i)=> (i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–°–µ—Ä–≥–µ–ª–∏": Array.from({length:10},(_,i)=> "–ö—É–π–ª—é–∫ "+(i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
    "–ú–∏—Ä–∞–±–∞–¥": [],
    "–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä": [],
    "–£—á—Ç–µ–ø–∞": [],
    "–ú–∏—Ä–∑–æ-–£–ª—É–≥–±–µ–∫": [],
    "–Ø–∫–∫–∞—Å–∞—Ä–∞–π": [],
    "–ê–ª–º–∞–∑–∞—Ä": [],
    "–ë–µ–∫—Ç–µ–º–∏—Ä": [],
    "–Ø—à–Ω–∞–±–∞–¥": []
  };

  let objects = [];

  const $ = id => document.getElementById(id);
  const el = (t,a={},h="") => {const e=document.createElement(t);for(const k in a) e.setAttribute(k,a[k]); if(h) e.innerHTML=h; return e;};

  function renderDistricts(){
    const box=$("f_districts"), sel=$("a_district");
    box.innerHTML=""; sel.innerHTML="";
    Object.keys(districts).forEach(d=>{
      const l=el("label");
      const cb=el("input",{type:"checkbox","data-district":d});
      l.appendChild(cb); l.appendChild(document.createTextNode(" "+d));
      box.appendChild(l);
      const opt=el("option",{value:d},d);
      sel.appendChild(opt);
    });
  }

  function renderQuarters(){
    const chosen = Array.from($("f_districts").querySelectorAll("input:checked")).map(cb=>cb.getAttribute("data-district"));
    const box=$("f_quarters");
    box.innerHTML="";
    chosen.forEach(d=>{
      (districts[d]||[]).forEach(q=>{
        const l=el("label");
        const cb=el("input",{type:"checkbox","data-quarter":q});
        l.appendChild(cb); l.appendChild(document.createTextNode(" "+d+" ‚Äî "+q));
        box.appendChild(l);
      });
    });
  }

  function applyFilter(){
    let list=objects.slice();
    const chosenD=Array.from($("f_districts").querySelectorAll("input:checked")).map(cb=>cb.getAttribute("data-district"));
    const chosenQ=Array.from($("f_quarters").querySelectorAll("input:checked")).map(cb=>cb.getAttribute("data-quarter"));
    const type=$("f_type").value, status=$("f_status").value;
    const pf=parseFloat($("f_price_from").value)||0, pt=parseFloat($("f_price_to").value)||Infinity;
    const af=parseFloat($("f_area_from").value)||0, at=parseFloat($("f_area_to").value)||Infinity;

    list=list.filter(o=>{
      if(type && o.type!==type) return false;
      if(status && o.status!==status) return false;
      if(chosenD.length && !chosenD.includes(o.district)) return false;
      if(chosenQ.length && !chosenQ.includes(o.quarter)) return false;
      if(o.price<pf || o.price>pt) return false;
      if(o.area<af || o.area>at) return false;
      return true;
    });

    renderResults(list);
  }

  function renderResults(list){
    const res=$("results"); res.innerHTML="";
    $("count").textContent=list.length;
    list.forEach(o=>{
      const it=el("div",{class:"item",id:"obj-"+o.id});
      const h=el("div",{class:"hdr"}, `<b>${o.title}</b>`);
      const meta=el("div",{class:"muted"}, `${o.district}, ${o.quarter||""} ‚Ä¢ ${o.area} –º¬≤ ‚Ä¢ ${o.price} $`);
      let g="";
      if(o.photos && o.photos.length){
        g=galleryNode(o.photos);
      }
      const tg=o.tg? `<a href="https://t.me/${o.tg}?text=${encodeURIComponent("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: "+location.href+"#id="+o.id)}" target="_blank" class="link">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>`:"";
      it.appendChild(h);
      if(g) it.appendChild(g);
      it.appendChild(meta);
      if(tg) it.appendChild(el("div",{},tg));
      res.appendChild(it);
    });
  }

  function galleryNode(photos){
    if(!photos.length) return null;
    let idx=0;
    const g=el("div",{class:"gallery"});
    const img=el("img",{class:"thumb",src:photos[0]});
    const prev=el("div",{class:"nav prev"},"‚Äπ");
    const next=el("div",{class:"nav next"},"‚Ä∫");
    const counter=el("div",{class:"counter"},"–§–æ—Ç–æ 1/"+photos.length);
    const upd=()=>{img.src=photos[idx];counter.textContent="–§–æ—Ç–æ "+(idx+1)+"/"+photos.length;};
    prev.onclick=()=>{idx=(idx-1+photos.length)%photos.length;upd();};
    next.onclick=()=>{idx=(idx+1)%photos.length;upd();};
    g.appendChild(img); g.appendChild(prev); g.appendChild(next); g.appendChild(counter);
    return g;
  }

  function addObject(){
    const d=$("a_district").value, q=$("a_quarter").value.trim();
    const p=parseFloat($("a_price").value)||0;
    const phs=$("a_photos").value.split(",").map(s=>s.trim()).filter(Boolean);
    const tg=$("a_tg").value.trim();
    const o={id:Date.now()+"",title:`–û–±—ä–µ–∫—Ç –≤ ${d}`,district:d,quarter:q,price:p,area:50,type:"flat",status:"sale",photos:phs,tg:tg};
    objects.push(o);
    applyFilter();
  }

  function demo(){
    if(objects.length) return;
    objects=[
      {id:"1",title:"5-–∫–æ–º–Ω, –Æ–Ω—É—Å–∞–±–∞–¥ 9",district:"–Æ–Ω—É—Å–∞–±–∞–¥",quarter:"9 –∫–≤–∞—Ä—Ç–∞–ª",price:120000,area:106,type:"flat",status:"sale",photos:["https://picsum.photos/seed/a1/600/400"],tg:"Smeksy"},
      {id:"2",title:"2-–∫–æ–º–Ω, –°–µ—Ä–≥–µ–ª–∏, –ö—É–π–ª—é–∫ 5",district:"–°–µ—Ä–≥–µ–ª–∏",quarter:"–ö—É–π–ª—é–∫ 5 –∫–≤–∞—Ä—Ç–∞–ª",price:600,area:65,type:"flat",status:"rent",photos:["https://picsum.photos/seed/b1/600/400"],tg:"Smeksy"},
      {id:"3",title:"–î–æ–º, –ß–∏–ª–∞–Ω–∑–∞—Ä 20 –∫–≤–∞—Ä—Ç–∞–ª",district:"–ß–∏–ª–∞–Ω–∑–∞—Ä",quarter:"20 –∫–≤–∞—Ä—Ç–∞–ª",price:95000,area:120,type:"house",status:"sale",photos:["https://picsum.photos/seed/c1/600/400"],tg:"Smeksy"}
    ];
    applyFilter();
  }

  $("btnApply").onclick=applyFilter;
  $("btnReset").onclick=()=>{document.querySelectorAll("#filtersCard input").forEach(i=>i.checked=false);$("f_type").value="";$("f_status").value="";$("f_price_from").value="";$("f_price_to").value="";$("f_area_from").value="";$("f_area_to").value="";applyFilter();};
  $("btnAdd").onclick=addObject;
  $("btnDemo").onclick=demo;
  $("f_districts").addEventListener("change",renderQuarters);

  renderDistricts();
  applyFilter();

  // üî• –ù–æ–≤—ã–π –±–ª–æ–∫: –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ #id=
  if (location.hash.startsWith("#id=")) {
    const id = decodeURIComponent(location.hash.slice(4));

    // –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ—Ç ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ
    if (!objects.length) {
      demo();
    }

    setTimeout(() => {
      const obj = objects.find(o => o.id === id);
      if (obj) {
        renderResults([obj]);
        const res = document.getElementById("obj-"+obj.id);
        if (res) res.scrollIntoView({behavior:"smooth"});
      }
    }, 500);
  }
});
</script>
</body>
</html>
