<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.5.4</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--bad:#dc2626;--border:#e5e7eb}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
h1{font-size:26px;margin:8px 0 4px}.sub{color:var(--muted);margin:0 0 14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 4px 18px rgba(0,0,0,.04)}
.row{display:flex;gap:10px;flex-wrap:wrap}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button,textarea{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;background:#fff;color:var(--text)}
.btn{cursor:pointer}.btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
.btn-ghost{background:#fff}.btn-danger{background:#fff;color:var(--bad);border-color:#fecaca}
.grid{display:grid;gap:10px}@media(min-width:1000px){.grid-2{grid-template-columns:1.05fr .95fr}}
.list{display:grid;gap:10px}.item{display:grid;gap:8px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
.hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.muted{color:var(--muted)} .section-title{font-weight:700;margin:8px 0}.empty{color:var(--muted);padding:10px}
.footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.price{font-weight:800}
.thumb{width:100%;max-width:300px;height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.link{color:#2563eb;text-decoration:none}.link:hover{text-decoration:underline}
.gallery{position:relative;display:inline-block}
.gallery .nav{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;user-select:none}
.gallery .prev{left:6px}.gallery .next{right:6px}
.counter{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px}
.small{font-size:12px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px}
.chip .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;background:#fff;padding:0 6px}
.map-sm{width:100%;height:230px;border:1px solid var(--border);border-radius:12px}
.map-md{width:100%;height:260px;border:1px solid var(--border);border-radius:12px}
.dim{opacity:.45;pointer-events:none}
.toggle{display:flex;gap:10px;align-items:center}
hr.sep{border:none;height:1px;background:var(--border);margin:12px 0}
.badge{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:6px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div>
      <h1>üè† –ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.5.4</h1>
      <div class="sub">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –º–µ—Ç—Ä–æ —Å —Ä–∞–¥–∏—É—Å–æ–º, –∫–∞—Ä—Ç–∞ —Ä–∞–π–æ–Ω–æ–≤/–º–µ—Ç—Ä–æ, –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –æ—Ç‚Äì–¥–æ, Telegram, —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç</div>
    </div>
    <div class="row">
      <button class="btn btn-ghost" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <label class="btn btn-ghost" style="cursor:pointer">–ò–º–ø–æ—Ä—Ç<input id="fileImport" type="file" accept="application/json" style="display:none"></label>
      <button class="btn btn-danger" id="btnWipe">–°–±—Ä–æ—Å</button>
    </div>
  </div>

  <div class="grid grid-2">
    <!-- –§–∏–ª—å—Ç—Ä -->
    <div class="card" id="filtersCard">
      <div class="section-title">–§–∏–ª—å—Ç—Ä</div>

      <div class="row">
        <div>
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="f_cat"></select>
        </div>
        <div>
          <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="f_subcat"></select>
        </div>
      </div>

      <div class="toggle" style="margin-top:6px">
        <label><input type="radio" name="mode" value="district" id="modeDistrict" checked> –ü–æ —Ä–∞–π–æ–Ω–∞–º/–ª–æ–∫–∞—Ü–∏—è–º</label>
        <label><input type="radio" name="mode" value="radius" id="modeRadius"> –ü–æ —Ä–∞–¥–∏—É—Å—É –Ω–∞ –∫–∞—Ä—Ç–µ</label>
      </div>

      <div id="panelDistrict">
        <div class="section-title" style="margin-top:10px">–†–∞–π–æ–Ω—ã</div>
        <div class="row" id="f_districts"></div>

        <div class="section-title" style="margin:10px 0 4px">–ö–≤–∞—Ä—Ç–∞–ª—ã/–º–∞—Ö–∞–ª–ª–∏</div>
        <div class="small">–û—Ç–º–µ—Ç—å —Ä–∞–π–æ–Ω—ã ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∏—Ö –ª–æ–∫–∞—Ü–∏–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</div>
        <div class="row" id="f_quarters_box" style="gap:8px"></div>

        <div class="section-title" style="margin:10px 0 6px">–ö–∞—Ä—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤ –∏ –º–µ—Ç—Ä–æ</div>
        <div id="f_map_ctx" class="map-sm"></div>
      </div>

      <div id="panelRadius" class="dim">
        <div class="section-title" style="margin-top:10px">–ü–æ–∏—Å–∫ –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏</div>
        <div class="row">
          <div><label>–†–∞–¥–∏—É—Å, –∫–º</label><input type="number" min="0.1" step="0.1" id="f_r_km" value="2"></div>
          <div>
            <label>–¶–µ–Ω—Ç—Ä –∏–∑ —Ä–∞–π–æ–Ω–∞</label>
            <select id="f_center_district"></select>
          </div>
          <button class="btn btn-ghost" id="f_use_center">–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
          <button class="btn btn-ghost" id="f_clear_center">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="f_map" class="map-sm" style="margin-top:6px"></div>
        <div class="small">–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É. –í —Ä–∞–¥–∏—É—Å –ø–æ–ø–∞–¥—É—Ç —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.</div>
      </div>

      <hr class="sep">

      <div class="section-title">–ú–µ—Ç—Ä–æ</div>
      <div class="row" id="f_metro_box"></div>
      <div class="row">
        <div><label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –º–µ—Ç—Ä–æ (–º)</label><input id="f_metro_radius" type="number" min="0" placeholder="–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000"></div>
      </div>
      <div class="small">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Ä–∞–¥–∏—É—Å–µ –æ—Ç –Ω–∏—Ö (–∏–ª–∏ 1000 –º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é). –¢–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã, –≥–¥–µ –≤—Ä—É—á–Ω—É—é —É–∫–∞–∑–∞–Ω–∞ —Å—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ.</div>

      <hr class="sep">

      <div class="row">
        <div><label>–¶–µ–Ω–∞ –æ—Ç (USD)</label><input id="f_price_from" type="number" min="0"></div>
        <div><label>–¥–æ</label><input id="f_price_to" type="number" min="0"></div>
      </div>
      <div class="row">
        <div><label>–ü–ª–æ—â–∞–¥—å –æ—Ç (–º¬≤)</label><input id="f_area_from" type="number" min="0"></div>
        <div><label>–¥–æ</label><input id="f_area_to" type="number" min="0"></div>
      </div>
      <div class="row">
        <div><label>–ö–æ–º–Ω–∞—Ç –æ—Ç</label><input id="f_rooms_from" type="number" min="0"></div>
        <div><label>–¥–æ</label><input id="f_rooms_to" type="number" min="0"></div>
      </div>
      <div class="row">
        <div><label>–≠—Ç–∞–∂ –æ—Ç</label><input id="f_floor_from" type="number" min="0"></div>
        <div><label>–¥–æ</label><input id="f_floor_to" type="number" min="0"></div>
      </div>
      <div class="row">
        <div><label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –æ—Ç</label><input id="f_floors_from" type="number" min="0"></div>
        <div><label>–¥–æ</label><input id="f_floors_to" type="number" min="0"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="btnApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnResetFilters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      </div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ -->
    <div class="card">
      <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</div>
      <div class="row">
        <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="a_cat"></select></div>
        <div><label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="a_subcat"></select></div>
        <div><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="a_status"><option value="sale">–ü—Ä–æ–¥–∞—ë—Ç—Å—è</option><option value="rent">–ê—Ä–µ–Ω–¥–∞</option></select>
        </div>
        <div style="flex:1"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="a_title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4-–∫–æ–º–Ω, –Æ–Ω—É—Å–∞–±–∞–¥ 9, —Ä–µ–º–æ–Ω—Ç"></div>
      </div>

      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="a_district"></select></div>
        <div><label>–ö–≤–∞—Ä—Ç–∞–ª/–º–∞—Ö–∞–ª—è</label><select id="a_quarter"></select></div>
      </div>

      <div class="row">
        <div><label>–¶–µ–Ω–∞ (USD)</label><input id="a_price" type="number" min="0"></div>
        <div><label>–ü–ª–æ—â–∞–¥—å (–º¬≤)</label><input id="a_area" type="number" min="0"></div>
        <div><label>–ö–æ–º–Ω–∞—Ç</label><input id="a_rooms" type="number" min="0"></div>
      </div>

      <div class="row">
        <div><label>–≠—Ç–∞–∂</label><input id="a_floor" type="number" min="0"></div>
        <div><label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</label><input id="a_floors" type="number" min="0"></div>
      </div>

      <div class="section-title">–õ–æ–∫–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞</div>
      <div id="a_map" class="map-md"></div>
      <div class="row">
        <div><label>–®–∏—Ä–æ—Ç–∞</label><input id="a_lat" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
        <div><label>–î–æ–ª–≥–æ—Ç–∞</label><input id="a_lng" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
      </div>

      <div class="row">
        <div style="flex:1"><label>–§–æ—Ç–æ (URL, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input id="a_photos" placeholder="https://.../1.jpg, https://.../2.jpg"></div>
      </div>

      <div class="row">
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="a_phone" placeholder="+998..."></div>
        <div><label>Telegram username</label><input id="a_tg" placeholder="–±–µ–∑ @, –Ω–∞–ø—Ä–∏–º–µ—Ä: Smeksy"></div>
      </div>

      <div class="row">
        <div style="flex:1"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="a_desc" rows="3" placeholder="–ö–ª—é—á–µ–≤—ã–µ –ø–ª—é—Å—ã, —á—Ç–æ —Ä—è–¥–æ–º"></textarea></div>
      </div>

      <div class="row">
        <div><label>–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ (—Ä—É—á–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞)</label><select id="a_metro"></select></div>
      </div>

      <div class="row">
        <button class="btn btn-primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn btn-ghost" id="btnDemo">–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn btn-danger" id="btnClearObjects">–û—á–∏—Å—Ç–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã</button>
      </div>

      <hr class="sep">

      <div class="section-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–∞–π–æ–Ω–æ–≤</div>
      <div class="row">
        <div style="flex:1"><label>–ù–æ–≤—ã–π —Ä–∞–π–æ–Ω</label><input id="dist_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∏–±—Ä–∞–π"></div>
        <button class="btn btn-primary" id="dist_add">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–π–æ–Ω</button>
      </div>
      <div class="small" style="margin-top:6px">–°–ø–∏—Å–æ–∫ —Ä–∞–π–æ–Ω–æ–≤ (–∫–ª–∏–∫ –ø–æ ‚úï ‚Äî —É–¥–∞–ª–∏—Ç—å; –ª–æ–∫–∞—Ü–∏–∏ —Ä–∞–π–æ–Ω–∞ —É–¥–∞–ª—è—Ç—Å—è —Ç–æ–∂–µ)</div>
      <div id="dist_list" class="chips" style="margin-top:6px"></div>

      <div class="section-title" style="margin-top:14px">–¶–µ–Ω—Ç—Ä —Ä–∞–π–æ–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="dist_center_select"></select></div>
        <button class="btn btn-ghost" id="dist_center_clear">–û—á–∏—Å—Ç–∏—Ç—å —Ü–µ–Ω—Ç—Ä</button>
      </div>
      <div id="dist_map" class="map-sm" style="margin-top:6px"></div>
      <div class="row">
        <div><label>–®–∏—Ä–æ—Ç–∞</label><input id="dist_lat" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
        <div><label>–î–æ–ª–≥–æ—Ç–∞</label><input id="dist_lng" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
        <button class="btn btn-primary" id="dist_save_center">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—Ç—Ä</button>
      </div>

      <hr class="sep">

      <div class="section-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞)</div>
      <div class="row">
        <div><label>–†–∞–π–æ–Ω</label><select id="loc_district"></select></div>
        <div style="flex:1"><label>–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è</label><input id="loc_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 9 –∫–≤–∞—Ä—Ç–∞–ª –∏–ª–∏ –°5"></div>
        <button class="btn btn-primary" id="loc_add">–î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
      </div>
      <div id="loc_list" class="chips" style="margin-top:8px"></div>

      <hr class="sep">

      <div class="section-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
      <div class="row">
        <div style="flex:1"><label>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label><input id="cat_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–º–º–µ—Ä—Ü–∏—è"></div>
        <button class="btn btn-primary" id="cat_add">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
      </div>
      <div id="cat_list" class="chips" style="margin-top:8px"></div>

      <div class="row" style="margin-top:10px">
        <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label><select id="subcat_for"></select></div>
        <div style="flex:1"><label>–ù–æ–≤–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label><input id="subcat_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–≥–∞–∑–∏–Ω"></div>
        <button class="btn btn-primary" id="subcat_add">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
      </div>
      <div id="subcat_list" class="chips" style="margin-top:8px"></div>

      <hr class="sep">

      <div class="section-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–µ—Ç—Ä–æ</div>
      <div class="row">
        <div style="flex:1"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏</label><input id="metro_new" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–Ω–æ—Ä"></div>
        <button class="btn btn-primary" id="metro_add">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏—é</button>
      </div>
      <div class="small" style="margin-top:6px">–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ç–∞–Ω—Ü–∏–∏.</div>
      <div id="metro_map" class="map-sm" style="margin-top:6px"></div>
      <div class="row">
        <div><label>–®–∏—Ä–æ—Ç–∞</label><input id="metro_lat" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
        <div><label>–î–æ–ª–≥–æ—Ç–∞</label><input id="metro_lng" type="number" step="0.000001" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É"></div>
      </div>
      <div id="metro_list" class="chips" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div class="card">
    <div class="hdr">
      <div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div class="muted">–ù–∞–π–¥–µ–Ω–æ: <span id="count">0</span></div>
    </div>
    <div id="results" class="list"></div>
    <div id="empty" class="empty" style="display:none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
(function(){
  // ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ =====
  const LS_OBJECTS="realty_objects_v10";
  const LS_DISTRICTS="realty_districts_v4"; // —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ {name, lat, lng}
  const LS_LOCATIONS="realty_locations_v2";
  const LS_CATEGORIES="realty_categories_v1"; // [{name, subcats:[]}]
  const LS_METRO="realty_metro_v1"; // [{name, lat, lng}]

  // ===== –î–∞–Ω–Ω—ã–µ =====
  let objects=[];
  let districts=[];
  let locations={};
  let categories=[];
  let metro=[];

  const DEFAULT_DISTRICTS=[
    "–Æ–Ω—É—Å–∞–±–∞–¥","–ú–∏—Ä–∑–æ-–£–ª—É–≥–±–µ–∫","–ß–∏–ª–∞–Ω–∑–∞—Ä","–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä","–Ø–∫–∫–∞—Å–∞—Ä–∞–π","–£—á—Ç–µ–ø–∞",
    "–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π","–ê–ª–º–∞–∑–∞—Ä","–ë–µ–∫—Ç–µ–º–∏—Ä","–ú–∏—Ä–∞–±–∞–¥","–Ø—à–Ω–∞–±–∞–¥",
    "–ö–∏–±—Ä–∞–π","–ó–∞–Ω–≥–∏–∞—Ç–∞","–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∏–π","–ß–∏–Ω–∞–∑"
  ];
  const DEFAULT_CATEGORIES=[
    {name:"–ö–≤–∞—Ä—Ç–∏—Ä–∞", subcats:["–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞","–í—Ç–æ—Ä–∏—á–∫–∞"]},
    {name:"–î–æ–º", subcats:["–û—Ç–¥–µ–ª—å–Ω—ã–π","–¢–∞—É–Ω—Ö–∞—É—Å"]},
    {name:"–ó–µ–º–ª—è", subcats:["–ò–ñ–°","–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è"]},
    {name:"–ö–æ–º–º–µ—Ä—Ü–∏—è", subcats:["–ú–∞–≥–∞–∑–∏–Ω","–°–∞–ª–æ–Ω","–†–µ—Å—Ç–æ—Ä–∞–Ω"]},
    {name:"–ì–∞—Ä–∞–∂", subcats:[]}
  ];
  const DEFAULT_METRO=[
    {name:"–ú–∏–Ω–æ—Ä", lat:41.3206, lng:69.2447},
    {name:"–ê–º–∏—Ä –¢–µ–º—É—Ä —Ö–∏—ë–±–æ–Ω–∏", lat:41.3114, lng:69.2797},
    {name:"–•–∞–º–∏–¥ –ê–ª–∏–º–¥–∂–∞–Ω", lat:41.3343, lng:69.3089}
  ];

  // ===== –ö–∞—Ä—Ç—ã =====
  let aMap, aMarker=null;
  let fMap, fMarker=null, fCircle=null;
  let dMap, dMarker=null;
  let mMap, mMarker=null;
  let fCtxMap, fCtxLayerGroup=null;

  // ===== –£—Ç–∏–ª–∏—Ç—ã =====
  const $=id=>document.getElementById(id);
  const el=(t,a={},h="")=>{const e=document.createElement(t);for(const k in a){k==="class"?e.className=a[k]:e.setAttribute(k,a[k])} if(h) e.innerHTML=h; return e};
  const esc=s=>(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
  const fmtUSD=n=> new Intl.NumberFormat('ru-RU',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
  const n=v=>{const x=parseFloat(v); return isNaN(x)?NaN:x};
  const isObj=d=> typeof d==="object" && d;
  const dName=d=> isObj(d)&&"name" in d? d.name : d;
  const dCenter=name=>{
    const d=districts.find(x=> isObj(x)&&"name" in x? x.name===name : x===name);
    if(isObj(d)&&typeof d.lat==="number"&&typeof d.lng==="number") return {lat:d.lat,lng:d.lng};
    return null;
  };
  const setDCenter=(name,lat,lng)=>{
    const i=districts.findIndex(x=> isObj(x)&&"name" in x? x.name===name : x===name);
    if(i<0) return;
    if(isObj(districts[i])){ districts[i].lat=lat; districts[i].lng=lng; }
    else { districts[i]={name:districts[i], lat, lng}; }
  };
  const haversineKm=(lat1,lon1,lat2,lon2)=>{
    const R=6371, toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  };

  // ===== –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ =====
  function saveAll(){
    localStorage.setItem(LS_OBJECTS, JSON.stringify(objects));
    localStorage.setItem(LS_DISTRICTS, JSON.stringify(districts));
    localStorage.setItem(LS_LOCATIONS, JSON.stringify(locations));
    localStorage.setItem(LS_CATEGORIES, JSON.stringify(categories));
    localStorage.setItem(LS_METRO, JSON.stringify(metro));
  }
  function loadAll(){
    try{objects=JSON.parse(localStorage.getItem(LS_OBJECTS)||"[]")}catch(_){objects=[]}
    try{districts=JSON.parse(localStorage.getItem(LS_DISTRICTS)||"[]")}catch(_){districts=[]}
    if(!Array.isArray(districts)||districts.length===0){ districts=[...DEFAULT_DISTRICTS]; }
    try{locations=JSON.parse(localStorage.getItem(LS_LOCATIONS)||"{}")}catch(_){locations={}}
    if(Object.keys(locations).length===0){
      locations={
        "–Æ–Ω—É—Å–∞–±–∞–¥": Array.from({length:19},(_,i)=>(i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
        "–ß–∏–ª–∞–Ω–∑–∞—Ä": Array.from({length:30},(_,i)=>(i+1)+" –∫–≤–∞—Ä—Ç–∞–ª"),
        "–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π": ["–ö—É–π–ª—é–∫ 1 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 2 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 3 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 4 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 5 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 6 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 7 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 8 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 9 –∫–≤–∞—Ä—Ç–∞–ª","–ö—É–π–ª—é–∫ 10 –∫–≤–∞—Ä—Ç–∞–ª"],
      };
    }
    try{categories=JSON.parse(localStorage.getItem(LS_CATEGORIES)||"[]")}catch(_){categories=[]}
    if(!Array.isArray(categories)||categories.length===0){ categories=JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); }
    try{metro=JSON.parse(localStorage.getItem(LS_METRO)||"[]")}catch(_){metro=[]}
    if(!Array.isArray(metro)||metro.length===0){ metro=JSON.parse(JSON.stringify(DEFAULT_METRO)); }
  }

  // ===== –†–µ–Ω–¥–µ—Ä —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –≤ UI =====
  const districtNames=()=>districts.map(d=>dName(d));

  function renderDistrictsUI(){
    const names=districtNames();

    // —Ñ–∏–ª—å—Ç—Ä: —á–µ–∫–±–æ–∫—Å—ã —Ä–∞–π–æ–Ω–æ–≤
    const fbox=$("f_districts"); fbox.innerHTML="";
    names.forEach(d=>{
      const l=el("label"); const cb=el("input",{type:"checkbox","data-district":d});
      l.appendChild(cb); l.appendChild(document.createTextNode(" "+d));
      fbox.appendChild(l);
    });
    fbox.addEventListener("change",()=>{ renderQuarterCheckboxes(); redrawCtxMap(); });

    // —Ñ–∏–ª—å—Ç—Ä: —Ü–µ–Ω—Ç—Ä –∏–∑ —Ä–∞–π–æ–Ω–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∞–¥–∏—É—Å–∞)
    const fsel=$("f_center_district"); fsel.innerHTML="";
    fsel.appendChild(el("option",{value:""},"‚Äî"));
    names.forEach(d=> fsel.appendChild(el("option",{value:d},d)));

    // –∞–¥–º–∏–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ‚Äî select —Ä–∞–π–æ–Ω–æ–≤
    const selA=$("a_district"); selA.innerHTML="";
    names.forEach(d=> selA.appendChild(el("option",{value:d},d)));
    selA.addEventListener("change",renderQuarterSelect);

    // –∞–¥–º–∏–Ω: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π ‚Äî select —Ä–∞–π–æ–Ω–æ–≤
    const selLoc=$("loc_district"); selLoc.innerHTML="";
    names.forEach(d=> selLoc.appendChild(el("option",{value:d},d)));
    selLoc.addEventListener("change",renderLocList);

    // –∞–¥–º–∏–Ω: –≤—ã–±–æ—Ä —Ä–∞–π–æ–Ω–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞
    const dsel=$("dist_center_select"); dsel.innerHTML="";
    names.forEach(d=> dsel.appendChild(el("option",{value:d},d)));
    dsel.addEventListener("change",syncDistrictCenterToMap);

    renderQuarterCheckboxes();
    renderQuarterSelect();
    renderLocList();
    renderDistrictChips();
    syncDistrictCenterToMap();
  }

  function renderDistrictChips(){
    const box=$("dist_list"); box.innerHTML="";
    districtNames().forEach((name,idx)=>{
      const chip=el("div",{class:"chip"},esc(name)+" ");
      const x=el("button",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω ¬´${name}¬ª –∏ –≤—Å–µ –µ–≥–æ –ª–æ–∫–∞—Ü–∏–∏?`)) return;
        districts.splice(idx,1);
        delete locations[name];
        objects=objects.filter(o=>o.district!==name);
        saveAll();
        renderDistrictsUI(); apply();
      });
      chip.appendChild(x); box.appendChild(chip);
    });
  }

  function renderQuarterCheckboxes(){
    const chosen=Array.from($("f_districts").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-district"));
    const box=$("f_quarters_box"); box.innerHTML="";
    chosen.forEach(d=>{
      (locations[d]||[]).forEach(q=>{
        const l=el("label"); const cb=el("input",{type:"checkbox","data-quarter":q});
        l.appendChild(cb); l.appendChild(document.createTextNode(" "+q));
        box.appendChild(l);
      });
    });
  }

  function renderQuarterSelect(){
    const d=$("a_district").value; const sel=$("a_quarter"); sel.innerHTML="";
    (locations[d]||[]).forEach(q=> sel.appendChild(el("option",{value:q},q)) );
  }

  function renderLocList(){
    const d=$("loc_district").value; const box=$("loc_list"); box.innerHTML="";
    (locations[d]||[]).forEach((q,i)=>{
      const chip=el("div",{class:"chip"},q+" ");
      const x=el("button",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{ locations[d].splice(i,1); saveAll(); renderLocList(); renderQuarterSelect(); renderQuarterCheckboxes(); });
      chip.appendChild(x); box.appendChild(chip);
    });
  }

  // ===== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ / –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ =====
  function renderCategoriesUI(){
    // —Ñ–∏–ª—å—Ç—Ä
    const fcat=$("f_cat"), fsub=$("f_subcat");
    fcat.innerHTML=""; fsub.innerHTML="";
    fcat.appendChild(el("option",{value:""},"‚Äî"));
    categories.forEach(c=> fcat.appendChild(el("option",{value:c.name},c.name)));
    fcat.addEventListener("change",()=>{
      const name=fcat.value;
      renderSubcatSelect(fsub, name, true);
    });
    renderSubcatSelect(fsub, fcat.value, true);

    // –∞–¥–º–∏–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
    const acat=$("a_cat"), asub=$("a_subcat");
    acat.innerHTML=""; categories.forEach(c=> acat.appendChild(el("option",{value:c.name},c.name)));
    acat.addEventListener("change",()=> renderSubcatSelect(asub, acat.value, false));
    renderSubcatSelect(asub, acat.value, false);

    // —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫: —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const clist=$("cat_list"); clist.innerHTML="";
    categories.forEach((c,idx)=>{
      const chip=el("div",{class:"chip"},esc(c.name)+" "+(c.subcats?.length?`<span class="badge">${c.subcats.length}</span>`:""));
      const x=el("button",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´${c.name}¬ª —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏?`)) return;
        // —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
        categories.splice(idx,1);
        objects=objects.filter(o=>o.category!==c.name);
        saveAll(); renderCategoriesUI(); apply();
      });
      chip.appendChild(x); clist.appendChild(chip);
    });

    // —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const subFor=$("subcat_for"); subFor.innerHTML="";
    categories.forEach(c=> subFor.appendChild(el("option",{value:c.name},c.name)));
    subFor.addEventListener("change",renderSubcatList);
    renderSubcatList();
  }

  function renderSubcatSelect(selectEl, catName, addEmpty){
    selectEl.innerHTML="";
    if(addEmpty) selectEl.appendChild(el("option",{value:""},"‚Äî"));
    const cat=categories.find(c=>c.name===catName);
    (cat?.subcats||[]).forEach(s=> selectEl.appendChild(el("option",{value:s},s)) );
  }

  function renderSubcatList(){
    const name=$("subcat_for").value;
    const cat=categories.find(c=>c.name===name);
    const box=$("subcat_list"); box.innerHTML="";
    (cat?.subcats||[]).forEach((s,i)=>{
      const chip=el("div",{class:"chip"},s+" ");
      const x=el("button",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{
        cat.subcats.splice(i,1); saveAll(); renderSubcatList(); renderCategoriesUI();
      });
      chip.appendChild(x); box.appendChild(chip);
    });
  }

  // ===== –ú–µ—Ç—Ä–æ =====
  function renderMetroUI(){
    // —Ñ–∏–ª—å—Ç—Ä: —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π
    const fbox=$("f_metro_box"); fbox.innerHTML="";
    metro.forEach(m=>{
      const l=el("label"); const cb=el("input",{type:"checkbox","data-metro":m.name});
      l.appendChild(cb); l.appendChild(document.createTextNode(" "+m.name));
      cb.addEventListener("change",redrawCtxMap);
      fbox.appendChild(l);
    });

    // –∞–¥–º–∏–Ω: –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –æ–±—ä–µ–∫—Ç—É
    const aSel=$("a_metro"); aSel.innerHTML=""; aSel.appendChild(el("option",{value:""},"‚Äî"));
    metro.forEach(m=> aSel.appendChild(el("option",{value:m.name},m.name)));

    // –∞–¥–º–∏–Ω: —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π + x
    const list=$("metro_list"); list.innerHTML="";
    metro.forEach((m,i)=>{
      const chip=el("div",{class:"chip"}, esc(m.name)+" ");
      const x=el("button",{class:"x"},"‚úï");
      x.addEventListener("click",()=>{
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏—é –º–µ—Ç—Ä–æ ¬´${m.name}¬ª?`)) return;
        metro.splice(i,1);
        // —É–±—Ä–∞—Ç—å —Ä—É—á–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É —É –æ–±—ä–µ–∫—Ç–æ–≤
        objects.forEach(o=>{ if(o.metro===m.name) o.metro=""; });
        saveAll(); renderMetroUI(); apply(); redrawCtxMap();
      });
      chip.appendChild(x); list.appendChild(chip);
    });
  }

  // ===== –§–∏–ª—å—Ç—Ä/–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ =====
  function getChosenDistricts(){ return Array.from($("f_districts").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-district")); }
  function getChosenQuarters(){ return Array.from($("f_quarters_box").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-quarter")); }
  function getChosenMetros(){ return Array.from($("f_metro_box").querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.getAttribute("data-metro")); }

  function apply(){
    const mode=$("modeRadius").checked?"radius":"district";
    const cat=$("f_cat").value; const sub=$("f_subcat").value;
    const price_from=n($("f_price_from").value), price_to=n($("f_price_to").value);
    const area_from=n($("f_area_from").value),  area_to=n($("f_area_to").value);
    const rooms_from=parseInt($("f_rooms_from").value), rooms_to=parseInt($("f_rooms_to").value);
    const floor_from=parseInt($("f_floor_from").value), floor_to=parseInt($("f_floor_to").value);
    const floors_from=parseInt($("f_floors_from").value), floors_to=parseInt($("f_floors_to").value);

    const metros=getChosenMetros();
    const metroRadiusMeters = $("f_metro_radius").value? parseFloat($("f_metro_radius").value) : 1000; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000 –º
    const metroRadiusKm = (isNaN(metroRadiusMeters)?1000:metroRadiusMeters)/1000;

    let list = objects.filter(o=>{
      if(cat && o.category!==cat) return false;
      if(sub && o.subcategory!==sub) return false;

      if(!isNaN(price_from)&&o.price<price_from) return false;
      if(!isNaN(price_to)  &&o.price>price_to)   return false;
      if(!isNaN(area_from) &&o.area<area_from)   return false;
      if(!isNaN(area_to)   &&o.area>area_to)     return false;

      if(o.category==="–ö–≤–∞—Ä—Ç–∏—Ä–∞"){
        if(!isNaN(rooms_from)&&o.rooms<rooms_from) return false;
        if(!isNaN(rooms_to)  &&o.rooms>rooms_to)   return false;
        if(!isNaN(floor_from)&&o.floor<floor_from) return false;
        if(!isNaN(floor_to)  &&o.floor>floor_to)   return false;
        if(!isNaN(floors_from)&&o.floors<floors_from) return false;
        if(!isNaN(floors_to)  &&o.floors>floors_to)   return false;
      }
      return true;
    });

    // —Ñ–∏–ª—å—Ç—Ä –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    if(mode==="district"){
      const chosenD=getChosenDistricts();
      const chosenQ=getChosenQuarters();
      list=list.filter(o=>{
        if(chosenD.length && !chosenD.includes(o.district)) return false;
        if(chosenQ.length){
          const oq=(o.quarter||"").toLowerCase();
          let ok=false; for(const q of chosenQ){ if(oq.includes(q.toLowerCase())) { ok=true; break; } }
          if(!ok) return false;
        }
        return true;
      });

      // –º–µ—Ç—Ä–æ —Ñ–∏–ª—å—Ç—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ district-—Ä–µ–∂–∏–º–µ)
      if(metros.length){
        list=list.filter(o=>{
          // 1) –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
          let near=false;
          if(typeof o.lat==="number" && typeof o.lng==="number"){
            for(const name of metros){
              const st=metro.find(m=>m.name===name);
              if(st && typeof st.lat==="number"){
                const d=haversineKm(o.lat,o.lng,st.lat,st.lng);
                if(d<=metroRadiusKm){ near=true; break; }
              }
            }
          }
          // 2) –ø–æ —Ä—É—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–µ (–µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–ª–∏ –Ω–∞ –≥—Ä–∞–Ω–∏)
          const tagged = o.metro && metros.includes(o.metro);
          return near || tagged;
        });
      }
    } else {
      // —Ä–µ–∂–∏–º —Ä–∞–¥–∏—É—Å–∞ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
      const rkm=parseFloat($("f_r_km").value)||0;
      if(!(fMarker && rkm>0)){ list=[]; }
      else{
        const c=fMarker.getLatLng();
        list=list.filter(o=>{
          if(typeof o.lat!=="number"||typeof o.lng!=="number") return false;
          const d=haversineKm(c.lat,c.lng,o.lat,o.lng);
          return d<=rkm;
        });
      }
    }

    renderResults(list);
  }

  function resetFilters(){
    ["f_price_from","f_price_to","f_area_from","f_area_to","f_rooms_from","f_rooms_to","f_floor_from","f_floor_to","f_floors_from","f_floors_to","f_metro_radius"].forEach(id=>{$(id).value=""});
    $("modeDistrict").checked=true; toggleMode();
    $("f_districts").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
    $("f_quarters_box").innerHTML="";
    $("f_metro_box").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
    $("f_cat").value=""; $("f_subcat").innerHTML="<option value=''>‚Äî</option>";
    if(fMarker){ fMap.removeLayer(fMarker); fMarker=null; }
    if(fCircle){ fMap.removeLayer(fCircle); fCircle=null; }
    $("f_center_district").value="";
    $("f_r_km").value="2";
    redrawCtxMap();
    renderResults(objects);
  }

  function toggleMode(){
    const isRadius=$("modeRadius").checked;
    $("panelRadius").classList.toggle("dim",!isRadius);
    $("panelDistrict").classList.toggle("dim",isRadius);
  }

  // ===== –†–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ =====
  function galleryNode(photos){
    photos=Array.isArray(photos)?photos:[];
    if(!photos.length) return null;
    let idx=0;
    const g=el("div",{class:"gallery"});
    const img=el("img",{class:"thumb",src:photos[0],alt:"photo"});
    const prev=el("div",{class:"nav prev"},"‚Äπ");
    const next=el("div",{class:"nav next"},"‚Ä∫");
    const counter=el("div",{class:"counter"},"–§–æ—Ç–æ 1/"+photos.length);
    const upd=()=>{img.src=photos[idx];counter.textContent="–§–æ—Ç–æ "+(idx+1)+"/"+photos.length;};
    prev.addEventListener("click",()=>{idx=(idx-1+photos.length)%photos.length;upd();});
    next.addEventListener("click",()=>{idx=(idx+1)%photos.length;upd();});
    g.appendChild(img); if(photos.length>1){ g.appendChild(prev); g.appendChild(next); g.appendChild(counter); }
    return g;
  }

  function renderResults(list){
    const res=$("results"), empty=$("empty");
    res.innerHTML=""; $("count").textContent=String(list.length);
    empty.style.display=list.length?"none":"block";
    list.forEach(o=>{
      const it=el("div",{class:"item",id:"obj-"+o.id});
      const head=el("div",{class:"hdr"}, `<b>${esc(o.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</b><span class="pill">${esc(o.category||"‚Äî")}${o.subcategory?(" ¬∑ "+esc(o.subcategory)):""} ¬∑ ${o.status==="rent"?"–ê—Ä–µ–Ω–¥–∞":"–ü—Ä–æ–¥–∞–∂–∞"}</span>`);
      const meta=el("div",{class:"muted"},
        `${esc(o.district)}${o.quarter?(", "+esc(o.quarter)):""} ‚Ä¢ ${o.area?o.area+" –º¬≤":"‚Äî"} ‚Ä¢ <span class="price">${(o.price||o.price===0)?fmtUSD(o.price):"–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</span>${o.rooms? " ‚Ä¢ "+o.rooms+" –∫–æ–º–Ω":""}${o.metro?` ‚Ä¢ –º–µ—Ç—Ä–æ: ${esc(o.metro)}`:""}`);
      const gal=galleryNode(o.photos);
      const actions=el("div",{class:"footer"});
      const copy=el("button",{class:"btn btn-ghost"},"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É");
      copy.addEventListener("click",async()=>{ try{ await navigator.clipboard.writeText(location.origin+location.pathname+"#id="+encodeURIComponent(o.id)); copy.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"; setTimeout(()=>copy.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É",900);}catch(_){alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");}});
      const del=el("button",{class:"btn btn-danger"},"–£–¥–∞–ª–∏—Ç—å");
      del.addEventListener("click",()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?")){ objects=objects.filter(x=>x.id!==o.id); saveAll(); apply(); }});
      const link=el("a",{href:location.origin+location.pathname+"#id="+encodeURIComponent(o.id),class:"link"},"–°—Å—ã–ª–∫–∞");
      actions.appendChild(link); actions.appendChild(copy); actions.appendChild(del);
      if(o.tg){
        const txt=encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ${location.origin+location.pathname+"#id="+encodeURIComponent(o.id)}`);
        const tg=`https://t.me/${encodeURIComponent(o.tg)}?text=${txt}`;
        actions.appendChild(el("a",{href:tg,target:"_blank",rel:"noopener",class:"link"},"–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram"));
      }

      const mapBtn=el("button",{class:"btn btn-ghost"},"–ö–∞—Ä—Ç–∞");
      const mapHolder=el("div",{style:"margin-top:6px"});
      let miniMap=null;
      mapBtn.addEventListener("click",()=>{
        if(!o.lat || !o.lng){ alert("–£ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç"); return; }
        if(!miniMap){
          const mapDiv=el("div",{class:"map-sm"});
          mapHolder.appendChild(mapDiv);
          setTimeout(()=>{
            miniMap=L.map(mapDiv).setView([o.lat,o.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(miniMap);
            L.marker([o.lat,o.lng]).addTo(miniMap);
          },30);
        } else {
          mapHolder.innerHTML=""; miniMap=null;
        }
      });
      actions.appendChild(mapBtn);

      it.appendChild(head);
      if(gal) it.appendChild(gal);
      it.appendChild(meta);
      it.appendChild(actions);
      it.appendChild(mapHolder);
      res.appendChild(it);
    });

    if(location.hash.startsWith("#id=")){
      const id=decodeURIComponent(location.hash.slice(4));
      const elCard=document.getElementById("obj-"+id);
      if(elCard) elCard.scrollIntoView({behavior:"smooth",block:"start"});
    }
  }

  // ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ =====
  function addObject(){
    const urlsRaw=$("a_photos").value.trim();
    const photos=urlsRaw?urlsRaw.split(",").map(s=>s.trim()).filter(Boolean):[];
    const lat=n($("a_lat").value), lng=n($("a_lng").value);
    const o={
      id:String(Date.now()),
      created:Date.now(),
      category:$("a_cat").value, subcategory:$("a_subcat").value, status:$("a_status").value,
      title:$("a_title").value.trim(),
      district:$("a_district").value, quarter:$("a_quarter").value,
      price:parseFloat($("a_price").value)||0, area:parseFloat($("a_area").value)||0,
      rooms:parseInt($("a_rooms").value)||0, floor:parseInt($("a_floor").value)||0, floors:parseInt($("a_floors").value)||0,
      photos, phone:$("a_phone").value.trim(), tg:$("a_tg").value.trim(),
      desc:$("a_desc").value.trim(),
      metro:$("a_metro").value||"",
      lat:isNaN(lat)?null:lat, lng:isNaN(lng)?null:lng
    };
    objects.push(o); saveAll();
    ["a_title","a_price","a_area","a_rooms","a_floor","a_floors","a_photos","a_phone","a_tg","a_desc","a_lat","a_lng"].forEach(id=>{$(id).value=""});
    apply();
  }
  function clearObjects(){ if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã?")){ objects=[]; saveAll(); apply(); } }

  // ===== –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç =====
  function exportJSON(){
    const payload={ objects, districts, locations, categories, metro };
    const data=JSON.stringify(payload,null,2);
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([data],{type:"application/json"})); a.download="realty_backup.json"; a.click();
  }
  function importJSON(file){
    const r=new FileReader();
    r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        if(obj && typeof obj==="object"){
          objects=Array.isArray(obj.objects)?obj.objects:[];
          districts=Array.isArray(obj.districts)&&obj.districts.length?obj.districts:[...DEFAULT_DISTRICTS];
          locations=(obj.locations && typeof obj.locations==="object")?obj.locations:{};
          categories=Array.isArray(obj.categories)&&obj.categories.length?obj.categories:JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
          metro=Array.isArray(obj.metro)&&obj.metro.length?obj.metro:JSON.parse(JSON.stringify(DEFAULT_METRO));
          saveAll();
          renderAll(); apply();
          alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ");
        } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
      }catch(_){ alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ"); }
    };
    r.readAsText(file);
  }

  // ===== –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ =====
  function addDistrict(){
    const v=($("dist_new").value||"").trim();
    if(!v) return;
    if(districtNames().includes(v)) { alert("–¢–∞–∫–æ–π —Ä–∞–π–æ–Ω —É–∂–µ –µ—Å—Ç—å"); return; }
    districts.push(v);
    locations[v]=locations[v]||[];
    $("dist_new").value="";
    saveAll(); renderDistrictsUI(); redrawCtxMap();
  }
  function addLocation(){
    const d=$("loc_district").value;
    const v=($("loc_new").value||"").trim();
    if(!v) return;
    locations[d]=locations[d]||[];
    if(!locations[d].includes(v)) locations[d].push(v);
    $("loc_new").value="";
    saveAll(); renderLocList(); renderQuarterSelect(); renderQuarterCheckboxes();
  }

  function addCategory(){
    const v=($("cat_new").value||"").trim();
    if(!v) return;
    if(categories.some(c=>c.name===v)){ alert("–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å"); return; }
    categories.push({name:v, subcats:[]}); $("cat_new").value="";
    saveAll(); renderCategoriesUI(); apply();
  }
  function addSubcategory(){
    const name=$("subcat_for").value;
    const v=($("subcat_new").value||"").trim();
    if(!name||!v) return;
    const cat=categories.find(c=>c.name===name);
    if(!cat.subcats) cat.subcats=[];
    if(cat.subcats.includes(v)){ alert("–¢–∞–∫–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å"); return; }
    cat.subcats.push(v); $("subcat_new").value="";
    saveAll(); renderCategoriesUI(); apply();
  }

  function addMetro(){
    const name=($("metro_new").value||"").trim();
    const lat=n($("metro_lat").value), lng=n($("metro_lng").value);
    if(!name || isNaN(lat) || isNaN(lng)){ alert("–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏ –∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É –º–µ—Ç—Ä–æ"); return; }
    if(metro.some(m=>m.name===name)){ alert("–¢–∞–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è —É–∂–µ –µ—Å—Ç—å"); return; }
    metro.push({name,lat,lng}); $("metro_new").value=""; $("metro_lat").value=""; $("metro_lng").value="";
    if(mMarker){ mMap.removeLayer(mMarker); mMarker=null; }
    saveAll(); renderMetroUI(); apply(); redrawCtxMap();
  }

  // ===== –ö–∞—Ä—Ç—ã: —Ç–æ—á–∫–∏ –∏ –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∏ =====
  function syncDistrictCenterToMap(){
    const name=$("dist_center_select").value;
    if(!name) return;
    const c=dCenter(name);
    if(dMarker){ dMap.removeLayer(dMarker); dMarker=null; }
    if(c){
      dMarker=L.marker([c.lat,c.lng],{draggable:true}).addTo(dMap);
      dMarker.on('dragend',()=>{ const p=dMarker.getLatLng(); $("dist_lat").value=p.lat.toFixed(6); $("dist_lng").value=p.lng.toFixed(6); });
      dMap.setView([c.lat,c.lng], 13);
      $("dist_lat").value=c.lat.toFixed(6);
      $("dist_lng").value=c.lng.toFixed(6);
    } else {
      $("dist_lat").value=""; $("dist_lng").value="";
    }
  }

  function setRadiusPoint(lat,lng,fly){
    if(!fMarker){ fMarker=L.marker([lat,lng],{draggable:true}).addTo(fMap); fMarker.on('dragend',()=> drawRadius()); }
    fMarker.setLatLng([lat,lng]);
    if(fly) fMap.setView([lat,lng], 13);
    drawRadius();
  }
  function drawRadius(){
    const rkm=parseFloat($("f_r_km").value)||0;
    if(!fMarker) return;
    const p=fMarker.getLatLng();
    if(fCircle){ fMap.removeLayer(fCircle); fCircle=null; }
    if(rkm>0) fCircle=L.circle([p.lat,p.lng],{radius:rkm*1000,color:"#2563eb"}).addTo(fMap);
  }

  function redrawCtxMap(){
    if(!fCtxMap) return;
    if(fCtxLayerGroup){ fCtxLayerGroup.clearLayers(); }
    const layer=L.layerGroup(); // districts + metro

    // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã
    const chosenD=getChosenDistricts();
    chosenD.forEach(name=>{
      const c=dCenter(name);
      if(c){
        L.marker([c.lat,c.lng],{title:name}).addTo(layer).bindTooltip(name);
      }
    });

    // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–æ
    const metros=getChosenMetros();
    const rMeters = $("f_metro_radius").value? parseFloat($("f_metro_radius").value) : 1000;
    metros.forEach(name=>{
      const st=metro.find(m=>m.name===name);
      if(st){
        L.marker([st.lat,st.lng],{title:name,icon:L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(layer).bindTooltip("–ú–µ—Ç—Ä–æ: "+name);
        if(!isNaN(rMeters) && rMeters>0){
          L.circle([st.lat,st.lng],{radius:rMeters,color:"#16a34a"}).addTo(layer);
        }
      }
    });

    layer.addTo(fCtxMap);
    fCtxLayerGroup=layer;
  }

  // ===== –î–µ–º–æ =====
  function demo(){
    if(objects.length>0) return;
    // —Ü–µ–Ω—Ç—Ä—ã —Ä–∞–π–æ–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä)
    setDCenter("–Æ–Ω—É—Å–∞–±–∞–¥", 41.366, 69.286);
    setDCenter("–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π", 41.246, 69.214);
    setDCenter("–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä", 41.327, 69.230);

    objects=[
      {id:"1",created:Date.now()-400000,category:"–ö–≤–∞—Ä—Ç–∏—Ä–∞",subcategory:"–í—Ç–æ—Ä–∏—á–∫–∞",status:"sale",title:"5-–∫–æ–º–Ω, –Æ–Ω—É—Å–∞–±–∞–¥ 9, —Ä–µ–º–æ–Ω—Ç",district:"–Æ–Ω—É—Å–∞–±–∞–¥",quarter:"9 –∫–≤–∞—Ä—Ç–∞–ª",price:120000,area:106,rooms:5,floor:3,floors:4,
        photos:["https://picsum.photos/seed/a1/600/400","https://picsum.photos/seed/a2/600/400"],phone:"+998901234567",tg:"Smeksy",desc:"–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, 2 —Å–∞–Ω—É–∑–ª–∞, –ø–∞—Ä–∫–æ–≤–∫–∞", lat:41.367, lng:69.287, metro:"–ú–∏–Ω–æ—Ä"},
      {id:"2",created:Date.now()-300000,category:"–ö–≤–∞—Ä—Ç–∏—Ä–∞",subcategory:"–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞",status:"rent",title:"2-–∫–æ–º–Ω, –°–µ—Ä–≥–µ–ª–∏, –ö—É–π–ª—é–∫ 5",district:"–°–µ—Ä–≥–µ–ª–∏–π—Å–∫–∏–π",quarter:"–ö—É–π–ª—é–∫ 5 –∫–≤–∞—Ä—Ç–∞–ª",price:600,area:65,rooms:2,floor:5,floors:9,
        photos:["https://picsum.photos/seed/b1/600/400"],phone:"+998931112233",tg:"Smeksy",desc:"–°–≤–µ—Ç–ª–∞—è, —Ä—è–¥–æ–º —à–∫–æ–ª–∞ –∏ –º–µ—Ç—Ä–æ", lat:41.244, lng:69.212, metro:""},
      {id:"3",created:Date.now()-200000,category:"–ö–æ–º–º–µ—Ä—Ü–∏—è",subcategory:"–ú–∞–≥–∞–∑–∏–Ω",status:"sale",title:"–¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞, –ß–æ—Ä—Å—É",district:"–®–∞–π—Ö–∞–Ω—Ç–∞—Ö—É—Ä",quarter:"–ß–æ—Ä—Å—É",price:95000,area:45,rooms:1,
        photos:["https://picsum.photos/seed/c1/600/400"],phone:"",tg:"",desc:"–ü—Ä–æ—Ö–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ", lat:41.326, lng:69.230, metro:"–ê–º–∏—Ä –¢–µ–º—É—Ä —Ö–∏—ë–±–æ–Ω–∏"}
    ];
    saveAll();
  }

  // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
  function renderAll(){
    renderDistrictsUI();
    renderCategoriesUI();
    renderMetroUI();

    // —Ñ–∏–ª—å—Ç—Ä: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    $("f_cat").addEventListener("change",()=>apply());
    $("f_subcat").addEventListener("change",()=>apply());

    // –æ–±—â–∏–µ –∫–Ω–æ–ø–∫–∏
    $("btnApply").addEventListener("click",apply);
    $("btnResetFilters").addEventListener("click",resetFilters);
    $("btnAdd").addEventListener("click",addObject);
    $("btnClearObjects").addEventListener("click",clearObjects);
    $("btnDemo").addEventListener("click",()=>{ if(confirm("–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–º–æ?")){ demo(); apply(); }});
    $("btnExport").addEventListener("click",exportJSON);
    $("fileImport").addEventListener("change",e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });
    $("btnWipe").addEventListener("click",()=>{ if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë?")){ localStorage.removeItem(LS_OBJECTS); localStorage.removeItem(LS_DISTRICTS); localStorage.removeItem(LS_LOCATIONS); localStorage.removeItem(LS_CATEGORIES); localStorage.removeItem(LS_METRO); objects=[]; districts=[...DEFAULT_DISTRICTS]; locations={}; categories=JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); metro=JSON.parse(JSON.stringify(DEFAULT_METRO)); renderAll(); apply(); } });

    // —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: –¥–µ–π—Å—Ç–≤–∏—è
    $("dist_add").addEventListener("click",addDistrict);
    $("loc_add").addEventListener("click",addLocation);
    $("cat_add").addEventListener("click",addCategory);
    $("subcat_add").addEventListener("click",addSubcategory);
    $("metro_add").addEventListener("click",addMetro);

    // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤
    $("modeDistrict").addEventListener("change",toggleMode);
    $("modeRadius").addEventListener("change",toggleMode);

    // —Ä–∞–¥–∏—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞
    $("f_use_center").addEventListener("click",()=>{
      const name=$("f_center_district").value; if(!name){ alert("–í—ã–±–µ—Ä–∏ —Ä–∞–π–æ–Ω —Å–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º"); return; }
      const c=dCenter(name); if(!c){ alert("–£ —ç—Ç–æ–≥–æ —Ä–∞–π–æ–Ω–∞ –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω —Ü–µ–Ω—Ç—Ä"); return; }
      setRadiusPoint(c.lat,c.lng,true);
    });
    $("f_clear_center").addEventListener("click",()=>{
      if(fMarker){ fMap.removeLayer(fMarker); fMarker=null; }
      if(fCircle){ fMap.removeLayer(fCircle); fCircle=null; }
    });
    $("f_metro_radius").addEventListener("input",()=>{ redrawCtxMap(); });

    // –¥–∏–Ω–∞–º–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
    $("f_districts").addEventListener("change",apply);
    $("f_quarters_box").addEventListener("change",apply);
    $("f_metro_box").addEventListener("change",apply);
    ["f_price_from","f_price_to","f_area_from","f_area_to","f_rooms_from","f_rooms_to","f_floor_from","f_floor_to","f_floors_from","f_floors_to"].forEach(id=>$(id).addEventListener("input",()=>{})); // –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ –∫–Ω–æ–ø–∫–µ

    renderResults(objects);
  }

  document.addEventListener("DOMContentLoaded",()=>{
    loadAll();

    // –∫–∞—Ä—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
    aMap=L.map('a_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(aMap);
    aMap.on('click',(e)=>{
      const lat=e.latlng.lat, lng=e.latlng.lng;
      $("a_lat").value=lat.toFixed(6); $("a_lng").value=lng.toFixed(6);
      if(!aMarker){ aMarker=L.marker(e.latlng,{draggable:true}).addTo(aMap); aMarker.on('dragend',()=>{const p=aMarker.getLatLng(); $("a_lat").value=p.lat.toFixed(6); $("a_lng").value=p.lng.toFixed(6);}); }
      else aMarker.setLatLng(e.latlng);
    });

    // –∫–∞—Ä—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞ —Ä–∞–¥–∏—É—Å–∞
    fMap=L.map('f_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(fMap);
    fMap.on('click',(e)=>{ setRadiusPoint(e.latlng.lat,e.latlng.lng); });
    $("f_r_km").addEventListener("input", drawRadius);

    // –∫–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–æ–≤ —Ä–∞–π–æ–Ω–æ–≤
    dMap=L.map('dist_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(dMap);
    dMap.on('click',(e)=>{
      if(!dMarker){ dMarker=L.marker([e.latlng.lat,e.latlng.lng],{draggable:true}).addTo(dMap); dMarker.on('dragend',()=>{ const p=dMarker.getLatLng(); $("dist_lat").value=p.lat.toFixed(6); $("dist_lng").value=p.lng.toFixed(6); }); }
      dMarker.setLatLng([e.latlng.lat,e.latlng.lng]);
      $("dist_lat").value=e.latlng.lat.toFixed(6); $("dist_lng").value=e.latlng.lng.toFixed(6);
    });

    // –∫–∞—Ä—Ç–∞ –º–µ—Ç—Ä–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–π
    mMap=L.map('metro_map').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(mMap);
    mMap.on('click',(e)=>{
      $("metro_lat").value=e.latlng.lat.toFixed(6);
      $("metro_lng").value=e.latlng.lng.toFixed(6);
      if(!mMarker){ mMarker=L.marker(e.latlng,{draggable:true}).addTo(mMap); mMarker.on('dragend',()=>{ const p=mMarker.getLatLng(); $("metro_lat").value=p.lat.toFixed(6); $("metro_lng").value=p.lng.toFixed(6); }); }
      else mMarker.setLatLng(e.latlng);
    });

    // –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤/–º–µ—Ç—Ä–æ
    fCtxMap=L.map('f_map_ctx').setView([41.32,69.25], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(fCtxMap);

    renderAll();

    // –∫–Ω–æ–ø–∫–∏ —Ü–µ–Ω—Ç—Ä–∞ —Ä–∞–π–æ–Ω–∞
    $("dist_center_clear").addEventListener("click",()=>{
      if(dMarker){ dMap.removeLayer(dMarker); dMarker=null; }
      $("dist_lat").value=""; $("dist_lng").value="";
    });
    $("dist_save_center").addEventListener("click",()=>{
      const name=$("dist_center_select").value;
      const lat=n($("dist_lat").value), lng=n($("dist_lng").value);
      if(!name || isNaN(lat)||isNaN(lng)){ alert("–í—ã–±–µ—Ä–∏ —Ä–∞–π–æ–Ω –∏ –∫–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ"); return; }
      setDCenter(name,lat,lng); saveAll(); alert("–¶–µ–Ω—Ç—Ä —Ä–∞–π–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω"); syncDistrictCenterToMap(); redrawCtxMap();
    });

    // –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ #id
    if(location.hash.startsWith("#id=")){
      if(!objects.length) demo();
      setTimeout(()=>{ const id=decodeURIComponent(location.hash.slice(4)); const obj=objects.find(o=>o.id===id); if(obj){ renderResults([obj]); const card=$("obj-"+id); card?.scrollIntoView({behavior:"smooth"}); }},400);
    }
  });
})();
</script>
</body>
</html>
