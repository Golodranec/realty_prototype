<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.8.0 (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–ª—è + –∫–∞—Ä—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#2563eb; --danger:#dc2626;
      --chip:#eef2ff; --chip-b:#e0e7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1{font-size:26px;margin:8px 0 6px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .sub{margin:0 0 14px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:14px;padding:14px;margin:10px 0;
      box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .col{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{font-size:14px;padding:10px;
      border:1px solid var(--border);border-radius:10px;
      background:#fff;color:var(--text)}
    input[type="number"]{width:140px}
    textarea{resize:vertical;min-height:80px}
    .btn{cursor:pointer;user-select:none}
    .btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
    .btn-ghost{background:#fff}
    .btn-danger{background:#fff;color:var(--danger);border-color:#fecaca}
    .hr{height:1px;background:var(--border);border:0;margin:12px 0}
    .section-title{font-weight:700;margin:6px 0 8px}
    .note{font-size:12px;color:var(--muted);margin-top:4px}

    /* Map */
    #mapMain{width:100%;height:420px;border-radius:12px;border:1px solid var(--border);margin-top:8px}
    #adminObjMap{height:200px;border:1px solid var(--border);border-radius:8px;margin-top:6px}
    #geoMap{height:260px;border:1px solid var(--border);border-radius:8px;margin-top:6px}

    /* Results */
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:12px}
    .hdr{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .price{font-weight:800}
    .gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .gallery img{width:100px;height:78px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .inline{display:flex;gap:8px;flex-wrap:wrap}

    /* Mode & chips */
    .mode{display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px}
    .chip{background:var(--chip);border:1px solid var(--chip-b);color:#3730a3;
      border-radius:999px;padding:2px 8px;font-size:12px}

    /* Login modal */
    #loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    #loginModal .card{max-width:360px;width:100%}

    /* CMS tree */
    .tree{padding:0;margin:0;list-style:none}
    .tree li{padding:8px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}
    .node-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .node-label{font-weight:600;min-width:160px}
    .node-kind{font-size:12px;color:#334155;background:#e2e8f0;border-radius:999px;padding:2px 8px}
    .node-actions button{padding:6px 10px}
    .children{margin-left:16px}

    /* Fields config */
    .fld{display:grid;grid-template-columns:170px 1fr 140px 130px 150px 140px auto;gap:8px;align-items:center;margin:8px 0}
    .fld label{font-size:12px;color:var(--muted)}
    .fld .x{white-space:nowrap}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginModal">
    <div class="card">
      <h3>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h3>
      <div class="col"><label>–õ–æ–≥–∏–Ω</label><input id="loginUser"></div>
      <div class="col"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="loginPass"></div>
      <div class="row">
        <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
        <button class="btn" onclick="hideLogin()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ v1.8.0</h1>
    <p class="sub">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–ª—è + –∫–æ–Ω—Ñ–∏–≥–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∫–∞—Ä—Ç–µ –≤ –∞–¥–º–∏–Ω–∫–µ. –§–∏–ª—å—Ç—Ä—ã –∏ —Ñ–æ—Ä–º–∞ ‚Äî —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="mode">
      <span class="chip">CMS</span>
      <span class="chip">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–ª—è</span>
      <span class="chip">–ì–µ–æ-–∫–æ–Ω—Ñ–∏–≥–∏</span>
      <button class="btn btn-primary" style="margin-left:auto" onclick="showLogin()">–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ (–≥–µ–Ω–µ—Ä—è—Ç—Å—è –∏–∑ —Å—Ö–µ–º—ã) -->
    <div class="card" id="filtersCard">
      <h3>–§–∏–ª—å—Ç—Ä</h3>
      <div class="row">
        <div class="col">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="filterCategory"><option value="">–õ—é–±–∞—è</option></select>
        </div>
        <div class="col">
          <label>–°—Ç–∞—Ç—É—Å</label>
          <select id="filterStatus"><option value="">–õ—é–±–æ–π</option></select>
        </div>
      </div>
      <div id="dynamicFilters" class="row" style="margin-top:8px"></div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <p class="note">–ü–æ–ª–µ–∑–Ω–æ: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ –¥–µ—Ä–µ–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ‚Äî –∏–∑ ¬´–°—Ö–µ–º—ã –ø–æ–ª–µ–π¬ª.</p>
    </div>

    <!-- –ö–ê–†–¢–ê-–ü–†–ï–í–¨–Æ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∞; –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ä—Ç–µ –∏ –∫–ª–∞—Å—Ç–µ—Ä—ã —Å–¥–µ–ª–∞–µ–º –≤ 1.8.1) -->
    <div id="mapMain"></div>
    <p class="note">–í 1.8.1 –¥–æ–±–∞–≤–∏–º ¬´—Å–∏–Ω–∏–µ –∫—Ä—É–≥–ª—è—à–∫–∏¬ª –∏ –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–µ.</p>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
    <div class="card">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- –ê–î–ú–ò–ù: –û–ë–™–ï–ö–¢–´ -->
    <div class="card" id="adminObjects" style="display:none">
      <h3>–ê–¥–º–∏–Ω: –û–±—ä–µ–∫—Ç—ã</h3>
      <div class="row">
        <div class="col"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="addCategory"></select></div>
        <div class="col"><label>–°—Ç–∞—Ç—É—Å</label><select id="addStatus"></select></div>
        <div class="col"><label>Lat</label><input id="addLat" placeholder="41.3"></div>
        <div class="col"><label>Lng</label><input id="addLng" placeholder="69.2"></div>
      </div>
      <div id="adminObjMap"></div>
      <div id="dynamicFormFields" class="row" style="margin-top:10px"></div>
      <div class="row" style="margin-top:10px">
        <div class="col" style="flex:1">
          <label>–§–æ—Ç–æ</label>
          <input type="file" id="addPhotos" multiple>
          <div id="photoPreview" class="gallery"></div>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="saveObject()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="resetForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ê–î–ú–ò–ù: –°–•–ï–ú–ê –ü–û–õ–ï–ô -->
    <div class="card" id="adminFields" style="display:none">
      <h3>–ê–¥–º–∏–Ω: –°—Ö–µ–º–∞ –ø–æ–ª–µ–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ)</h3>
      <p class="note">–¢–∏–ø—ã: —Ç–µ–∫—Å—Ç, —á–∏—Å–ª–æ, —Å–ø–∏—Å–æ–∫ (select), –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä (multiselect). –î–ª—è —Ç–∏–ø–∞ ¬´—á–∏—Å–ª–æ¬ª –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å ¬´–î–∏–∞–ø–∞–∑–æ–Ω –≤ —Ñ–∏–ª—å—Ç—Ä–µ¬ª.</p>
      <div id="fieldsList"></div>
      <div class="row">
        <button class="btn" onclick="addField()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
        <button class="btn btn-primary" onclick="saveFieldsSchema()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ö–µ–º—É</button>
      </div>
    </div>

    <!-- –ê–î–ú–ò–ù: –ì–ï–û-–ö–û–ù–§–ò–ì (–¥–µ—Ä–µ–≤–æ + –∫–∞—Ä—Ç–∞ –¥–ª—è —Ç–æ—á–∫–∏/—Ä–∞–¥–∏—É—Å–∞) -->
    <div class="card" id="adminGeo" style="display:none">
      <h3>–ê–¥–º–∏–Ω: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–µ—Ä–µ–≤–æ + –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ)</h3>
      <p class="note">–°–æ–∑–¥–∞–≤–∞–π —É–∑–ª—ã: group (–≥—Ä—É–ø–ø–∞), category (–∫–∞—Ç–µ–≥–æ—Ä–∏—è), status (—Å—Ç–∞—Ç—É—Å). –ö –ª—é–±–æ–º—É —É–∑–ª—É –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ç–æ—á–∫—É –∏ —Ä–∞–¥–∏—É—Å.</p>
      <div class="row">
        <button class="btn" onclick="addRoot()">–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª</button>
      </div>
      <ul id="tree" class="tree"></ul>

      <div class="row" style="margin-top:10px">
        <div class="col"><label>–í—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª</label><input id="geoNodeName" placeholder="‚Äî" readonly></div>
        <div class="col">
          <label>–†–∞–¥–∏—É—Å (–º)</label><input id="geoRadius" type="number" value="1000">
        </div>
      </div>
      <div id="geoMap"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="saveGeoForNode()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–µ–æ-–ø—Ä–∏–≤—è–∑–∫—É</button>
        <button class="btn" onclick="clearGeoForNode()">–°–±—Ä–æ—Å–∏—Ç—å –≥–µ–æ</button>
      </div>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const TELEGRAM_USER = "smeksy"; // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø–æ–º–µ–Ω—è–µ—à—å
    const adminUser="admin", adminPass="1234";
    let logged=false, editId=null;

    // ===== –•–†–ê–ù–ò–õ–ò–©–ê =====
    // –æ–±—ä–µ–∫—Ç—ã
    let objects = JSON.parse(localStorage.getItem("objects_v180")||"[]");
    function persistObjects(){ localStorage.setItem("objects_v180", JSON.stringify(objects)); }

    // —Å—Ö–µ–º–∞ –ø–æ–ª–µ–π
    let fieldsSchema = JSON.parse(localStorage.getItem("fields_v180")||"null");
    if(!fieldsSchema){
      fieldsSchema = [
        {id:uid(), key:"title", label:"–ó–∞–≥–æ–ª–æ–≤–æ–∫", type:"text", required:true, inFilter:true},
        {id:uid(), key:"price", label:"–¶–µ–Ω–∞ ($)", type:"number", required:false, inFilter:true, rangeInFilter:true},
        {id:uid(), key:"rooms", label:"–ö–æ–º–Ω–∞—Ç—ã", type:"number", required:false, inFilter:true, rangeInFilter:true},
        {id:uid(), key:"area",  label:"–ü–ª–æ—â–∞–¥—å (–º¬≤)", type:"number", required:false, inFilter:true, rangeInFilter:true},
        {id:uid(), key:"condition", label:"–°–æ—Å—Ç–æ—è–Ω–∏–µ", type:"select", options:["–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞ (—á–µ—Ä–Ω–æ–≤–∞—è)","–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π","–°—Ä–µ–¥–Ω–∏–π —Ä–µ–º–æ–Ω—Ç","–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç","–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç","–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π"], required:false, inFilter:true},
        {id:uid(), key:"amenities", label:"–£–¥–æ–±—Å—Ç–≤–∞", type:"multiselect", options:["–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä","–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","–ú–µ–±–µ–ª—å","–°—Ç–∏—Ä–∞–ª–∫–∞","–ò–Ω—Ç–µ—Ä–Ω–µ—Ç","–õ–∏—Ñ—Ç","–û—Ö—Ä–∞–Ω–∞"], required:false, inFilter:true}
      ];
      persistFields();
    }
    function persistFields(){ localStorage.setItem("fields_v180", JSON.stringify(fieldsSchema)); }

    // –¥–µ—Ä–µ–≤–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤
    let cmsTree = JSON.parse(localStorage.getItem("cms_tree_v180")||"null");
    if(!cmsTree){
      cmsTree = [
        { id:uid(), label:"–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", kind:"group", children:[
          { id:uid(), label:"–ö–≤–∞—Ä—Ç–∏—Ä–∞", kind:"category", children:[
            { id:uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id:uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] }
          ]},
          { id:uid(), label:"–î–æ–º", kind:"category", children:[
            { id:uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id:uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] }
          ]},
          { id:uid(), label:"–ö–æ–º–º–µ—Ä—Ü–∏—è", kind:"category", children:[
            { id:uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id:uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] }
          ]},
          { id:uid(), label:"–ú–µ—Ç—Ä–æ", kind:"group", children:[
            { id:uid(), label:"–°—Ç–∞–Ω—Ü–∏—è –ê", kind:"status", children:[], geo:{lat:41.31,lng:69.28,radius:600} },
            { id:uid(), label:"–°—Ç–∞–Ω—Ü–∏—è –ë", kind:"status", children:[], geo:{lat:41.33,lng:69.27,radius:600} }
          ]}
        ]}
      ];
      persistTree();
    }
    function persistTree(){ localStorage.setItem("cms_tree_v180", JSON.stringify(cmsTree)); }

    // ===== –£–¢–ò–õ–ò–¢–´ =====
    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
    function $(id){return document.getElementById(id);}

    // –ø–æ–∏—Å–∫ –≤ –¥–µ—Ä–µ–≤–µ
    function findNodeById(list,id){
      for(const n of list){
        if(n.id===id) return n;
        const f=n.children?findNodeById(n.children,id):null;
        if(f) return f;
      }
      return null;
    }
    function removeNodeById(list,id){
      for(let i=0;i<list.length;i++){
        if(list[i].id===id){ list.splice(i,1); return true; }
        if(list[i].children && removeNodeById(list[i].children,id)) return true;
      }
      return false;
    }

    // —Å–æ–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function getAllCategories(){
      const out=[];
      function walk(nodes){
        for(const n of nodes){
          if(n.kind==="category") out.push({id:n.id,label:n.label});
          if(n.children) walk(n.children);
        }
      }
      walk(cmsTree); return out;
    }
    // —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function getStatusesForCategoryId(catId){
      const cat=findNodeById(cmsTree,catId); if(!cat) return [];
      const out=[];
      function collect(n){
        if(n.kind==="status") out.push(n.label);
        (n.children||[]).forEach(collect);
      }
      (cat.children||[]).forEach(collect);
      return out;
    }

    // ===== –ö–ê–†–¢–´ =====
    const map = L.map("mapMain").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);

    const adminObjMap = L.map("adminObjMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(adminObjMap);
    let adminObjMarker=null;
    adminObjMap.on("click",(e)=>{ setObjLatLng(e.latlng.lat,e.latlng.lng,true); });

    function setObjLatLng(lat,lng,pan){
      $("addLat").value=lat.toFixed(6);
      $("addLng").value=lng.toFixed(6);
      if(adminObjMarker) adminObjMarker.setLatLng([lat,lng]);
      else adminObjMarker=L.marker([lat,lng]).addTo(adminObjMap);
      if(pan) adminObjMap.setView([lat,lng], 13);
    }

    // geo map (–¥–ª—è —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞)
    const geoMap = L.map("geoMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(geoMap);
    let geoMarker=null, geoCircle=null, currentGeoNodeId=null;
    geoMap.on("click",(e)=>{ placeGeo(e.latlng.lat,e.latlng.lng,true); });

    function placeGeo(lat,lng,pan){
      const radius = +($("geoRadius").value||1000);
      if(geoMarker) geoMarker.setLatLng([lat,lng]); else geoMarker=L.marker([lat,lng]).addTo(geoMap);
      if(geoCircle) geoCircle.setLatLng([lat,lng]), geoCircle.setRadius(radius);
      else geoCircle=L.circle([lat,lng],{radius,color:"#2563eb"}).addTo(geoMap);
      if(pan) geoMap.setView([lat,lng], 13);
    }

    // ===== –õ–û–ì–ò–ù =====
    function showLogin(){ $("loginModal").style.display="flex"; }
    function hideLogin(){ $("loginModal").style.display="none"; }
    function login(){
      const u=$("loginUser").value.trim();
      const p=$("loginPass").value.trim();
      if(u===adminUser && p===adminPass){
        logged=true; hideLogin();
        $("adminObjects").style.display="";
        $("adminFields").style.display="";
        $("adminGeo").style.display="";
        alert("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã, —Å—Ö–µ–º—É –ø–æ–ª–µ–π –∏ –≥–µ–æ-–∫–æ–Ω—Ñ–∏–≥.");
      } else alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
    }

    // ===== –§–û–¢–û –ü–†–ï–í–¨–Æ =====
    const addPhotos=$("addPhotos");
    addPhotos?.addEventListener("change", ()=>{
      const box=$("photoPreview"); box.innerHTML="";
      [...addPhotos.files].forEach((f)=>{
        const r=new FileReader();
        r.onload=e=>{
          const img=document.createElement("img");
          img.src=e.target.result; box.appendChild(img);
        };
        r.readAsDataURL(f);
      });
    });

    // ===== –†–ï–ù–î–ï–† –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –§–ò–õ–¨–¢–†–ê =====
    function rebuildFiltersUI(){
      const fc=$("filterCategory"), fs=$("filterStatus");
      // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      const cats=getAllCategories();
      fc.innerHTML='<option value="">–õ—é–±–∞—è</option>';
      cats.forEach(c=> fc.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      fs.innerHTML='<option value="">–õ—é–±–æ–π</option>';

      fc.onchange=()=>{
        const sts=getStatusesForCategoryId(fc.value);
        fs.innerHTML='<option value="">–õ—é–±–æ–π</option>';
        sts.forEach(s=> fs.insertAdjacentHTML("beforeend",`<option value="${s}">${s}</option>`));
      };

      // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
      const box=$("dynamicFilters"); box.innerHTML="";
      fieldsSchema.forEach(f=>{
        if(!f.inFilter) return;
        const wrap=document.createElement("div"); wrap.className="col";
        wrap.innerHTML=`<label>${f.label}</label>`;
        if(f.type==="text"){
          wrap.innerHTML+=`<input id="f_${f.key}" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É">`;
        }else if(f.type==="number"){
          if(f.rangeInFilter){
            wrap.innerHTML+=`<div class="row" style="gap:6px">
              <input type="number" id="f_${f.key}_min" placeholder="–æ—Ç" style="width:120px">
              <input type="number" id="f_${f.key}_max" placeholder="–¥–æ" style="width:120px">
            </div>`;
          }else{
            wrap.innerHTML+=`<input type="number" id="f_${f.key}" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ">`;
          }
        }else if(f.type==="select"){
          const opts=(f.options||[]).map(o=>`<option>${o}</option>`).join("");
          wrap.innerHTML+=`<select id="f_${f.key}"><option value="">–õ—é–±–æ–π</option>${opts}</select>`;
        }else if(f.type==="multiselect"){
          const id=`f_${f.key}`;
          const checks=(f.options||[]).map(o=>`<label class="pill"><input type="checkbox" name="${id}" value="${o}">${o}</label>`).join(" ");
          wrap.innerHTML+=`<div id="${id}" class="chips-list">${checks}</div>`;
        }
        box.appendChild(wrap);
      });
    }

    // ===== –†–ï–ù–î–ï–† –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ô –§–û–†–ú–´ –î–û–ë–ê–í–õ–ï–ù–ò–Ø =====
    function rebuildFormUI(){
      // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Å—Ç–∞—Ç—É—Å—ã
      const ac=$("addCategory"), as=$("addStatus");
      const cats=getAllCategories();
      ac.innerHTML=""; cats.forEach(c=> ac.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      const initCat=ac.value||cats[0]?.id||"";
      fillAddStatus(initCat);
      ac.onchange=()=> fillAddStatus(ac.value);

      function fillAddStatus(catId){
        const sts=getStatusesForCategoryId(catId);
        as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s}">${s}</option>`));
      }

      // –ø–æ–ª—è —Ñ–æ—Ä–º—ã
      const box=$("dynamicFormFields"); box.innerHTML="";
      fieldsSchema.forEach(f=>{
        const col=document.createElement("div"); col.className="col";
        col.innerHTML=`<label>${f.label}${f.required? ' *':''}</label>`;
        if(f.type==="text"){
          col.innerHTML+=`<input id="a_${f.key}" ${f.required?'required':''}>`;
        }else if(f.type==="number"){
          col.innerHTML+=`<input type="number" id="a_${f.key}" ${f.required?'required':''}>`;
        }else if(f.type==="select"){
          const opts=(f.options||[]).map(o=>`<option>${o}</option>`).join("");
          col.innerHTML+=`<select id="a_${f.key}" ${f.required?'required':''}><option value="">‚Äî</option>${opts}</select>`;
        }else if(f.type==="multiselect"){
          const id=`a_${f.key}`;
          const checks=(f.options||[]).map(o=>`<label class="pill"><input type="checkbox" name="${id}" value="${o}">${o}</label>`).join(" ");
          col.innerHTML+=`<div id="${id}" class="chips-list">${checks}</div>`;
        }
        box.appendChild(col);
      });
    }

    // ===== –†–ï–ù–î–ï–† –†–ï–ó–£–õ–¨–¢–ê–¢–û–í =====
    function renderResults(list){
      const res=$("results"); res.innerHTML="";
      list.forEach(o=>{
        const photos=(o.photos||[]).map(p=>`<img src="${p}">`).join("");
        const url = location.origin + location.pathname + "?id=" + o.id;
        const keyVals = fieldsSchema.map(f=>{
          const val = o.fields?.[f.key];
          if(!val || (Array.isArray(val)&&val.length===0)) return "";
          return `<span class="chip">${f.label}: ${Array.isArray(val)? val.join(", "): val}</span>`;
        }).filter(Boolean).join(" ");

        res.insertAdjacentHTML("beforeend",`
          <div class="item" data-id="${o.id}">
            <div class="hdr"><b>${o.fields?.title||"(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}</b><span class="price">${o.fields?.price?o.fields.price+" $":""}</span></div>
            <div>${o.categoryLabel||"-"} ‚Ä¢ ${o.statusLabel||"-"}</div>
            <div class="inline" style="margin-top:6px">${keyVals}</div>
            <div class="gallery">${photos}</div>
            <div class="inline" style="margin-top:8px">
              <a target="_blank" href="https://t.me/${TELEGRAM_USER}?text=${encodeURIComponent("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: "+url)}">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
              <button class="btn" onclick="editObject('${o.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-danger" onclick="deleteObject('${o.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `);
      });
    }
    // ===== –°–•–ï–ú–ê –ü–û–õ–ï–ô (UI) =====
    function renderFieldsConfigUI(){
      const box=$("fieldsList"); box.innerHTML="";
      fieldsSchema.forEach((f,idx)=>{
        const row=document.createElement("div"); row.className="fld";
        row.innerHTML=`
          <input class="mono" value="${f.key}" oninput="onFldKey(${idx}, this.value)" title="–∫–ª—é—á (–ª–∞—Ç–∏–Ω–∏—Ü–∞)">
          <input value="${f.label}" oninput="onFldLabel(${idx}, this.value)" title="–ø–æ–¥–ø–∏—Å—å">
          <select onchange="onFldType(${idx}, this.value)">
            <option ${f.type==='text'?'selected':''}>text</option>
            <option ${f.type==='number'?'selected':''}>number</option>
            <option ${f.type==='select'?'selected':''}>select</option>
            <option ${f.type==='multiselect'?'selected':''}>multiselect</option>
          </select>
          <label class="pill"><input type="checkbox" ${f.required?'checked':''} onchange="onFldReq(${idx}, this.checked)"> –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</label>
          <label class="pill"><input type="checkbox" ${f.inFilter?'checked':''} onchange="onFldInFilter(${idx}, this.checked)"> –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö</label>
          <label class="pill"><input type="checkbox" ${f.rangeInFilter?'checked':''} onchange="onFldRange(${idx}, this.checked)" ${f.type!=='number'?'disabled':''}> –¥–∏–∞–ø–∞–∑–æ–Ω</label>
          <div class="x">
            ${f.type==='select'||f.type==='multiselect'
              ? `<input class="mono" placeholder="–æ–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" value="${(f.options||[]).join(', ')}" oninput="onFldOptions(${idx}, this.value)">`
              : ''
            }
          </div>
          <button class="btn btn-danger" onclick="removeField(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        box.appendChild(row);
      });
    }
    function onFldKey(i,v){ fieldsSchema[i].key=sanitizeKey(v); }
    function onFldLabel(i,v){ fieldsSchema[i].label=v; }
    function onFldType(i,v){ fieldsSchema[i].type=v; if(v!=='number') fieldsSchema[i].rangeInFilter=false; renderFieldsConfigUI(); }
    function onFldReq(i,v){ fieldsSchema[i].required=v; }
    function onFldInFilter(i,v){ fieldsSchema[i].inFilter=v; }
    function onFldRange(i,v){ fieldsSchema[i].rangeInFilter=v; }
    function onFldOptions(i,v){ fieldsSchema[i].options=v.split(",").map(s=>s.trim()).filter(Boolean); }
    function addField(){ fieldsSchema.push({id:uid(), key:"field_"+(fieldsSchema.length+1), label:"–ù–æ–≤–æ–µ –ø–æ–ª–µ", type:"text", required:false, inFilter:false}); renderFieldsConfigUI(); }
    function removeField(i){ if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ?")) return; fieldsSchema.splice(i,1); renderFieldsConfigUI(); }
    function saveFieldsSchema(){ persistFields(); rebuildFiltersUI(); rebuildFormUI(); alert("–°—Ö–µ–º–∞ –ø–æ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"); }
    function sanitizeKey(s){ return s.toLowerCase().replace(/[^\w]+/g,'_'); }

    // ===== –î–ï–†–ï–í–û + –ì–ï–û =====
    function renderTreeUI(){
      const root=$("tree"); root.innerHTML="";
      cmsTree.forEach(n=> root.appendChild(renderNode(n)));
      persistTree();
      // –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–∞/—Ñ–æ—Ä–º—ã
      rebuildFiltersUI(); rebuildFormUI();
    }
    function renderNode(node){
      const li=document.createElement("li");
      const row=document.createElement("div"); row.className="node-row";
      const name=document.createElement("input"); name.className="node-label"; name.value=node.label;
      const kind=document.createElement("select");
      ["group","category","status"].forEach(k=>{
        const o=document.createElement("option"); o.value=k; o.textContent=k; if(node.kind===k) o.selected=true; kind.appendChild(o);
      });
      const btnAdd=document.createElement("button"); btnAdd.className="btn"; btnAdd.textContent="+ –ü–æ–¥—É–∑–µ–ª";
      const btnGeo=document.createElement("button"); btnGeo.className="btn"; btnGeo.textContent="–ì–µ–æ";
      const btnDel=document.createElement("button"); btnDel.className="btn btn-danger"; btnDel.textContent="–£–¥–∞–ª–∏—Ç—å";

      name.oninput=()=>{ node.label=name.value; persistTree(); rebuildFiltersUI(); rebuildFormUI(); };
      kind.onchange=()=>{ node.kind=kind.value; persistTree(); rebuildFiltersUI(); rebuildFormUI(); };

      btnAdd.onclick=()=>{
        node.children = node.children||[];
        node.children.push({id:uid(), label:"–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç", kind:"group", children:[]});
        renderTreeUI();
      };
      btnDel.onclick=()=>{
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –∏ –ø–æ–¥–¥–µ—Ä–µ–≤–æ?")) return;
        removeNodeById(cmsTree,node.id); renderTreeUI();
      };
      btnGeo.onclick=()=>{
        currentGeoNodeId=node.id;
        $("geoNodeName").value=node.label;
        const g=node.geo;
        if(g){ $("geoRadius").value=g.radius||1000; placeGeo(g.lat,g.lng,true); }
        else { $("geoRadius").value=1000; geoMarker&&geoMarker.remove(); geoCircle&&geoCircle.remove(); geoMarker=null; geoCircle=null; }
        $("adminGeo").scrollIntoView({behavior:"smooth"});
      };

      row.appendChild(name);
      row.appendChild(kind);
      row.appendChild(btnAdd);
      row.appendChild(btnGeo);
      row.appendChild(btnDel);
      li.appendChild(row);

      const ul=document.createElement("ul"); ul.className="tree children";
      (node.children||[]).forEach(ch=> ul.appendChild(renderNode(ch)));
      li.appendChild(ul);
      return li;
    }
    function addRoot(){ cmsTree.push({id:uid(), label:"–ù–æ–≤—ã–π –∫–æ—Ä–µ–Ω—å", kind:"group", children:[]}); renderTreeUI(); }

    function saveGeoForNode(){
      if(!currentGeoNodeId){ alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —É–∑–µ–ª –≤ –¥–µ—Ä–µ–≤–µ –∏ –Ω–∞–∂–º–∏ ¬´–ì–µ–æ¬ª"); return; }
      if(!geoMarker){ alert("–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É"); return; }
      const n=findNodeById(cmsTree,currentGeoNodeId);
      const latlng=geoMarker.getLatLng();
      const r=+($("geoRadius").value||1000);
      n.geo={lat:latlng.lat, lng:latlng.lng, radius:r};
      persistTree();
      alert("–ì–µ–æ-–ø—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
    }
    function clearGeoForNode(){
      if(!currentGeoNodeId) return;
      const n=findNodeById(cmsTree,currentGeoNodeId);
      delete n.geo; persistTree();
      geoMarker&&geoMarker.remove(); geoCircle&&geoCircle.remove(); geoMarker=null; geoCircle=null;
      alert("–ì–µ–æ-–ø—Ä–∏–≤—è–∑–∫–∞ –æ—á–∏—â–µ–Ω–∞");
    }

    // ===== CRUD –û–ë–™–ï–ö–¢–û–í =====
    function saveObject(){
      const catId=$("addCategory").value;
      const catLabel=(getAllCategories().find(c=>c.id===catId)||{}).label||"";
      const status=$("addStatus").value;

      // —Å–æ–±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Å—Ö–µ–º–µ
      const fields={};
      for(const f of fieldsSchema){
        if(f.type==="multiselect"){
          const name=`a_${f.key}`;
          const vals=[...document.querySelectorAll(`#${name} input[type=checkbox]:checked`)].map(el=>el.value);
          if(f.required && vals.length===0) return alert(`–ü–æ–ª–µ ¬´${f.label}¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ`);
          if(vals.length) fields[f.key]=vals;
        }else{
          const v=$(`a_${f.key}`)?.value||"";
          if(f.required && !v) return alert(`–ü–æ–ª–µ ¬´${f.label}¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ`);
          if(v) fields[f.key]= (f.type==="number" ? (+v||0) : v);
        }
      }

      const lat=parseFloat($("addLat").value)||null;
      const lng=parseFloat($("addLng").value)||null;

      const photos=[];
      document.querySelectorAll("#photoPreview img").forEach(img=> photos.push(img.src));

      const obj={
        id: editId || uid(),
        categoryId: catId,
        categoryLabel: catLabel,
        statusLabel: status,
        fields,
        lat, lng,
        photos
      };

      if(editId){
        const i=objects.findIndex(o=>o.id===editId);
        if(i>=0) objects[i]=obj;
        editId=null;
      } else objects.push(obj);

      persistObjects();
      renderResults(objects);
      resetForm();
      alert("–û–±—ä–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    }

    function editObject(id){
      const o=objects.find(x=>x.id===id); if(!o) return;
      editId=id;
      $("addCategory").value=o.categoryId||"";
      const sts=getStatusesForCategoryId(o.categoryId); // –ø–µ—Ä–µ–∑–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
      $("addStatus").innerHTML=""; sts.forEach(s=> $("addStatus").insertAdjacentHTML("beforeend",`<option>${s}</option>`));
      $("addStatus").value=o.statusLabel||"";
      $("addLat").value=o.lat||""; $("addLng").value=o.lng||"";
      if(o.lat!=null && o.lng!=null) setObjLatLng(o.lat,o.lng,true);

      // –∑–∞–ª–∏—Ç—å –ø–æ–ª—è
      fieldsSchema.forEach(f=>{
        if(f.type==="multiselect"){
          const name=`a_${f.key}`;
          const vals=new Set(o.fields?.[f.key]||[]);
          document.querySelectorAll(`#${name} input[type=checkbox]`).forEach(el=> el.checked=vals.has(el.value));
        }else{
          const el=$(`a_${f.key}`); if(el) el.value = (o.fields?.[f.key] ?? "");
        }
      });

      // —Ñ–æ—Ç–æ
      const box=$("photoPreview"); box.innerHTML="";
      (o.photos||[]).forEach(src=>{ const img=document.createElement("img"); img.src=src; box.appendChild(img); });

      $("adminObjects").scrollIntoView({behavior:"smooth"});
    }

    function deleteObject(id){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?")) return;
      objects=objects.filter(o=>o.id!==id);
      persistObjects(); renderResults(objects);
    }

    function resetForm(){
      document.querySelectorAll("#adminObjects input").forEach(el=> { if(el.type!=="file") el.value=""; });
      document.querySelectorAll("#adminObjects select").forEach(el=> el.value=el.options[0]?.value||"");
      document.querySelectorAll("#adminObjects input[type=checkbox]").forEach(el=> el.checked=false);
      $("photoPreview").innerHTML="";
      editId=null;
      adminObjMarker&&adminObjMarker.remove(); adminObjMarker=null;
    }

    // ===== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø =====
    function applyFilters(){
      const catId=$("filterCategory").value;
      const status=$("filterStatus").value;

      let list=objects.slice();
      if(catId) list=list.filter(o=>o.categoryId===catId);
      if(status) list=list.filter(o=>o.statusLabel===status);

      // –ø–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –ø–æ–ª—è–º
      for(const f of fieldsSchema){
        if(!f.inFilter) continue;
        if(f.type==="text"){
          const v=$(`f_${f.key}`)?.value?.trim().toLowerCase();
          if(v) list=list.filter(o=> String(o.fields?.[f.key]||"").toLowerCase().includes(v));
        }else if(f.type==="number"){
          if(f.rangeInFilter){
            const min=+($(`f_${f.key}_min`)?.value||"") || -Infinity;
            const max=+($(`f_${f.key}_max`)?.value||"") || +Infinity;
            list=list.filter(o=>{
              const val = (o.fields?.[f.key] ?? null);
              return (val==null) ? false : (val>=min && val<=max);
            });
          }else{
            const v=$(`f_${f.key}`)?.value;
            if(v!=="") list=list.filter(o=> (o.fields?.[f.key] ?? null) === (+v));
          }
        }else if(f.type==="select"){
          const v=$(`f_${f.key}`)?.value;
          if(v) list=list.filter(o=> (o.fields?.[f.key] ?? "") === v);
        }else if(f.type==="multiselect"){
          const boxes=[...document.querySelectorAll(`#f_${f.key} input[type=checkbox]:checked`)].map(el=>el.value);
          if(boxes.length){
            list=list.filter(o=>{
              const arr=o.fields?.[f.key]||[];
              return boxes.every(x=> arr.includes(x));
            });
          }
        }
      }

      renderResults(list);
    }
    function resetFilters(){
      $("filterCategory").value="";
      $("filterStatus").value="";
      fieldsSchema.forEach(f=>{
        const el1=$(`f_${f.key}`); if(el1) el1.value="";
        const el2=$(`f_${f.key}_min`); if(el2) el2.value="";
        const el3=$(`f_${f.key}_max`); if(el3) el3.value="";
        document.querySelectorAll(`#f_${f.key} input[type=checkbox]`).forEach(e=> e.checked=false);
      });
      renderResults(objects);
    }

    // ===== INIT =====
    function safeInit(){
      try{
        renderResults(objects);
        renderFieldsConfigUI();
        renderTreeUI(); // –ø–æ–¥—Ç—è–Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ñ–æ—Ä–º—É
        // deep link ?id=...
        const qs=new URLSearchParams(location.search);
        const openId=qs.get("id");
        if(openId){
          const o=objects.find(x=>x.id===openId);
          if(o?.lat!=null && o?.lng!=null){ map.setView([o.lat,o.lng], 15); }
        }
      }catch(e){
        console.error(e);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –°–±—Ä–æ—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–æ –∑–∞–≤–æ–¥—Å–∫–∏—Ö.");
        localStorage.removeItem("cms_tree_v180");
        localStorage.removeItem("fields_v180");
        // –Ω–µ —Ç—Ä–æ–≥–∞—é –æ–±—ä–µ–∫—Ç—ã
        location.reload();
      }
    }
    safeInit();
  </script>
</body>
</html>
