<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Каталог недвижимости — v1.8.3-fix</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#2563eb; --danger:#dc2626;
      --chip:#eef2ff; --chip-b:#c7d2fe;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1{font-size:26px;margin:10px 0}
    h3{margin:0 0 8px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:14px;padding:14px;margin:10px 0;
      box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .col{display:flex;flex-direction:column;gap:6px;min-width:220px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{font-size:14px;padding:10px;
      border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text)}
    input[type="number"]{width:140px}
    textarea{resize:vertical;min-height:80px}
    .btn{cursor:pointer;user-select:none}
    .btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
    .btn-danger{background:#fff;color:var(--danger);border-color:#fecaca}
    .note{font-size:12px;color:var(--muted)}

    /* Map */
    #mapMain{width:100%;height:420px;border-radius:12px;border:1px solid var(--border);margin-top:8px}
    #adminObjMap{height:220px;border:1px solid var(--border);border-radius:8px;margin-top:6px}
    #geoMap{height:260px;border:1px solid var(--border);border-radius:8px;margin-top:6px}

    /* Results */
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:12px}
    .hdr{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .price{font-weight:800}
    .gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .gallery .thumb{position:relative}
    .gallery img{width:100px;height:78px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .gallery .del{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px}

    .inline{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-b);color:#3730a3;
      border-radius:999px;padding:2px 8px;font-size:12px}

    /* Tree */
    .tree{padding:0;margin:0;list-style:none}
    .tree li{padding:8px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}
    .node-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .node-label{font-weight:600;min-width:160px}
    .children{margin-left:16px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}

    .fieldbox{display:grid;grid-template-columns:150px 190px 140px 150px 150px 1fr auto;gap:8px;align-items:center;margin-top:8px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .tags-wrap{display:flex;gap:8px;flex-wrap:wrap;max-height:140px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
    .tag-check{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Каталог недвижимости v1.8.3-fix</h1>
    <p class="note">Роли: группа/категория/статус. Поля тянутся из дерева. Гео без рывков. Мульти-фото с превью.</p>

    <!-- ФИЛЬТРЫ -->
    <div class="card" id="filtersCard">
      <h3>Фильтр</h3>
      <div class="row">
        <div class="col">
          <label>Группа</label>
          <select id="filterGroup"><option value="">—</option></select>
        </div>
        <div class="col">
          <label>Категория</label>
          <select id="filterCategory"><option value="">—</option></select>
        </div>
        <div class="col">
          <label>Статус</label>
          <select id="filterStatus"><option value="">—</option></select>
        </div>
      </div>

      <div class="col" style="flex:1;margin-top:8px">
        <label>Гео-узлы (районы/метро с радиусом)</label>
        <div id="filterGeo" class="tags-wrap"></div>
      </div>

      <div id="dynamicFilters" class="row" style="margin-top:10px"></div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        <button class="btn" onclick="resetFilters()">Сбросить</button>
      </div>
    </div>

    <!-- КАРТА -->
    <div id="mapMain"></div>

    <!-- РЕЗУЛЬТАТЫ -->
    <div class="card">
      <h3>Результаты</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- АДМИН: ОБЪЕКТЫ -->
    <div class="card" id="adminObjects">
      <h3>Админ: Объекты</h3>
      <div class="row">
        <div class="col"><label>Группа</label><select id="addGroup"></select></div>
        <div class="col"><label>Категория</label><select id="addCategory"></select></div>
        <div class="col"><label>Статус</label><select id="addStatus"></select></div>
      </div>

      <div class="row">
        <div class="col"><label>Lat</label><input id="addLat" placeholder="41.3"></div>
        <div class="col"><label>Lng</label><input id="addLng" placeholder="69.2"></div>
      </div>
      <div id="adminObjMap"></div>

      <div id="dynamicFormFields" class="row" style="margin-top:10px"></div>

      <div class="row" style="margin-top:10px">
        <div class="col" style="flex:1">
          <label>Фото</label>
          <input type="file" id="addPhotos" multiple accept="image/*">
          <div id="photoPreview" class="gallery"></div>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="saveObject()">Сохранить</button>
        <button class="btn" onclick="resetForm()">Очистить</button>
      </div>
    </div>

    <!-- АДМИН: ДЕРЕВО (группа/категория/статус/поле) + гео -->
    <div class="card" id="adminTree">
      <h3>Админ: Дерево (роли + поля) + гео</h3>
      <p class="note">Внутри статуса можно добавлять поля и подветви. Для любого узла можно задать точку/радиус на карте.</p>
      <div class="row">
        <button class="btn" onclick="addRoot()">+ Корневой узел (группа)</button>
      </div>
      <ul id="tree" class="tree"></ul>

      <div class="row" style="margin-top:10px">
        <div class="col"><label>Выбранный узел</label><input id="geoNodeName" placeholder="—" readonly></div>
        <div class="col"><label>Радиус (м)</label><input id="geoRadius" type="number" value="1000"></div>
      </div>
      <div id="geoMap"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="saveGeoForNode()">Сохранить гео</button>
        <button class="btn" onclick="clearGeoForNode()">Сбросить гео</button>
      </div>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // ===== helpers =====
    const $ = id => document.getElementById(id);
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    const TELEGRAM_USER = "smeksy";

    // ===== storage =====
    let objects = JSON.parse(localStorage.getItem("objects_v183") || "[]");
    function persistObjects(){ localStorage.setItem("objects_v183", JSON.stringify(objects)); }

    // cms tree (roles + fields + geo)
    let cmsTree = JSON.parse(localStorage.getItem("cms_tree_v183") || "null");
    if(!cmsTree){
      cmsTree = [
        { id: uid(), kind:"group", label:"Недвижимость", children:[
          { id: uid(), kind:"category", label:"Квартира", children:[
            { id: uid(), kind:"status", label:"Аренда", children:[
              { id: uid(), kind:"field", label:"Тип аренды", field:{ key:"rent_type", label:"Тип аренды", type:"select", options:["Посуточная","Долгосрочная"], inFilter:true, required:false } },
              { id: uid(), kind:"field", label:"Срок (мес)", field:{ key:"term", label:"Срок (мес)", type:"number", inFilter:false, required:false } }
            ]},
            { id: uid(), kind:"status", label:"Продажа", children:[] }
          ]},
          { id: uid(), kind:"category", label:"Дом", children:[
            { id: uid(), kind:"status", label:"Аренда", children:[] },
            { id: uid(), kind:"status", label:"Продажа", children:[] }
          ]},
          { id: uid(), kind:"category", label:"Коммерция", children:[
            { id: uid(), kind:"status", label:"Аренда", children:[
              { id: uid(), kind:"category", label:"Офис", children:[] },
              { id: uid(), kind:"category", label:"Склад", children:[] },
              { id: uid(), kind:"category", label:"Общепит", children:[] }
            ]},
            { id: uid(), kind:"status", label:"Продажа", children:[] }
          ]},
          // глобальные поля (висят прямо на группе)
          { id: uid(), kind:"field", label:"Заголовок", field:{ key:"title", label:"Заголовок", type:"text", required:true, inFilter:true, global:true } },
          { id: uid(), kind:"field", label:"Цена ($)", field:{ key:"price", label:"Цена ($)", type:"number", inFilter:true, rangeInFilter:true, global:true } },
          { id: uid(), kind:"field", label:"Комнаты", field:{ key:"rooms", label:"Комнаты", type:"number", inFilter:true, rangeInFilter:true, global:true } },
          { id: uid(), kind:"field", label:"Площадь (м²)", field:{ key:"area", label:"Площадь (м²)", type:"number", inFilter:true, rangeInFilter:true, global:true } },
          { id: uid(), kind:"field", label:"Состояние", field:{ key:"condition", label:"Состояние", type:"select", options:["Черновая","Косметика","Евроремонт","Дизайнерский"], inFilter:true, global:true } },
          { id: uid(), kind:"field", label:"Удобства", field:{ key:"amenities", label:"Удобства", type:"multiselect", options:["Кондиционер","Холодильник","Мебель","Интернет","Лифт","Охрана"], inFilter:true, global:true } }
        ]},
        { id: uid(), kind:"group", label:"Метро", children:[
          { id: uid(), kind:"category", label:"Ташкент", children:[
            { id: uid(), kind:"status", label:"Станция А", geo:{lat:41.311,lng:69.279,radius:700}, children:[] },
            { id: uid(), kind:"status", label:"Станция Б", geo:{lat:41.325,lng:69.265,radius:800}, children:[] }
          ]}
        ]},
        { id: uid(), kind:"group", label:"Районы", children:[
          { id: uid(), kind:"category", label:"Юнусабад", geo:{lat:41.367,lng:69.285,radius:2000}, children:[
            { id: uid(), kind:"status", label:"9 квартал", geo:{lat:41.374,lng:69.282,radius:600}, children:[] }
          ]},
          { id: uid(), kind:"category", label:"Мирабад", geo:{lat:41.304,lng:69.269,radius:1800}, children:[] }
        ]}
      ];
      persistTree();
    }
    function persistTree(){ localStorage.setItem("cms_tree_v183", JSON.stringify(cmsTree)); }

    // ===== tree utils =====
    function walk(nodes, fn, parents=[]){
      if(!nodes) return;
      for(const n of nodes){
        fn(n, parents);
        if(n.children?.length) walk(n.children, fn, [...parents, n]);
      }
    }
    function findNodeById(id){ let res=null; walk(cmsTree,(n)=>{ if(n.id===id) res=n; }); return res; }
    function removeNodeById(list,id){
      for(let i=0;i<list.length;i++){
        const n=list[i];
        if(n.id===id){ list.splice(i,1); return true; }
        if(n.children && removeNodeById(n.children,id)) return true;
      }
      return false;
    }

    // roles
    function groupsList(){ const out=[]; walk(cmsTree,n=>{ if(n.kind==="group") out.push(n); }); return out; }
    function categoriesForGroup(gid){ const g=findNodeById(gid); if(!g) return []; return (g.children||[]).filter(x=>x.kind==="category"); }
    function statusesForCategory(gid,cid){
      const cats=categoriesForGroup(gid);
      const c=cats.find(x=>x.id===cid); if(!c) return [];
      return (c.children||[]).filter(x=>x.kind==="status");
    }

    // fields
    function collectFieldsUnder(node){
      const out=[]; walk([node], n=>{ if(n.kind==="field" && n.field) out.push(n.field); });
      return out;
    }
    function collectGlobalFieldsForGroup(gid){
      const g=findNodeById(gid); if(!g) return [];
      const out=[]; (g.children||[]).forEach(n=>{ if(n.kind==="field" && n.field?.global) out.push(n.field); });
      return out;
    }

    // geo
    function geoNodes(){
      const arr=[];
      walk(cmsTree,(n,parents)=>{
        if(n.geo){
          arr.push({ id:n.id, label:n.label, path:parents.map(p=>p.label).concat(n.label),
            lat:n.geo.lat, lng:n.geo.lng, radius:n.geo.radius });
        }
      });
      return arr;
    }
    function selectedGeoNodes(){
      return [...document.querySelectorAll("#filterGeo input[type=checkbox]:checked")].map(el=>({
        id:el.dataset.id, lat:+el.dataset.lat, lng:+el.dataset.lng, r:+el.dataset.r
      }));
    }
    function distanceMeters(lat1,lng1,lat2,lng2){
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function withinAnyGeo(obj, geos){
      if(obj.lat==null || obj.lng==null) return false;
      return geos.some(g=> distanceMeters(obj.lat,obj.lng, g.lat,g.lng) <= g.r);
    }

    // ===== maps =====
    const map = L.map("mapMain").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
    let markersLayer = L.layerGroup().addTo(map);

    const adminObjMap = L.map("adminObjMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(adminObjMap);
    let adminObjMarker=null;
    adminObjMap.on("click",(e)=> setObjLatLng(e.latlng.lat,e.latlng.lng,true));
    function setObjLatLng(lat,lng,pan){
      $("addLat").value=lat.toFixed(6);
      $("addLng").value=lng.toFixed(6);
      if(adminObjMarker) adminObjMarker.setLatLng([lat,lng]);
      else adminObjMarker=L.marker([lat,lng]).addTo(adminObjMap);
      if(pan) adminObjMap.setView([lat,lng], 13);
    }

    const geoMap = L.map("geoMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(geoMap);
    let geoMarker=null, geoCircle=null, currentGeoNodeId=null;
    geoMap.on("click",(e)=> placeGeo(e.latlng.lat,e.latlng.lng,true));
    function placeGeo(lat,lng,pan){
      const r=+($("geoRadius").value||1000);
      if(geoMarker) geoMarker.setLatLng([lat,lng]); else geoMarker=L.marker([lat,lng]).addTo(geoMap);
      if(geoCircle){ geoCircle.setLatLng([lat,lng]); geoCircle.setRadius(r); }
      else geoCircle=L.circle([lat,lng],{radius:r,color:"#2563eb"}).addTo(geoMap);
      if(pan) geoMap.setView([lat,lng], 13);
    }
  </script>
  <script>
    // ===== TREE UI =====
    function renderTreeUI(){
      const root=$("tree"); root.innerHTML="";
      cmsTree.forEach(n=> root.appendChild(renderNode(n)));
      persistTree();
      rebuildRoleSelects();
      rebuildGeoFilterUI();
      rebuildFiltersUI();
      rebuildFormUI();
    }

    function renderNode(node){
      const li=document.createElement("li");
      const row=document.createElement("div"); row.className="node-row";

      const name=document.createElement("input"); name.className="node-label"; name.value=node.label;
      name.oninput=()=>{ node.label=name.value; persistTree(); rebuildRoleSelects(); rebuildGeoFilterUI(); };

      const kind=document.createElement("select");
      ["group","category","status","field"].forEach(k=>{
        const o=document.createElement("option"); o.value=k; o.textContent=k; if(node.kind===k) o.selected=true; kind.appendChild(o);
      });
      kind.onchange=()=>{
        node.kind=kind.value;
        if(node.kind==="field" && !node.field){
          node.field={ key:suggestKey(node.label), label:node.label, type:"text", options:[], required:false, inFilter:false, rangeInFilter:false, global:false };
        }
        if(node.kind!=="field"){ delete node.field; }
        persistTree(); renderTreeUI();
      };

      const btnAdd=document.createElement("button"); btnAdd.className="btn"; btnAdd.textContent="+ Подузел";
      btnAdd.onclick=()=>{
        if(node.kind==="field"){ alert("Поле не может иметь подузлы"); return; }
        node.children=node.children||[];
        const defKind = node.kind==="group" ? "category" : (node.kind==="status" ? "category" : "status");
        node.children.push({id:uid(), kind:defKind, label:`Новый ${defKind}`, children:[]});
        renderTreeUI();
      };

      const btnGeo=document.createElement("button"); btnGeo.className="btn"; btnGeo.textContent="Гео";
      btnGeo.onclick=()=>{
        currentGeoNodeId=node.id;
        $("geoNodeName").value=node.label;
        $("geoRadius").value=node.geo?.radius || 1000;
        if(node.geo){ placeGeo(node.geo.lat,node.geo.lng,true); }
        else { geoMarker&&geoMarker.remove(); geoCircle&&geoCircle.remove(); geoMarker=null; geoCircle=null; }
        geoMap.invalidateSize();
      };

      const btnDel=document.createElement("button"); btnDel.className="btn btn-danger"; btnDel.textContent="Удалить";
      btnDel.onclick=()=>{ if(confirm("Удалить узел и поддерево?")){ removeNodeById(cmsTree,node.id); renderTreeUI(); } };

      row.append(name, kind, btnAdd, btnGeo, btnDel);
      li.appendChild(row);

      // если field — показать настройки
      if(node.kind==="field" && node.field){
        const f=node.field;
        const cfg=document.createElement("div"); cfg.className="fieldbox";
        cfg.innerHTML=`
          <input class="mono" value="${f.key}" title="ключ" oninput="onFld(nodeById('${node.id}'),'key',this.value)">
          <input value="${f.label}" title="подпись" oninput="onFld(nodeById('${node.id}'),'label',this.value)">
          <select onchange="onFld(nodeById('${node.id}'),'type',this.value)">
            <option ${f.type==='text'?'selected':''}>text</option>
            <option ${f.type==='number'?'selected':''}>number</option>
            <option ${f.type==='select'?'selected':''}>select</option>
            <option ${f.type==='multiselect'?'selected':''}>multiselect</option>
          </select>
          <label class="pill"><input type="checkbox" ${f.required?'checked':''} onchange="onFld(nodeById('${node.id}'),'required',this.checked)"> обязательное</label>
          <label class="pill"><input type="checkbox" ${f.inFilter?'checked':''} onchange="onFld(nodeById('${node.id}'),'inFilter',this.checked)"> в фильтрах</label>
          <label class="pill"><input type="checkbox" ${f.rangeInFilter?'checked':''} ${f.type!=='number'?'disabled':''}
            onchange="onFld(nodeById('${node.id}'),'rangeInFilter',this.checked)"> диапазон</label>
          <label class="pill"><input type="checkbox" ${f.global?'checked':''} onchange="onFld(nodeById('${node.id}'),'global',this.checked)"> глобальное</label>
          <input class="mono" placeholder="опции через запятую" value="${(f.options||[]).join(', ')}"
            ${f.type==='select'||f.type==='multiselect'?'':'disabled'}
            oninput="onFldOptions(nodeById('${node.id}'), this.value)">
        `;
        li.appendChild(cfg);
      }

      // дети
      const ul=document.createElement("ul"); ul.className="tree children";
      (node.children||[]).forEach(ch=> ul.appendChild(renderNode(ch)));
      li.appendChild(ul);
      return li;
    }
    function nodeById(id){ return findNodeById(id); }
    function suggestKey(s){ return (s||"field").toLowerCase().replace(/[^\w]+/g,'_'); }
    function onFld(node, prop, val){
      if(!node?.field) return;
      if(prop==="type"){ node.field.type=val; if(val!=="number") node.field.rangeInFilter=false; }
      else if(prop==="required"){ node.field.required=!!val; }
      else if(prop==="inFilter"){ node.field.inFilter=!!val; }
      else if(prop==="rangeInFilter"){ node.field.rangeInFilter=!!val; }
      else if(prop==="global"){ node.field.global=!!val; }
      else if(prop==="key"){ node.field.key=suggestKey(val); }
      else if(prop==="label"){ node.field.label=val; node.label=val; }
      persistTree(); rebuildFiltersUI(); rebuildFormUI(); renderTreeUI();
    }
    function onFldOptions(node, str){
      if(!node?.field) return;
      node.field.options = str.split(",").map(s=>s.trim()).filter(Boolean);
      persistTree(); rebuildFiltersUI(); rebuildFormUI();
    }

    // ===== ROLE SELECTS =====
    function rebuildRoleSelects(){
      // фильтры
      const gsel=$("filterGroup"), csel=$("filterCategory"), ssel=$("filterStatus");
      const gs=groupsList();
      gsel.innerHTML='<option value="">—</option>';
      gs.forEach(g=> gsel.insertAdjacentHTML("beforeend",`<option value="${g.id}">${g.label}</option>`));
      csel.innerHTML='<option value="">—</option>';
      ssel.innerHTML='<option value="">—</option>';

      gsel.onchange=()=>{
        const cats=categoriesForGroup(gsel.value);
        csel.innerHTML='<option value="">—</option>';
        cats.forEach(c=> csel.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
        ssel.innerHTML='<option value="">—</option>';
        rebuildFiltersUI();
      };
      csel.onchange=()=>{
        const sts=statusesForCategory(gsel.value,csel.value);
        ssel.innerHTML='<option value="">—</option>';
        sts.forEach(s=> ssel.insertAdjacentHTML("beforeend",`<option value="${s.id}">${s.label}</option>`));
        rebuildFiltersUI();
      };
      ssel.onchange=()=> rebuildFiltersUI();

      // форма добавления
      const ag=$("addGroup"), ac=$("addCategory"), as=$("addStatus");
      ag.innerHTML=""; gs.forEach(g=> ag.insertAdjacentHTML("beforeend",`<option value="${g.id}">${g.label}</option>`));
      const firstG=gs[0]?.id||"";
      fillAddCategories(firstG);
      ag.onchange=()=> fillAddCategories(ag.value);

      function fillAddCategories(gid){
        const cats=categoriesForGroup(gid);
        ac.innerHTML=""; cats.forEach(c=> ac.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
        const firstC=cats[0]?.id||"";
        fillAddStatuses(gid, firstC);
        ac.onchange=()=> fillAddStatuses(gid, ac.value);
      }
      function fillAddStatuses(gid,cid){
        const sts=statusesForCategory(gid,cid);
        as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s.id}">${s.label}</option>`));
        rebuildFormUI();
      }
    }

    // ===== GEO FILTER UI =====
    function rebuildGeoFilterUI(){
      const box=$("filterGeo"); box.innerHTML="";
      const list=geoNodes();
      list.forEach(n=>{
        const id="geo_"+n.id;
        box.insertAdjacentHTML("beforeend",`
          <label class="tag-check"><input type="checkbox" id="${id}" data-lat="${n.lat}" data-lng="${n.lng}" data-r="${n.radius}" data-id="${n.id}">
            <span>${n.path.join(" / ")}</span>
          </label>
        `);
      });
    }

    // ===== DYNAMIC FILTERS =====
    function rebuildFiltersUI(){
      const gid=$("filterGroup").value, cid=$("filterCategory").value, sid=$("filterStatus").value;
      const box=$("dynamicFilters"); box.innerHTML="";

      let fields=[];
      if(gid) fields = fields.concat(collectGlobalFieldsForGroup(gid));
      if(sid){ const st=findNodeById(sid); if(st) fields = fields.concat(collectFieldsUnder(st)); }
      // уник по key
      const seen=new Set(); fields=fields.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });

      fields.forEach(f=>{
        if(!f.inFilter) return;
        const col=document.createElement("div"); col.className="col";
        col.innerHTML=`<label>${f.label}</label>`;
        if(f.type==="text"){
          col.innerHTML+=`<input id="f_${f.key}" placeholder="Поиск по тексту">`;
        }else if(f.type==="number"){
          if(f.rangeInFilter){
            col.innerHTML+=`<div class="row" style="gap:6px">
              <input type="number" id="f_${f.key}_min" placeholder="от" style="width:120px">
              <input type="number" id="f_${f.key}_max" placeholder="до" style="width:120px">
            </div>`;
          }else{
            col.innerHTML+=`<input type="number" id="f_${f.key}" placeholder="значение">`;
          }
        }else if(f.type==="select"){
          const opts=(f.options||[]).map(o=>`<option>${o}</option>`).join("");
          col.innerHTML+=`<select id="f_${f.key}"><option value="">Любой</option>${opts}</select>`;
        }else if(f.type==="multiselect"){
          const id=`f_${f.key}`;
          const checks=(f.options||[]).map(o=>`<label class="pill"><input type="checkbox" name="${id}" value="${o}">${o}</label>`).join(" ");
          col.innerHTML+=`<div id="${id}" class="inline">${checks}</div>`;
        }
        box.appendChild(col);
      });
    }

    // ===== DYNAMIC FORM (ADD/EDIT) =====
    function rebuildFormUI(){
      const gid=$("addGroup").value, sid=$("addStatus").value;
      const box=$("dynamicFormFields"); box.innerHTML="";
      let fields=[];
      if(gid) fields = fields.concat(collectGlobalFieldsForGroup(gid));
      if(sid){ const st=findNodeById(sid); if(st) fields = fields.concat(collectFieldsUnder(st)); }
      const seen=new Set(); fields=fields.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });

      fields.forEach(f=>{
        const col=document.createElement("div"); col.className="col";
        col.innerHTML=`<label>${f.label}${f.required?' *':''}</label>`;
        if(f.type==="text"){
          col.innerHTML+=`<input id="a_${f.key}" ${f.required?'required':''}>`;
        }else if(f.type==="number"){
          col.innerHTML+=`<input type="number" id="a_${f.key}" ${f.required?'required':''}>`;
        }else if(f.type==="select"){
          const opts=(f.options||[]).map(o=>`<option>${o}</option>`).join("");
          col.innerHTML+=`<select id="a_${f.key}" ${f.required?'required':''}><option value="">—</option>${opts}</select>`;
        }else if(f.type==="multiselect"){
          const id=`a_${f.key}`;
          const checks=(f.options||[]).map(o=>`<label class="pill"><input type="checkbox" name="${id}" value="${o}">${o}</label>`).join(" ");
          col.innerHTML+=`<div id="${id}" class="inline">${checks}</div>`;
        }
        box.appendChild(col);
      });
    }

    // ===== PHOTOS: preview + delete (мульти) =====
    const addPhotos = $("addPhotos");
    addPhotos?.addEventListener("change", ()=>{
      const box=$("photoPreview"); box.innerHTML="";
      const files=[...addPhotos.files];
      files.forEach((f,idx)=>{
        const fr=new FileReader();
        fr.onload=e=>{
          const d=document.createElement("div"); d.className="thumb";
          d.innerHTML=`<img src="${e.target.result}"><button class="del" data-i="${idx}">×</button>`;
          box.appendChild(d);
        };
        fr.readAsDataURL(f);
      });
    });
    $("photoPreview")?.addEventListener("click",(e)=>{
      const btn=e.target.closest(".del"); if(!btn) return;
      const i=+btn.dataset.i;
      const dt=new DataTransfer();
      [...addPhotos.files].forEach((f,idx)=>{ if(idx!==i) dt.items.add(f); });
      addPhotos.files=dt.files;
      addPhotos.dispatchEvent(new Event("change"));
    });

    // ===== CRUD OBJECTS =====
    let editId=null;

    function saveObject(){
      const gid=$("addGroup").value, cid=$("addCategory").value, sid=$("addStatus").value;
      if(!gid||!cid||!sid) return alert("Выбери группу/категорию/статус");

      // собрать поля согласно дефам
      let defs=[]; defs=defs.concat(collectGlobalFieldsForGroup(gid));
      const st=findNodeById(sid); if(st) defs=defs.concat(collectFieldsUnder(st));
      const seen=new Set(); defs=defs.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });

      const fields={};
      for(const f of defs){
        if(f.type==="multiselect"){
          const name=`a_${f.key}`;
          const vals=[...document.querySelectorAll(`#${name} input[type=checkbox]:checked`)].map(el=>el.value);
          if(f.required && vals.length===0) return alert(`Поле «${f.label}» обязательно`);
          if(vals.length) fields[f.key]=vals;
        }else{
          const el=$(`a_${f.key}`); if(!el) continue;
          const v=el.value;
          if(f.required && !v) return alert(`Поле «${f.label}» обязательно`);
          if(v!==""){ fields[f.key]= f.type==="number" ? (+v||0) : v; }
        }
      }

      const lat=parseFloat($("addLat").value)||null;
      const lng=parseFloat($("addLng").value)||null;

      // собрать фото из превью (dataURL)
      const photos=[];
      document.querySelectorAll("#photoPreview img").forEach(img=> photos.push(img.src));

      const obj={
        id: editId || uid(),
        groupId: gid, categoryId: cid, statusId: sid,
        fields, lat, lng, photos
      };

      if(editId){
        const i=objects.findIndex(o=>o.id===editId);
        if(i>=0) objects[i]=obj;
        editId=null;
      } else objects.push(obj);

      persistObjects();
      renderResults(objects);
      resetForm();
      alert("Объект сохранён");
    }

    function editObject(id){
      const o=objects.find(x=>x.id===id); if(!o) return;
      editId=id;
      // ролевые селекты
      $("addGroup").value=o.groupId;
      const cats=categoriesForGroup(o.groupId);
      $("addCategory").innerHTML=""; cats.forEach(c=> $("addCategory").insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      $("addCategory").value=o.categoryId;
      const sts=statusesForCategory(o.groupId,o.categoryId);
      $("addStatus").innerHTML=""; sts.forEach(s=> $("addStatus").insertAdjacentHTML("beforeend",`<option value="${s.id}">${s.label}</option>`));
      $("addStatus").value=o.statusId;

      rebuildFormUI();
      // подставить значения полей
      let defs=[]; defs=defs.concat(collectGlobalFieldsForGroup(o.groupId)); const st=findNodeById(o.statusId); if(st) defs=defs.concat(collectFieldsUnder(st));
      const seen=new Set(); const uniq=defs.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });
      uniq.forEach(f=>{
        if(f.type==="multiselect"){
          const name=`a_${f.key}`; const vals=new Set(o.fields?.[f.key]||[]);
          document.querySelectorAll(`#${name} input[type=checkbox]`).forEach(el=> el.checked=vals.has(el.value));
        }else{
          const el=$(`a_${f.key}`); if(el) el.value = (o.fields?.[f.key] ?? "");
        }
      });

      // гео
      $("addLat").value=o.lat||""; $("addLng").value=o.lng||"";
      if(o.lat!=null && o.lng!=null) setObjLatLng(o.lat,o.lng,true);

      // фото
      const box=$("photoPreview"); box.innerHTML="";
      (o.photos||[]).forEach((src,idx)=>{
        const d=document.createElement("div"); d.className="thumb";
        d.innerHTML=`<img src="${src}"><button class="del" data-i="${idx}">×</button>`;
        box.appendChild(d);
      });

      $("adminObjects").scrollIntoView({behavior:"smooth"});
    }

    function deleteObject(id){
      if(!confirm("Удалить объект?")) return;
      objects=objects.filter(o=>o.id!==id);
      persistObjects(); renderResults(objects);
    }

    function resetForm(){
      document.querySelectorAll("#adminObjects input").forEach(el=>{ if(el.type!=="file") el.value=""; });
      $("photoPreview").innerHTML="";
      adminObjMarker&&adminObjMarker.remove(); adminObjMarker=null;
      editId=null;
      rebuildFormUI();
    }

    // ===== RESULTS RENDER =====
    function renderResults(list){
      const res=$("results"); res.innerHTML="";
      markersLayer.clearLayers();

      const labelById={}; walk(cmsTree,(n)=>{ labelById[n.id]=n.label; });

      list.forEach(o=>{
        const photos=(o.photos||[]).map(p=>`<img src="${p}">`).join("");
        const path=[labelById[o.groupId], labelById[o.categoryId], labelById[o.statusId]].filter(Boolean).join(" / ");
        const url = location.origin + location.pathname + "?id=" + o.id;

        // собрать чипы по полям
        let defs=[]; defs=defs.concat(collectGlobalFieldsForGroup(o.groupId)); const st=findNodeById(o.statusId); if(st) defs=defs.concat(collectFieldsUnder(st));
        const seen=new Set(); const uniq=defs.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });
        const chips = uniq.map(f=>{
          const v=o.fields?.[f.key];
          if(v==null || (Array.isArray(v)&&!v.length)) return "";
          return `<span class="chip">${f.label}: ${Array.isArray(v)? v.join(", ") : v}</span>`;
        }).filter(Boolean).join(" ");

        res.insertAdjacentHTML("beforeend",`
          <div class="item" data-id="${o.id}">
            <div class="hdr">
              <b>${o.fields?.title||"(без названия)"} — ${path}</b>
              <span class="price">${o.fields?.price?o.fields.price+" $":""}</span>
            </div>
            <div class="inline" style="margin-top:6px">${chips}</div>
            <div class="gallery">${photos}</div>
            <div class="inline" style="margin-top:8px">
              <a target="_blank" href="https://t.me/${TELEGRAM_USER}?text=${encodeURIComponent("Здравствуйте, интересует объявление: "+url)}">Написать в Telegram</a>
              <button class="btn" onclick="editObject('${o.id}')">✏️ Редактировать</button>
              <button class="btn btn-danger" onclick="deleteObject('${o.id}')">🗑 Удалить</button>
            </div>
          </div>
        `);

        if(o.lat!=null && o.lng!=null){
          const m=L.marker([o.lat,o.lng]).addTo(markersLayer);
          m.bindPopup(`<b>${o.fields?.title||"(без названия)"}</b><br>${o.fields?.price?o.fields.price+" $":""}<br>${path}`);
        }
      });
    }

    // ===== FILTERING =====
    function applyFilters(){
      const gid=$("filterGroup").value, cid=$("filterCategory").value, sid=$("filterStatus").value;
      const geos=selectedGeoNodes();

      let list=objects.slice();
      if(gid) list=list.filter(o=>o.groupId===gid);
      if(cid) list=list.filter(o=>o.categoryId===cid);
      if(sid) list=list.filter(o=>o.statusId===sid);
      if(geos.length) list=list.filter(o=> withinAnyGeo(o, geos));

      // по полям
      let defs=[];
      if(gid) defs=defs.concat(collectGlobalFieldsForGroup(gid));
      if(sid){ const st=findNodeById(sid); if(st) defs=defs.concat(collectFieldsUnder(st)); }
      const seen=new Set(); defs=defs.filter(f=>{ if(seen.has(f.key)) return false; seen.add(f.key); return true; });

      for(const f of defs){
        if(!f.inFilter) continue;
        if(f.type==="text"){
          const v=$(`f_${f.key}`)?.value?.trim().toLowerCase();
          if(v) list=list.filter(o=> String(o.fields?.[f.key]||"").toLowerCase().includes(v));
        }else if(f.type==="number"){
          if(f.rangeInFilter){
            const min=+($(`f_${f.key}_min`)?.value||"") || -Infinity;
            const max=+($(`f_${f.key}_max`)?.value||"") || +Infinity;
            list=list.filter(o=>{
              const val=o.fields?.[f.key];
              return (val!=null) && (val>=min && val<=max);
            });
          }else{
            const v=$(`f_${f.key}`)?.value;
            if(v!=="") list=list.filter(o=> (o.fields?.[f.key] ?? null) === (+v));
          }
        }else if(f.type==="select"){
          const v=$(`f_${f.key}`)?.value;
          if(v) list=list.filter(o=> (o.fields?.[f.key] ?? "") === v);
        }else if(f.type==="multiselect"){
          const vals=[...document.querySelectorAll(`#f_${f.key} input[type=checkbox]:checked`)].map(el=>el.value);
          if(vals.length){
            list=list.filter(o=>{
              const arr=o.fields?.[f.key]||[];
              return vals.every(x=> arr.includes(x));
            });
          }
        }
      }

      renderResults(list);
    }

    function resetFilters(){
      $("filterGroup").value=""; $("filterCategory").value=""; $("filterStatus").value="";
      document.querySelectorAll("#filterGeo input[type=checkbox]").forEach(el=> el.checked=false);
      rebuildRoleSelects();  // перезаполнит селекты
      rebuildFiltersUI();
      renderResults(objects);
    }

    // ===== GEO SAVE/CLEAR =====
    function saveGeoForNode(){
      if(!currentGeoNodeId) return alert("Выбери узел (кнопка «Гео»)");
      if(!geoMarker) return alert("Кликни на карте, чтобы поставить точку");
      const n=findNodeById(currentGeoNodeId);
      const r=+($("geoRadius").value||1000);
      const {lat,lng} = geoMarker.getLatLng();
      n.geo = {lat,lng,radius:r};
      persistTree();
      rebuildGeoFilterUI();
      alert("Гео сохранено");
    }
    function clearGeoForNode(){
      if(!currentGeoNodeId) return;
      const n=findNodeById(currentGeoNodeId);
      delete n.geo; persistTree();
      geoMarker&&geoMarker.remove(); geoCircle&&geoCircle.remove(); geoMarker=null; geoCircle=null;
      rebuildGeoFilterUI();
      alert("Гео очищено");
    }

    // ===== INIT =====
    function safeInit(){
      try{
        renderTreeUI();
        renderResults(objects);
      }catch(e){
        console.error(e);
        alert("Ошибка инициализации. Сброшу конфигурацию.");
        localStorage.removeItem("cms_tree_v183");
        location.reload();
      }
    }
    safeInit();

    // deeplink ?id=...
    const qs=new URLSearchParams(location.search);
    const openId=qs.get("id");
    if(openId){
      const o=objects.find(x=>x.id===openId);
      if(o?.lat!=null && o?.lng!=null){ map.setView([o.lat,o.lng], 15); }
    }

    // add root
    function addRoot(){
      cmsTree.push({id:uid(), kind:"group", label:"Новая группа", children:[]});
      renderTreeUI();
    }
  </script>
</body>
</html>
