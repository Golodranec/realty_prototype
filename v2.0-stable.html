<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Realty v2.0-stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin="anonymous"
  />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --b:#e5e7eb;
      --accent:#2563eb; --accent-2:#1e40af; --danger:#dc2626;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif }
    header{ background:var(--accent); color:#fff; padding:10px 14px; font-weight:700 }
    main{ max-width:1200px; margin:0 auto; padding:12px }
    .card{ background:var(--card); border:1px solid var(--b); border-radius:12px; padding:12px; margin:10px 0; box-shadow:0 3px 16px rgba(0,0,0,.04) }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end }
    .col{ display:flex; flex-direction:column; gap:6px; min-width:200px }
    label{ font-size:12px; color:var(--muted) }
    input, select, button{ font-size:14px; padding:8px; border:1px solid var(--b); border-radius:8px; background:#fff }
    button{ cursor:pointer }
    .btn{ background:#fff }
    .btn-primary{ background:var(--accent); color:#fff; border-color:var(--accent-2) }
    .btn-danger{ background:#fff; color:var(--danger); border-color:#fecaca }
    .btn-ghost{ background:transparent; border:1px dashed var(--b); color:var(--muted) }
    .note{ font-size:12px; color:var(--muted) }
    #mapMain{ height:420px; border-radius:12px; border:1px solid var(--b) }
    #adminMap{ height:240px; border-radius:10px; border:1px solid var(--b) }
    .list{ display:grid; gap:10px }
    .item{ border:1px solid var(--b); border-radius:10px; padding:10px; background:#fff; cursor:pointer; transition:.2s }
    .item:hover{ box-shadow:0 6px 20px rgba(0,0,0,.08) }
    .hdr{ display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap }
    .price{ font-weight:800 }
    .thumbs{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px }
    .thumb{ position:relative }
    .thumb img{ width:100px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--b) }
    .thumb .del{ position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer }
    .chip{ display:inline-block; background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; padding:2px 8px; font-size:12px; margin:2px 4px 0 0 }
    .pill{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--b); border-radius:999px; padding:4px 10px; background:#fff }
    .tree ul{ list-style:none; padding-left:18px; margin:6px 0 }
    .tree .node{ display:flex; gap:6px; align-items:center; margin:4px 0 }
    .tree .node input[type="text"]{ padding:4px 6px; border-radius:6px; border:1px solid var(--b); width:180px }
    .tree .icon{ width:30px; text-align:center; font-size:18px }
    /* Modal detail */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:1000 }
    .modal-content{ background:#fff; border-radius:12px; max-width:900px; width:100%; max-height:90vh; overflow:auto; padding:16px; position:relative }
    .close{ position:absolute; top:8px; right:12px; font-size:22px; cursor:pointer }
    .slider{ position:relative; overflow:hidden; margin-bottom:10px }
    .slides{ display:flex; transition:transform .3s }
    .slides img{ width:900px; max-width:100%; height:480px; object-fit:cover; border-radius:12px }
    .slider button{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.5); color:#fff; border:none; font-size:22px; padding:6px 12px; cursor:pointer }
    .slider .prev{ left:10px } .slider .next{ right:10px }
    /* Auth */
    .authbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px; background:#f8fafc; border:1px dashed var(--b); border-radius:10px; margin-bottom:10px }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <header>üè† Realty v2.0-stable</header>
  <main>
    <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="authbar card">
      <div>
        <b>–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø</b>
        <span id="authStatus" class="note">–í—ã –Ω–µ –≤–æ—à–ª–∏</span>
      </div>
      <div id="authControls">
        <input id="authUser" placeholder="–ª–æ–≥–∏–Ω" style="width:140px">
        <input id="authPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å" style="width:140px">
        <button class="btn btn-primary" onclick="doLogin()">–í–æ–π—Ç–∏</button>
      </div>
      <div id="authLogout" class="hidden">
        <button class="btn" onclick="doLogout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä -->
    <div class="card">
      <h3>–§–∏–ª—å—Ç—Ä</h3>
      <div id="filterTree" class="row"></div>
      <div class="row">
        <div class="col"><label>–¶–µ–Ω–∞, $</label><div class="row"><input type="number" id="fPriceMin" placeholder="–æ—Ç"><input type="number" id="fPriceMax" placeholder="–¥–æ"></div></div>
        <div class="col"><label>–ö–æ–º–Ω–∞—Ç—ã</label><div class="row"><input type="number" id="fRoomsMin" placeholder="–æ—Ç"><input type="number" id="fRoomsMax" placeholder="–¥–æ"></div></div>
        <div class="col"><label>–ü–ª–æ—â–∞–¥—å, –º¬≤</label><div class="row"><input type="number" id="fAreaMin" placeholder="–æ—Ç"><input type="number" id="fAreaMax" placeholder="–¥–æ"></div></div>
      </div>
      <div class="row">
        <div class="col"><label>–ü–æ –∫–∞—Ä—Ç–µ: —Ä–∞–¥–∏—É—Å (–º)</label><input type="number" id="fRadius" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 1000"></div>
        <div class="col note">–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä –∫—Ä—É–≥–∞</div>
        <div class="col"><label>&nbsp;</label><label class="pill"><input type="checkbox" id="onlyAfterApply" checked> –ú–µ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª</label></div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="mapMain" class="card"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="card">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ -->
    <div id="adminWrap" class="card hidden">
      <h3>–ê–¥–º–∏–Ω–∫–∞</h3>

      <div class="card">
        <h4>–î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
        <div class="row">
          <button class="btn" onclick="addRootNode()">+ –ö–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª</button>
          <span class="note">–õ—é–±–∞—è –≥–ª—É–±–∏–Ω–∞: –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Üí –ê—Ä–µ–Ω–¥–∞ ‚Üí –ü–æ—Å—É—Ç–æ—á–Ω–æ ‚Üí ...</span>
        </div>
        <div id="treeAdmin" class="tree"></div>
      </div>

      <div class="card">
        <h4>–î–æ–±–∞–≤–∏—Ç—å / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç</h4>
        <div class="row">
          <div class="col"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label><input id="aTitle"></div>
          <div class="col"><label>–¶–µ–Ω–∞, $ *</label><input id="aPrice" type="number"></div>
          <div class="col"><label>–ö–æ–º–Ω–∞—Ç—ã</label><input id="aRooms" type="number"></div>
          <div class="col"><label>–ü–ª–æ—â–∞–¥—å, –º¬≤</label><input id="aArea" type="number"></div>
        </div>

        <div class="row">
          <div class="col">
            <label>–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="aPrimaryNode"></select>
          </div>
          <div class="col" style="flex:1">
            <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
            <div id="aNodeChecks" class="row" style="gap:6px"></div>
          </div>
        </div>

        <div class="row">
          <div class="col"><label>Lat</label><input id="aLat" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É –Ω–∏–∂–µ"></div>
          <div class="col"><label>Lng</label><input id="aLng" placeholder="–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É –Ω–∏–∂–µ"></div>
        </div>
        <div id="adminMap" class="card"></div>

        <div class="row">
          <div class="col" style="flex:1">
            <label>–§–æ—Ç–æ</label>
            <input type="file" id="aPhotos" multiple accept="image/*" />
            <div id="aGallery" class="thumbs"></div>
          </div>
        </div>

        <div class="row">
          <button class="btn btn-primary" onclick="saveObject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="resetForm()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="note">–ü–æ–ª—è —Å * –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã</div>
      </div>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== helpers & storage
    const $ = id => document.getElementById(id);
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);

    const LS_OBJECTS = "objects_v20";
    const LS_TREE    = "tree_v20";
    const LS_AUTH    = "auth_v20";

    let objects = JSON.parse(localStorage.getItem(LS_OBJECTS) || "[]");
    let tree    = JSON.parse(localStorage.getItem(LS_TREE) || "[]");
    function persist(){ localStorage.setItem(LS_OBJECTS, JSON.stringify(objects)); }
    function persistTree(){ localStorage.setItem(LS_TREE, JSON.stringify(tree)); }

    // ===== auth
    function isAuthed(){ return localStorage.getItem(LS_AUTH)==="true"; }
    function doLogin(){
      const u = $("authUser").value.trim();
      const p = $("authPass").value.trim();
      if(u==="admin" && p==="1234"){
        localStorage.setItem(LS_AUTH,"true");
        applyAuthUI();
      }else{
        alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å (admin / 1234)");
      }
    }
    function doLogout(){
      localStorage.removeItem(LS_AUTH);
      applyAuthUI();
    }
    function applyAuthUI(){
      const authed = isAuthed();
      $("authStatus").textContent = authed ? "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ admin" : "–í—ã –Ω–µ –≤–æ—à–ª–∏";
      $("authControls").classList.toggle("hidden", authed);
      $("authLogout").classList.toggle("hidden", !authed);
      $("adminWrap").classList.toggle("hidden", !authed);

      // üëá —Ñ–∏–∫—Å: –∫–∞—Ä—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è
      if(authed){
        setTimeout(()=> adminMap.invalidateSize(), 300);
      }
    }

    // ===== map
    const TILE = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?cb=2025-09-05";
    const map = L.map("mapMain").setView([41.3111,69.2797], 12);
    L.tileLayer(TILE, { attribution:"¬© OpenStreetMap" }).addTo(map);
    let markersLayer = L.layerGroup().addTo(map);
    let filterCenter = null, filterCircle = null;

    map.on("click", e=>{
      filterCenter = e.latlng;
      const r = +($("fRadius").value||0);
      if(r>0) drawFilterCircle(filterCenter, r);
    });
    function drawFilterCircle(center, r){
      if(filterCircle){ filterCircle.setLatLng(center).setRadius(r); }
      else filterCircle = L.circle(center, { radius:r, color:"#2563eb" }).addTo(map);
    }

    // admin map
    const adminMap = L.map("adminMap").setView([41.3111,69.2797], 12);
    L.tileLayer(TILE, { attribution:"¬© OpenStreetMap" }).addTo(adminMap);
    let adminMarker = null;
    adminMap.on("click", e=>{
      $("aLat").value = e.latlng.lat.toFixed(6);
      $("aLng").value = e.latlng.lng.toFixed(6);
      if(adminMarker) adminMarker.setLatLng(e.latlng);
      else adminMarker = L.marker(e.latlng).addTo(adminMap);
    });

    // ===== tree
    function addRootNode(){
      const label = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —É–∑–ª–∞:");
      if(!label) return;
      tree.push({ id:uid(), label, icon:"", children:[] });
      persistTree(); renderTreeAdmin(); renderFilterTree(); fillAdminNodeSelectors();
    }
    function addChildNode(parentId){
      const label = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
      if(!label) return;
      const p = findNodeById(parentId);
      if(!p.children) p.children=[];
      p.children.push({ id:uid(), label, icon:"", children:[] });
      persistTree(); renderTreeAdmin(); renderFilterTree(); fillAdminNodeSelectors();
    }
    function removeNode(nodeId){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –∏ –ø–æ—Ç–æ–º–∫–æ–≤?")) return;
      removeNodeRecursive(tree, nodeId);
      persistTree(); renderTreeAdmin(); renderFilterTree(); fillAdminNodeSelectors();
    }
    function removeNodeRecursive(list, id){
      for(let i=0;i<list.length;i++){
        if(list[i].id===id){ list.splice(i,1); return true; }
        if(list[i].children && removeNodeRecursive(list[i].children,id)) return true;
      }
      return false;
    }
    function findNodeById(id){
      let found=null;
      (function walk(arr){
        if(!arr) return;
        for(const n of arr){
          if(n.id===id){ found=n; return; }
          if(n.children) walk(n.children);
          if(found) return;
        }
      })(tree);
      return found;
    }
    function flattenNodes(arr=tree, out=[]){
      for(const n of arr){
        out.push(n);
        if(n.children?.length) flattenNodes(n.children, out);
      }
      return out;
    }
    function getNodePathLabel(id){
      const path=[];
      let target=null;
      (function walk(arr,stack){
        for(const n of arr){
          const st=[...stack, n];
          if(n.id===id){ target=st; return; }
          if(n.children?.length) walk(n.children, st);
          if(target) return;
        }
      })(tree,[]);
      return target ? target.map(n=> (n.icon||"") + n.label).join(" / ") : "";
    }
    function renderTreeAdmin(){
      const wrap = $("treeAdmin"); wrap.innerHTML="";
      function renderList(arr){
        const ul = document.createElement("ul");
        for(const n of arr){
          const li = document.createElement("li");
          const row = document.createElement("div");
          row.className="node";
          const icon = document.createElement("input");
          icon.className="icon"; icon.maxLength=2; icon.value = n.icon||"";
          icon.oninput=()=>{ n.icon=icon.value; persistTree(); renderFilterTree(); fillAdminNodeSelectors(); };
          const label = document.createElement("input");
          label.type="text"; label.value=n.label;
          label.oninput=()=>{ n.label=label.value; persistTree(); renderFilterTree(); fillAdminNodeSelectors(); };
          const bAdd = document.createElement("button"); bAdd.className="btn"; bAdd.textContent="+ –ü–æ–¥—É–∑–µ–ª";
          bAdd.onclick=()=> addChildNode(n.id);
          const bDel = document.createElement("button"); bDel.className="btn btn-danger"; bDel.textContent="–£–¥–∞–ª–∏—Ç—å";
          bDel.onclick=()=> removeNode(n.id);
          row.append(icon,label,bAdd,bDel);
          li.append(row);
          if(n.children?.length) li.append(renderList(n.children));
          ul.append(li);
        }
        return ul;
      }
      wrap.append(renderList(tree));
    }

    // ===== —Ñ–∏–ª—å—Ç—Ä (select –≤–º–µ—Å—Ç–æ –≥–∞–ª–æ—á–µ–∫)
    function renderFilterTree(){
      const box = $("filterTree"); 
      box.innerHTML = "";

      function buildSelect(levelNodes, level=0){
        const sel = document.createElement("select");
        sel.innerHTML = `<option value="">‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî</option>`;
        levelNodes.forEach(n=>{
          const opt = document.createElement("option");
          opt.value = n.id;
          opt.textContent = (n.icon||"") + n.label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", ()=>{
          // —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã –Ω–∏–∂–µ
          while(sel.nextSibling) sel.parentNode.removeChild(sel.nextSibling);

          const node = findNodeById(sel.value);
          if(node && node.children?.length){
            sel.parentNode.appendChild(buildSelect(node.children, level+1));
          }
        });

        return sel;
      }

      if(tree.length){
        box.appendChild(buildSelect(tree, 0));
      }
    }

    // ===== —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –≤ –∞–¥–º–∏–Ω–∫–µ
    function fillAdminNodeSelectors(){
      const flat = flattenNodes();
      $("aPrimaryNode").innerHTML = `<option value="">‚Äî</option>` + flat.map(n=>`<option value="${n.id}">${(n.icon||"")}${getNodePathLabel(n.id)||n.label}</option>`).join("");
      const checks = flat.map(n=>`<label class="pill"><input type="checkbox" class="aNodeExtra" value="${n.id}"> ${(n.icon||"")}${n.label}</label>`).join("");
      $("aNodeChecks").innerHTML = checks;
    }

    // ===== photos
    let photoFiles = [];
    $("aPhotos").addEventListener("change", ()=>{
      const files = [...$("aPhotos").files];
      files.forEach(f=>{
        const fr = new FileReader();
        fr.onload = (e)=>{
          photoFiles.push(e.target.result);
          const d = document.createElement("div");
          d.className="thumb";
          d.innerHTML=`<img src="${e.target.result}"><button class="del">√ó</button>`;
          $("aGallery").appendChild(d);
        };
        fr.readAsDataURL(f);
      });
      $("aPhotos").value="";
    });
    $("aGallery").addEventListener("click",(e)=>{
      const btn = e.target.closest(".del"); if(!btn) return;
      const idx = [...$("aGallery").children].indexOf(btn.parentElement);
      if(idx>-1) photoFiles.splice(idx,1);
      btn.parentElement.remove();
    });
  </script>
  <script>
    // ===== CRUD –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    function saveObject(){
      const title = $("aTitle").value.trim();
      const price = +$("aPrice").value;
      if(!title || !price){ alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ü–µ–Ω—É"); return; }

      const nodeId = $("aPrimaryNode").value;
      const extras = [...document.querySelectorAll(".aNodeExtra:checked")].map(c=>c.value);

      const obj = {
        id: uid(),
        title,
        price,
        rooms: +$("aRooms").value || null,
        area: +$("aArea").value || null,
        lat: $("aLat").value ? +$("aLat").value : null,
        lng: $("aLng").value ? +$("aLng").value : null,
        nodeId,
        extras,
        photos:[...photoFiles]
      };
      objects.push(obj);
      persist();
      resetForm();
      renderResults();
    }

    function resetForm(){
      $("aTitle").value="";
      $("aPrice").value="";
      $("aRooms").value="";
      $("aArea").value="";
      $("aLat").value="";
      $("aLng").value="";
      $("aPrimaryNode").value="";
      document.querySelectorAll(".aNodeExtra").forEach(c=>c.checked=false);
      $("aGallery").innerHTML="";
      photoFiles=[];
    }

    // ===== —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    function applyFilters(){
      renderResults();
    }
    function resetFilters(){
      $("fPriceMin").value="";
      $("fPriceMax").value="";
      $("fRoomsMin").value="";
      $("fRoomsMax").value="";
      $("fAreaMin").value="";
      $("fAreaMax").value="";
      $("fRadius").value="";
      $("filterTree").querySelectorAll("select").forEach(s=>s.selectedIndex=0);
      filterCenter=null; if(filterCircle){ map.removeLayer(filterCircle); filterCircle=null; }
      renderResults();
    }

    // ===== —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∏ –∫–∞—Ä—Ç—ã
    function renderResults(){
      const box=$("results"); box.innerHTML="";
      markersLayer.clearLayers();
      let list=objects;

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ
      const pmin=+$("fPriceMin").value||0, pmax=+$("fPriceMax").value||Infinity;
      list=list.filter(o=>o.price>=pmin && o.price<=pmax);

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º
      const rmin=+$("fRoomsMin").value||0, rmax=+$("fRoomsMax").value||Infinity;
      list=list.filter(o=>!o.rooms || (o.rooms>=rmin && o.rooms<=rmax));

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–ª–æ—â–∞–¥–∏
      const amin=+$("fAreaMin").value||0, amax=+$("fAreaMax").value||Infinity;
      list=list.filter(o=>!o.area || (o.area>=amin && o.area<=amax));

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–µ—Ä–µ–≤—É (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É select)
      const selects=$("filterTree").querySelectorAll("select");
      let lastSel=null;
      selects.forEach(s=>{ if(s.value) lastSel=s; });
      if(lastSel){
        const nodeId=lastSel.value;
        list=list.filter(o=>o.nodeId===nodeId || o.extras.includes(nodeId));
      }

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–¥–∏—É—Å—É
      const r=+$("fRadius").value||0;
      if(r>0 && filterCenter){
        list=list.filter(o=>{
          if(o.lat && o.lng){
            const d=map.distance(filterCenter,{lat:o.lat,lng:o.lng});
            return d<=r;
          }
          return false;
        });
      }

      list.forEach(o=>{
        const card=document.createElement("div");
        card.className="item";
        card.innerHTML=`
          <div class="hdr">
            <div><b>${o.title}</b></div>
            <div class="price">${o.price}$</div>
          </div>
          <div class="note">${getNodePathLabel(o.nodeId)}</div>
          ${o.photos?.length ? `<div class="gallery">${o.photos.slice(0,3).map(p=>`<img src="${p}">`).join("")}</div>` : ""}
          <div class="row">
            <button class="btn" onclick="openModal('${o.id}')">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-danger" onclick="deleteObj('${o.id}')">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        box.appendChild(card);

        if(o.lat && o.lng){
          const m=L.marker([o.lat,o.lng]).addTo(markersLayer);
          m.bindPopup(`<b>${o.title}</b><br>${o.price}$`);
        }
      });
    }

    // ===== –º–æ–¥–∞–ª–∫–∞
    function openModal(id){
      const o=objects.find(x=>x.id===id); if(!o) return;
      const mb=$("modalBody");
      mb.innerHTML=`
        <h2>${o.title}</h2>
        <p><b>–¶–µ–Ω–∞:</b> ${o.price}$</p>
        <p><b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> ${getNodePathLabel(o.nodeId)}</p>
        ${o.rooms? `<p><b>–ö–æ–º–Ω–∞—Ç—ã:</b> ${o.rooms}</p>`:""}
        ${o.area? `<p><b>–ü–ª–æ—â–∞–¥—å:</b> ${o.area} –º¬≤</p>`:""}
        ${o.photos?.length ? `
          <div class="slider">
            <div class="slides" id="slides">${o.photos.map(p=>`<img src="${p}">`).join("")}</div>
            <button class="prev" onclick="slideMove(-1)">‚Äπ</button>
            <button class="next" onclick="slideMove(1)">‚Ä∫</button>
          </div>` : ""}
      `;
      $("modal").style.display="flex";
      slideIndex=0; updateSlide();
    }
    function closeModal(){ $("modal").style.display="none"; }
    let slideIndex=0;
    function slideMove(d){ slideIndex+=d; updateSlide(); }
    function updateSlide(){
      const slides=$("slides"); if(!slides) return;
      const total=slides.children.length;
      if(slideIndex<0) slideIndex=total-1;
      if(slideIndex>=total) slideIndex=0;
      slides.style.transform=`translateX(${-slideIndex*100}%)`;
    }

    // ===== delete
    function deleteObj(id){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?")) return;
      objects=objects.filter(o=>o.id!==id);
      persist(); renderResults();
    }

    // ===== init
    renderTreeAdmin();
    renderFilterTree();
    fillAdminNodeSelectors();
    renderResults();
    applyAuthUI();
  </script>
</body>
</html>
