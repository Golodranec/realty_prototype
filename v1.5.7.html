<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Каталог недвижимости — v1.5.7</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <style>
    :root {
      --bg:#f6f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#2563eb;
      --bad:#dc2626;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1160px;margin:0 auto;padding:16px}
    h1{font-size:26px;margin:8px 0 4px}
    .sub{color:var(--muted);margin:0 0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,button{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;background:#fff;color:var(--text)}
    .btn{cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
    .btn-danger{background:#fff;color:var(--bad);border-color:#fecaca}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);margin-right:4px}
    .section-title{font-weight:700;margin:8px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px}
    .chip .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;background:#fff;padding:0 6px}
    #map{height:400px;margin-top:10px;border-radius:12px}
    .gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .gallery img{width:90px;height:70px;object-fit:cover;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Каталог недвижимости</h1>
    <p class="sub">Версия 1.5.7 — фильтры, карта и фото-загрузка</p>

    <!-- Фильтры -->
    <div class="card">
      <h3>Фильтр</h3>
      <div class="row">
        <div>
          <label>Категория</label>
          <select id="filterCategory">
            <option value="">Любая</option>
          </select>
        </div>
        <div>
          <label>Статус</label>
          <select id="filterStatus">
            <option value="">Любой</option>
          </select>
        </div>
        <div>
          <label>Район</label>
          <select id="filterDistrict">
            <option value="">Любой</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Цена (от)</label>
          <input type="number" id="filterPriceMin" placeholder="мин" />
        </div>
        <div>
          <label>Цена (до)</label>
          <input type="number" id="filterPriceMax" placeholder="макс" />
        </div>
        <div>
          <label>Комнат (от)</label>
          <input type="number" id="filterRoomsMin" />
        </div>
        <div>
          <label>Комнат (до)</label>
          <input type="number" id="filterRoomsMax" />
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        <button class="btn" onclick="resetFilters()">Сбросить</button>
      </div>
    </div>

    <!-- Карта -->
    <div id="map"></div>

    <!-- Список объектов -->
    <div class="card">
      <h3>Результаты</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- Админка -->
    <div class="card" id="adminPanel">
      <h3>Админка</h3>
      <div class="row">
        <div>
          <label>Категория</label>
          <select id="addCategory"></select>
        </div>
        <div>
          <label>Статус</label>
          <select id="addStatus"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Район</label>
          <select id="addDistrict"></select>
        </div>
        <div>
          <label>Заголовок</label>
          <input id="addTitle" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Цена</label>
          <input type="number" id="addPrice" />
        </div>
        <div>
          <label>Комнаты</label>
          <input type="number" id="addRooms" />
        </div>
        <div>
          <label>Площадь (м²)</label>
          <input type="number" id="addArea" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Фото</label>
          <input type="file" id="addPhotos" multiple />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Координаты (lat, lng)</label>
          <input id="addLat" placeholder="широта" />
          <input id="addLng" placeholder="долгота" />
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="addObject()">Добавить объект</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // --- Данные ---
    let objects = JSON.parse(localStorage.getItem("objects")||"[]");
    let categories = ["Квартира","Дом","Земля"];
    let statuses = ["Аренда","Продажа"];
    let districts = ["Юнусабад","Чиланзар","Сергели"];

    // --- Карта ---
    const map = L.map("map").setView([41.3111, 69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:"© OpenStreetMap"
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function renderMarkers(list){
      markersLayer.clearLayers();
      list.forEach(obj=>{
        if(obj.lat && obj.lng){
          const marker = L.marker([obj.lat,obj.lng]).addTo(markersLayer);
          marker.bindPopup(`<b>${obj.title}</b><br>${obj.price||""} $<br>${obj.rooms||""} комн<br><img src="${obj.photos?.[0]||""}" style="width:100px;height:80px;object-fit:cover">`);
        }
      });
    }

    // --- Рендер ---
    function renderFilters(){
      const catSel=document.getElementById("filterCategory");
      categories.forEach(c=>catSel.insertAdjacentHTML("beforeend",`<option>${c}</option>`));
      const statSel=document.getElementById("filterStatus");
      statuses.forEach(s=>statSel.insertAdjacentHTML("beforeend",`<option>${s}</option>`));
      const distSel=document.getElementById("filterDistrict");
      districts.forEach(d=>distSel.insertAdjacentHTML("beforeend",`<option>${d}</option>`));
      // админка
      const addCat=document.getElementById("addCategory");
      categories.forEach(c=>addCat.insertAdjacentHTML("beforeend",`<option>${c}</option>`));
      const addStat=document.getElementById("addStatus");
      statuses.forEach(s=>addStat.insertAdjacentHTML("beforeend",`<option>${s}</option>`));
      const addDist=document.getElementById("addDistrict");
      districts.forEach(d=>addDist.insertAdjacentHTML("beforeend",`<option>${d}</option>`));
    }

    function renderResults(list){
      const res=document.getElementById("results");
      res.innerHTML="";
      list.forEach((o,i)=>{
        const photosHtml=o.photos?.map(p=>`<img src="${p}" />`).join("")||"";
        res.insertAdjacentHTML("beforeend",`
          <div class="item">
            <div><b>${o.title}</b> (${o.category}, ${o.status}, ${o.district})</div>
            <div>${o.price||""} $ • ${o.rooms||""} комн • ${o.area||""} м²</div>
            <div class="gallery">${photosHtml}</div>
          </div>
        `);
      });
      renderMarkers(list);
    }

    // --- Фильтр ---
    function applyFilters(){
      let fcat=document.getElementById("filterCategory").value;
      let fstat=document.getElementById("filterStatus").value;
      let fdist=document.getElementById("filterDistrict").value;
      let pmin=+document.getElementById("filterPriceMin").value||0;
      let pmax=+document.getElementById("filterPriceMax").value||Infinity;
      let rmin=+document.getElementById("filterRoomsMin").value||0;
      let rmax=+document.getElementById("filterRoomsMax").value||Infinity;

      const filtered=objects.filter(o=>
        (!fcat||o.category===fcat)&&
        (!fstat||o.status===fstat)&&
        (!fdist||o.district===fdist)&&
        (!o.price||(o.price>=pmin&&o.price<=pmax))&&
        (!o.rooms||(o.rooms>=rmin&&o.rooms<=rmax))
      );
      renderResults(filtered);
    }
    function resetFilters(){
      document.querySelectorAll("#filterCategory,#filterStatus,#filterDistrict,#filterPriceMin,#filterPriceMax,#filterRoomsMin,#filterRoomsMax").forEach(el=>el.value="");
      renderResults(objects);
    }

    // --- Добавление ---
    function addObject(){
      const title=document.getElementById("addTitle").value.trim();
      const category=document.getElementById("addCategory").value;
      const status=document.getElementById("addStatus").value;
      const district=document.getElementById("addDistrict").value;
      if(!title||!category||!status||!district){
        alert("Заполни обязательные поля: заголовок, категория, статус, район");
        return;
      }
      const price=+document.getElementById("addPrice").value||null;
      const rooms=+document.getElementById("addRooms").value||null;
      const area=+document.getElementById("addArea").value||null;
      const lat=parseFloat(document.getElementById("addLat").value)||null;
      const lng=parseFloat(document.getElementById("addLng").value)||null;

      const files=document.getElementById("addPhotos").files;
      let photos=[];
      if(files.length){
        for(let f of files){
          const reader=new FileReader();
          reader.onload=e=>{
            photos.push(e.target.result);
            if(photos.length===files.length){
              saveObj();
            }
          };
          reader.readAsDataURL(f);
        }
      }else{
        saveObj();
      }

      function saveObj(){
        const obj={title,category,status,district,price,rooms,area,lat,lng,photos};
        objects.push(obj);
        localStorage.setItem("objects",JSON.stringify(objects));
        renderResults(objects);
      }
    }

    // --- Init ---
    renderFilters();
    renderResults(objects);
  </script>
</body>
</html>
