<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ‚Äî v1.7.0 (CMS-–¥–µ—Ä–µ–≤–æ)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#2563eb; --danger:#dc2626;
      --chip:#eef2ff; --chip-b:#e0e7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1{font-size:26px;margin:8px 0 6px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .sub{margin:0 0 14px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:14px;padding:14px;margin:10px 0;
      box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .col{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{font-size:14px;padding:10px;
      border:1px solid var(--border);border-radius:10px;
      background:#fff;color:var(--text)}
    input[type="number"]{width:140px}
    textarea{resize:vertical;min-height:80px}
    .btn{cursor:pointer;user-select:none}
    .btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
    .btn-ghost{background:#fff}
    .btn-danger{background:#fff;color:var(--danger);border-color:#fecaca}
    .hr{height:1px;background:var(--border);border:0;margin:12px 0}
    .section-title{font-weight:700;margin:6px 0 8px}
    .note{font-size:12px;color:var(--muted);margin-top:4px}

    /* Map */
    #mapMain{width:100%;height:440px;border-radius:12px;border:1px solid var(--border);margin-top:8px}
    #adminMap{height:200px;border:1px solid var(--border);border-radius:8px;margin-top:6px}

    /* Results */
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:12px}
    .hdr{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .price{font-weight:800}
    .gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .gallery img{width:100px;height:78px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .inline{display:flex;gap:8px;flex-wrap:wrap}

    /* Mode & chips */
    .mode{display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px}
    .chips-list{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-b);color:#3730a3;
      border-radius:999px;padding:2px 8px;font-size:12px}

    /* Login modal */
    #loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    #loginModal .card{max-width:360px;width:100%}

    /* CMS tree */
    .tree{padding:0;margin:0;list-style:none}
    .tree li{padding:6px 8px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}
    .node-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .node-label{font-weight:600}
    .node-kind{font-size:12px;color:#334155;background:#e2e8f0;border-radius:999px;padding:2px 8px}
    .node-actions button{padding:6px 10px}
    .children{margin-left:16px}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginModal">
    <div class="card">
      <h3>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h3>
      <div class="col"><label>–õ–æ–≥–∏–Ω</label><input id="loginUser"></div>
      <div class="col"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="loginPass"></div>
      <div class="row">
        <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
        <button class="btn" onclick="hideLogin()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ v1.7.0</h1>
    <p class="sub">–î–µ—Ä–µ–≤–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ. –§–∏–ª—å—Ç—Ä—ã –∏ —Ñ–æ—Ä–º–∞ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="mode">
      <span class="chip">CMS-–¥–µ—Ä–µ–≤–æ</span>
      <button class="btn btn-primary" style="margin-left:auto" onclick="showLogin()">–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ (—Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏–∑ –¥–µ—Ä–µ–≤–∞) -->
    <div class="card" id="filtersCard">
      <h3>–§–∏–ª—å—Ç—Ä</h3>
      <div class="row">
        <div class="col">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–∏–∑ –¥–µ—Ä–µ–≤–∞)</label>
          <select id="filterCategory"><option value="">–õ—é–±–∞—è</option></select>
        </div>
        <div class="col">
          <label>–°—Ç–∞—Ç—É—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)</label>
          <select id="filterStatus"><option value="">–õ—é–±–æ–π</option></select>
        </div>
        <div class="col">
          <label>–¶–µ–Ω–∞ –æ—Ç</label><input type="number" id="filterPriceMin">
        </div>
        <div class="col">
          <label>–¶–µ–Ω–∞ –¥–æ</label><input type="number" id="filterPriceMax">
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ö–ê–†–¢–ê -->
    <div id="mapMain"></div>
    <p class="note">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî —Å—Ç–∞–≤–∏—Ç —Ç–æ—á–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –±–ª–æ–∫ ¬´–û–±—ä–µ–∫—Ç—ã¬ª). Shift+–∫–ª–∏–∫ ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–æ—á–∫—É –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ –∞–¥–º–∏–Ω–∫–∏.</p>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
    <div class="card">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê: –û–ë–™–ï–ö–¢–´ -->
    <div class="card" id="adminObjects" style="display:none">
      <h3>–ê–¥–º–∏–Ω: –û–±—ä–µ–∫—Ç—ã</h3>
      <div class="row">
        <div class="col" style="flex:1"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="addTitle"></div>
        <div class="col"><label>–¶–µ–Ω–∞</label><input type="number" id="addPrice"></div>
        <div class="col"><label>–ö–æ–º–Ω–∞—Ç—ã</label><input type="number" id="addRooms"></div>
        <div class="col"><label>–ü–ª–æ—â–∞–¥—å –º¬≤</label><input type="number" id="addArea"></div>
      </div>
      <div class="row">
        <div class="col"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="addCategory"></select></div>
        <div class="col"><label>–°—Ç–∞—Ç—É—Å</label><select id="addStatus"></select></div>
        <div class="col"><label>Lat</label><input id="addLat" placeholder="41.3"></div>
        <div class="col"><label>Lng</label><input id="addLng" placeholder="69.2"></div>
      </div>
      <div id="adminMap"></div>
      <div class="row">
        <div class="col" style="flex:1">
          <label>–§–æ—Ç–æ</label>
          <input type="file" id="addPhotos" multiple>
          <div id="photoPreview" class="gallery"></div>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="saveObject()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="resetForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–î–ï–†–ï–í–û) -->
    <div class="card" id="adminConfig" style="display:none">
      <h3>–ê–¥–º–∏–Ω: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–µ—Ä–µ–≤–æ)</h3>
      <p class="note">–°–æ–∑–¥–∞–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ ¬´—Å—Ç–≤–æ–ª ‚Üí –≤–µ—Ç–∫–∏ ‚Üí –ª–∏—Å—Ç—å—è¬ª. –¢–∏–ø —É–∑–ª–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ. –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∏–ø—ã: <b>category</b> –∏ <b>status</b>.</p>
      <div class="row">
        <button class="btn" onclick="addRoot()">–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π –ø—É–Ω–∫—Ç</button>
        <button class="btn" onclick="expandAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>
        <button class="btn" onclick="collapseAll()">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>
      </div>
      <ul id="tree" class="tree"></ul>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï =====
    const TELEGRAM_USER = "smeksy"; // –ø–æ–º–µ–Ω—è–µ—à—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
    const adminUser="admin", adminPass="1234";
    let logged=false, editId=null;

    // ===== –•–†–ê–ù–ò–õ–ö–ò =====
    let objects = JSON.parse(localStorage.getItem("objects_v170")||"[]");
    let cmsTree = JSON.parse(localStorage.getItem("cms_tree_v170")||"null");

    // –ï—Å–ª–∏ –¥–µ—Ä–µ–≤–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –¥–µ—Ñ–æ–ª—Ç
    if(!cmsTree){
      cmsTree = [
        { id: uid(), label:"–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", kind:"group", children:[
          { id: uid(), label:"–ö–≤–∞—Ä—Ç–∏—Ä–∞", kind:"category", children:[
            { id: uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id: uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] },
            { id: uid(), label:"–û–±–º–µ–Ω",   kind:"status", children:[] }
          ]},
          { id: uid(), label:"–î–æ–º", kind:"category", children:[
            { id: uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id: uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] }
          ]},
          { id: uid(), label:"–ö–æ–º–º–µ—Ä—Ü–∏—è", kind:"category", children:[
            { id: uid(), label:"–ê—Ä–µ–Ω–¥–∞", kind:"status", children:[] },
            { id: uid(), label:"–ü—Ä–æ–¥–∞–∂–∞", kind:"status", children:[] }
          ]}
        ]}
      ];
      persistTree();
    }

    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
    function persistObjects(){ localStorage.setItem("objects_v170", JSON.stringify(objects)); }
    function persistTree(){ localStorage.setItem("cms_tree_v170", JSON.stringify(cmsTree)); }

    // ===== –ö–ê–†–¢–ê –û–°–ù–û–í–ù–ê–Ø =====
    const map = L.map("mapMain").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
    let markersLayer = L.layerGroup().addTo(map);
    let markerById = {};

    map.on("click", (e)=>{
      if(!logged) return;
      const {lat,lng}=e.latlng;
      document.getElementById("addLat").value = lat.toFixed(6);
      document.getElementById("addLng").value = lng.toFixed(6);
      placeAdminMarker(lat,lng,true);
    });

    // ===== –ú–ò–ù–ò-–ö–ê–†–¢–ê –ê–î–ú–ò–ù–ö–ò =====
    const adminMap = L.map("adminMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(adminMap);
    let adminMarker=null;
    adminMap.on("click",(e)=>{ const {lat,lng}=e.latlng; setAdminLatLng(lat,lng,true); });

    function setAdminLatLng(lat,lng,pan){
      document.getElementById("addLat").value=lat.toFixed(6);
      document.getElementById("addLng").value=lng.toFixed(6);
      placeAdminMarker(lat,lng,pan);
    }
    function placeAdminMarker(lat,lng,pan){
      if(adminMarker){ adminMarker.setLatLng([lat,lng]); }
      else { adminMarker=L.marker([lat,lng]).addTo(adminMap); }
      if(pan) adminMap.setView([lat,lng], 13);
    }

    // ===== –õ–û–ì–ò–ù =====
    function showLogin(){ document.getElementById("loginModal").style.display="flex"; }
    function hideLogin(){ document.getElementById("loginModal").style.display="none"; }
    function login(){
      const u=document.getElementById("loginUser").value.trim();
      const p=document.getElementById("loginPass").value.trim();
      if(u===adminUser && p===adminPass){
        logged=true; hideLogin();
        document.getElementById("adminObjects").style.display="";
        document.getElementById("adminConfig").style.display="";
      } else alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
    }

    // ===== –§–û–¢–û –ü–†–ï–í–¨–Æ =====
    const addPhotos=document.getElementById("addPhotos");
    addPhotos?.addEventListener("change", ()=>{
      const box=document.getElementById("photoPreview"); box.innerHTML="";
      [...addPhotos.files].forEach((f,i)=>{
        const r=new FileReader();
        r.onload=e=>{
          const img=document.createElement("img");
          img.src=e.target.result; box.appendChild(img);
        };
        r.readAsDataURL(f);
      });
    });

    // ===== –†–ï–ù–î–ï–† –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò –ú–ê–†–ö–ï–†–û–í =====
    function renderResults(list){
      const res=document.getElementById("results"); res.innerHTML="";
      markersLayer.clearLayers(); markerById={};
      list.forEach(o=>{
        const photos=(o.photos||[]).map(p=>`<img src="${p}">`).join("");
        const url = location.origin + location.pathname + "?id=" + o.id;
        res.insertAdjacentHTML("beforeend",`
          <div class="item" data-id="${o.id}">
            <div class="hdr"><b>${o.title}</b><span class="price">${o.price?o.price+" $":""}</span></div>
            <div>${o.categoryLabel||"-"} ‚Ä¢ ${o.statusLabel||"-"}</div>
            <div>${o.rooms||"-"} –∫–æ–º–Ω ‚Ä¢ ${o.area||"-"} –º¬≤</div>
            <div class="gallery">${photos}</div>
            <div class="inline">
              <a target="_blank" href="https://t.me/${TELEGRAM_USER}?text=${encodeURIComponent("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: "+url)}">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
              <button class="btn" onclick="editObject('${o.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-danger" onclick="deleteObject('${o.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `);
        if(o.lat!=null && o.lng!=null){
          const m=L.marker([o.lat,o.lng]).addTo(markersLayer);
          m.bindPopup(`<b>${o.title}</b><br>${o.price?o.price+" $":""}<br>${o.categoryLabel||""}, ${o.statusLabel||""}`);
          markerById[o.id]=m;
        }
      });
    }
    // ===== CMS-–î–ï–†–ï–í–û: –£—Ç–∏–ª–∏—Ç—ã =====
    const KINDS = ["group","category","status"]; // –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–∏
    function findNodeById(list,id){
      for(const n of list){
        if(n.id===id) return n;
        const f=findNodeById(n.children||[],id);
        if(f) return f;
      }
      return null;
    }
    function removeNodeById(list,id){
      for(let i=0;i<list.length;i++){
        if(list[i].id===id){ list.splice(i,1); return true; }
        if(removeNodeById(list[i].children||[],id)) return true;
      }
      return false;
    }

    // ===== CMS-–î–ï–†–ï–í–û: –†–µ–Ω–¥–µ—Ä =====
    function renderTreeUI(){
      const root=document.getElementById("tree");
      root.innerHTML="";
      cmsTree.forEach(n=> root.appendChild(renderNode(n,0)));
      persistTree();
      rebuildDynamicUI(); // –∫–∞–∫ —Ç–æ–ª—å–∫–æ –¥–µ—Ä–µ–≤–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å ‚Äî –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ñ–æ—Ä–º—ã
    }

    function renderNode(node,depth){
      const li=document.createElement("li");
      const row=document.createElement("div"); row.className="node-row";
      const label=document.createElement("span"); label.className="node-label"; label.textContent=node.label;
      const kindSel=document.createElement("select");
      KINDS.forEach(k=>{
        const opt=document.createElement("option"); opt.value=k; opt.textContent=k;
        if(node.kind===k) opt.selected=true; kindSel.appendChild(opt);
      });
      kindSel.onchange=()=>{ node.kind=kindSel.value; persistTree(); rebuildDynamicUI(); };

      const actions=document.createElement("div"); actions.className="node-actions";
      const btnAdd=document.createElement("button"); btnAdd.className="btn"; btnAdd.textContent="+ –ü–æ–¥–≤–µ—Ç–∫–∞";
      const btnRename=document.createElement("button"); btnRename.className="btn"; btnRename.textContent="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å";
      const btnDel=document.createElement("button"); btnDel.className="btn btn-danger"; btnDel.textContent="–£–¥–∞–ª–∏—Ç—å";

      btnAdd.onclick=()=>{
        if(!node.children) node.children=[];
        node.children.push({id:uid(),label:"–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç",kind:"group",children:[]});
        renderTreeUI();
      };
      btnRename.onclick=()=>{
        const v=prompt("–ù–æ–≤–æ–µ –∏–º—è —É–∑–ª–∞:", node.label);
        if(v){ node.label=v.trim(); renderTreeUI(); }
      };
      btnDel.onclick=()=>{
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –∏ –≤—Å–µ –ø–æ–¥–≤–µ—Ç–∫–∏?")) return;
        removeNodeById(cmsTree,node.id); renderTreeUI();
      };

      row.appendChild(label);
      const tag=document.createElement("span"); tag.className="node-kind"; tag.textContent=node.kind;
      row.appendChild(tag);
      row.appendChild(kindSel);
      actions.appendChild(btnAdd); actions.appendChild(btnRename); actions.appendChild(btnDel);
      row.appendChild(actions);
      li.appendChild(row);

      // –¥–µ—Ç–∏
      const ul=document.createElement("ul"); ul.className="tree children";
      (node.children||[]).forEach(ch=> ul.appendChild(renderNode(ch,depth+1)));
      li.appendChild(ul);
      return li;
    }

    // –ö–Ω–æ–ø–∫–∏ –¥–µ—Ä–µ–≤–∞
    function addRoot(){
      cmsTree.push({id:uid(),label:"–ù–æ–≤—ã–π –∫–æ—Ä–µ–Ω—å",kind:"group",children:[]});
      renderTreeUI();
    }
    function expandAll(){ // —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –≤—Å—ë —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
      alert("–ó–¥–µ—Å—å –≤—Å—ë —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ. –í 1.7.1 —Å–¥–µ–ª–∞–µ–º —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —É–∑–ª–æ–≤.");
    }
    function collapseAll(){
      alert("–°–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É–∑–ª–æ–≤ –¥–æ–±–∞–≤–∏–º –≤ 1.7.1 (—á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å —Å–µ–π—á–∞—Å).");
    }

    // ===== –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –°–ü–ò–°–ö–ò –∏–∑ –¥–µ—Ä–µ–≤–∞ =====
    function getAllCategories(){
      const out=[];
      function walk(nodes){
        for(const n of nodes){
          if(n.kind==="category") out.push({id:n.id,label:n.label,node:n});
          if(n.children) walk(n.children);
        }
      }
      walk(cmsTree);
      return out;
    }
    function getStatusesForCategoryId(catId){
      const cat=findNodeById(cmsTree,catId);
      if(!cat) return [];
      const out=[];
      function collectStatuses(n){
        if(n.kind==="status") out.push({id:n.id,label:n.label});
        (n.children||[]).forEach(collectStatuses);
      }
      (cat.children||[]).forEach(collectStatuses);
      return out;
    }

    // –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–µ—Ä–µ–≤–æ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö –∏ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function rebuildDynamicUI(){
      // –§–∏–ª—å—Ç—Ä—ã
      const fc=document.getElementById("filterCategory");
      const fs=document.getElementById("filterStatus");
      const cats=getAllCategories();
      fc.innerHTML='<option value="">–õ—é–±–∞—è</option>';
      cats.forEach(c=> fc.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      fs.innerHTML='<option value="">–õ—é–±–æ–π</option>';

      fc.onchange=()=>{
        const sts=getStatusesForCategoryId(fc.value);
        fs.innerHTML='<option value="">–õ—é–±–æ–π</option>';
        sts.forEach(s=> fs.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      };

      // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      const ac=document.getElementById("addCategory");
      const as=document.getElementById("addStatus");
      ac.innerHTML=""; cats.forEach(c=> ac.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      const initCat=ac.value||cats[0]?.id||"";
      fillAddStatus(initCat);

      ac.onchange=()=> fillAddStatus(ac.value);

      function fillAddStatus(catId){
        const sts=getStatusesForCategoryId(catId);
        as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      }
    }

    // ===== CRUD –û–ë–™–ï–ö–¢–û–í =====
    function saveObject(){
      const title=document.getElementById("addTitle").value.trim();
      if(!title) return alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫");
      const catId=document.getElementById("addCategory").value;
      const catObj=getAllCategories().find(c=>c.id===catId);
      const status=document.getElementById("addStatus").value;
      const price=+document.getElementById("addPrice").value||null;
      const rooms=+document.getElementById("addRooms").value||null;
      const area=+document.getElementById("addArea").value||null;
      const lat=parseFloat(document.getElementById("addLat").value)||null;
      const lng=parseFloat(document.getElementById("addLng").value)||null;

      const photos=[];
      document.querySelectorAll("#photoPreview img").forEach(img=> photos.push(img.src));

      const obj={
        id: editId || uid(),
        title, price, rooms, area, lat, lng,
        categoryId: catId,
        categoryLabel: catObj?.label || "",
        statusLabel: status,
        photos
      };

      if(editId){
        const i=objects.findIndex(o=>o.id===editId);
        if(i>=0) objects[i]=obj;
        editId=null;
      } else {
        objects.push(obj);
      }
      persistObjects();
      renderResults(objects);
      resetForm();
    }

    function editObject(id){
      const o=objects.find(x=>x.id===id); if(!o) return;
      editId=id;
      document.getElementById("addTitle").value=o.title||"";
      document.getElementById("addPrice").value=o.price||"";
      document.getElementById("addRooms").value=o.rooms||"";
      document.getElementById("addArea").value=o.area||"";
      document.getElementById("addLat").value=o.lat||"";
      document.getElementById("addLng").value=o.lng||"";
      document.getElementById("addCategory").value=o.categoryId||"";
      // –ø–µ—Ä–µ–∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–∫—É—â–∏–π
      const sts=getStatusesForCategoryId(o.categoryId);
      const as=document.getElementById("addStatus");
      as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      as.value=o.statusLabel||"";

      const box=document.getElementById("photoPreview"); box.innerHTML="";
      (o.photos||[]).forEach(src=>{ const img=document.createElement("img"); img.src=src; box.appendChild(img); });

      if(o.lat!=null && o.lng!=null) placeAdminMarker(o.lat,o.lng,true);
      document.getElementById("adminObjects").scrollIntoView({behavior:"smooth"});
    }

    function deleteObject(id){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?")) return;
      objects=objects.filter(o=>o.id!==id);
      persistObjects(); renderResults(objects);
    }

    function resetForm(){
      document.querySelectorAll("#adminObjects input").forEach(el=> el.value="");
      document.getElementById("photoPreview").innerHTML="";
      editId=null;
    }

    // ===== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø =====
    function applyFilters(){
      const catId=document.getElementById("filterCategory").value;
      const status=document.getElementById("filterStatus").value;
      const pmin=+document.getElementById("filterPriceMin").value||0;
      const pmax=+document.getElementById("filterPriceMax").value||Infinity;

      let list=objects.slice();
      if(catId) list=list.filter(o=>o.categoryId===catId);
      if(status) list=list.filter(o=>o.statusLabel===status);
      list=list.filter(o=>{
        const p=o.price??0;
        return p>=pmin && p<=pmax;
      });
      renderResults(list);
    }

    function resetFilters(){
      document.getElementById("filterCategory").value="";
      document.getElementById("filterStatus").value="";
      document.getElementById("filterPriceMin").value="";
      document.getElementById("filterPriceMax").value="";
      renderResults(objects);
    }

    // ===== INIT =====
    renderResults(objects);
    renderTreeUI(); // —ç—Ç–æ –∂–µ –≤—ã–∑–æ–≤–µ—Ç rebuildDynamicUI()

    // deeplink ?id=...
    const qs=new URLSearchParams(location.search);
    const openId=qs.get("id");
    if(openId){
      const o=objects.find(x=>x.id===openId);
      if(o?.lat!=null && o?.lng!=null){ map.setView([o.lat,o.lng], 15); }
      requestAnimationFrame(()=> markerById[openId]?.openPopup());
    }
  </script>
</body>
</html>
