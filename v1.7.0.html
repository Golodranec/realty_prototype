<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Каталог недвижимости — v1.7.0 (CMS-дерево)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#2563eb; --danger:#dc2626;
      --chip:#eef2ff; --chip-b:#e0e7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1{font-size:26px;margin:8px 0 6px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .sub{margin:0 0 14px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:14px;padding:14px;margin:10px 0;
      box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .col{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{font-size:14px;padding:10px;
      border:1px solid var(--border);border-radius:10px;
      background:#fff;color:var(--text)}
    input[type="number"]{width:140px}
    textarea{resize:vertical;min-height:80px}
    .btn{cursor:pointer;user-select:none}
    .btn-primary{background:var(--accent);color:#fff;border-color:#1e40af}
    .btn-ghost{background:#fff}
    .btn-danger{background:#fff;color:var(--danger);border-color:#fecaca}
    .hr{height:1px;background:var(--border);border:0;margin:12px 0}
    .section-title{font-weight:700;margin:6px 0 8px}
    .note{font-size:12px;color:var(--muted);margin-top:4px}

    /* Map */
    #mapMain{width:100%;height:440px;border-radius:12px;border:1px solid var(--border);margin-top:8px}
    #adminMap{height:200px;border:1px solid var(--border);border-radius:8px;margin-top:6px}

    /* Results */
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:12px}
    .hdr{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .price{font-weight:800}
    .gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .gallery img{width:100px;height:78px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .inline{display:flex;gap:8px;flex-wrap:wrap}

    /* Mode & chips */
    .mode{display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px}
    .chips-list{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-b);color:#3730a3;
      border-radius:999px;padding:2px 8px;font-size:12px}

    /* Login modal */
    #loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    #loginModal .card{max-width:360px;width:100%}

    /* CMS tree */
    .tree{padding:0;margin:0;list-style:none}
    .tree li{padding:6px 8px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}
    .node-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .node-label{font-weight:600}
    .node-kind{font-size:12px;color:#334155;background:#e2e8f0;border-radius:999px;padding:2px 8px}
    .node-actions button{padding:6px 10px}
    .children{margin-left:16px}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginModal">
    <div class="card">
      <h3>Вход в админку</h3>
      <div class="col"><label>Логин</label><input id="loginUser"></div>
      <div class="col"><label>Пароль</label><input type="password" id="loginPass"></div>
      <div class="row">
        <button class="btn btn-primary" onclick="login()">Войти</button>
        <button class="btn" onclick="hideLogin()">Отмена</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>Каталог недвижимости v1.7.0</h1>
    <p class="sub">Дерево конфигурации: категории и статусы настраиваются в админке. Фильтры и форма — генерируются автоматически.</p>

    <!-- Верхняя панель -->
    <div class="mode">
      <span class="chip">CMS-дерево</span>
      <button class="btn btn-primary" style="margin-left:auto" onclick="showLogin()">Войти в админку</button>
    </div>

    <!-- ФИЛЬТРЫ (собираются из дерева) -->
    <div class="card" id="filtersCard">
      <h3>Фильтр</h3>
      <div class="row">
        <div class="col">
          <label>Категория (из дерева)</label>
          <select id="filterCategory"><option value="">Любая</option></select>
        </div>
        <div class="col">
          <label>Статус (зависит от выбранной категории)</label>
          <select id="filterStatus"><option value="">Любой</option></select>
        </div>
        <div class="col">
          <label>Цена от</label><input type="number" id="filterPriceMin">
        </div>
        <div class="col">
          <label>Цена до</label><input type="number" id="filterPriceMax">
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        <button class="btn" onclick="resetFilters()">Сбросить</button>
      </div>
    </div>

    <!-- КАРТА -->
    <div id="mapMain"></div>
    <p class="note">Клик по карте — ставит точку для нового объекта (если открыт блок «Объекты»). Shift+клик — перенести точку на мини-карте админки.</p>

    <!-- РЕЗУЛЬТАТЫ -->
    <div class="card">
      <h3>Результаты</h3>
      <div id="results" class="list"></div>
    </div>

    <!-- АДМИНКА: ОБЪЕКТЫ -->
    <div class="card" id="adminObjects" style="display:none">
      <h3>Админ: Объекты</h3>
      <div class="row">
        <div class="col" style="flex:1"><label>Заголовок</label><input id="addTitle"></div>
        <div class="col"><label>Цена</label><input type="number" id="addPrice"></div>
        <div class="col"><label>Комнаты</label><input type="number" id="addRooms"></div>
        <div class="col"><label>Площадь м²</label><input type="number" id="addArea"></div>
      </div>
      <div class="row">
        <div class="col"><label>Категория</label><select id="addCategory"></select></div>
        <div class="col"><label>Статус</label><select id="addStatus"></select></div>
        <div class="col"><label>Lat</label><input id="addLat" placeholder="41.3"></div>
        <div class="col"><label>Lng</label><input id="addLng" placeholder="69.2"></div>
      </div>
      <div id="adminMap"></div>
      <div class="row">
        <div class="col" style="flex:1">
          <label>Фото</label>
          <input type="file" id="addPhotos" multiple>
          <div id="photoPreview" class="gallery"></div>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="saveObject()">Сохранить</button>
        <button class="btn" onclick="resetForm()">Очистить</button>
      </div>
    </div>

    <!-- АДМИНКА: КОНФИГУРАЦИЯ (ДЕРЕВО) -->
    <div class="card" id="adminConfig" style="display:none">
      <h3>Админ: Конфигурация (дерево)</h3>
      <p class="note">Создавай структуру как «ствол → ветки → листья». Тип узла выбирается в выпадающем списке. Сейчас используются типы: <b>category</b> и <b>status</b>.</p>
      <div class="row">
        <button class="btn" onclick="addRoot()">Добавить корневой пункт</button>
        <button class="btn" onclick="expandAll()">Развернуть всё</button>
        <button class="btn" onclick="collapseAll()">Свернуть всё</button>
      </div>
      <ul id="tree" class="tree"></ul>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // ===== ГЛОБАЛЬНЫЕ =====
    const TELEGRAM_USER = "smeksy"; // поменяешь при желании
    const adminUser="admin", adminPass="1234";
    let logged=false, editId=null;

    // ===== ХРАНИЛКИ =====
    let objects = JSON.parse(localStorage.getItem("objects_v170")||"[]");
    let cmsTree = JSON.parse(localStorage.getItem("cms_tree_v170")||"null");

    // Если дерева нет — создадим дефолт
    if(!cmsTree){
      cmsTree = [
        { id: uid(), label:"Категории", kind:"group", children:[
          { id: uid(), label:"Квартира", kind:"category", children:[
            { id: uid(), label:"Аренда", kind:"status", children:[] },
            { id: uid(), label:"Продажа", kind:"status", children:[] },
            { id: uid(), label:"Обмен",   kind:"status", children:[] }
          ]},
          { id: uid(), label:"Дом", kind:"category", children:[
            { id: uid(), label:"Аренда", kind:"status", children:[] },
            { id: uid(), label:"Продажа", kind:"status", children:[] }
          ]},
          { id: uid(), label:"Коммерция", kind:"category", children:[
            { id: uid(), label:"Аренда", kind:"status", children:[] },
            { id: uid(), label:"Продажа", kind:"status", children:[] }
          ]}
        ]}
      ];
      persistTree();
    }

    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
    function persistObjects(){ localStorage.setItem("objects_v170", JSON.stringify(objects)); }
    function persistTree(){ localStorage.setItem("cms_tree_v170", JSON.stringify(cmsTree)); }

    // ===== КАРТА ОСНОВНАЯ =====
    const map = L.map("mapMain").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
    let markersLayer = L.layerGroup().addTo(map);
    let markerById = {};

    map.on("click", (e)=>{
      if(!logged) return;
      const {lat,lng}=e.latlng;
      document.getElementById("addLat").value = lat.toFixed(6);
      document.getElementById("addLng").value = lng.toFixed(6);
      placeAdminMarker(lat,lng,true);
    });

    // ===== МИНИ-КАРТА АДМИНКИ =====
    const adminMap = L.map("adminMap").setView([41.3111,69.2797], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(adminMap);
    let adminMarker=null;
    adminMap.on("click",(e)=>{ const {lat,lng}=e.latlng; setAdminLatLng(lat,lng,true); });

    function setAdminLatLng(lat,lng,pan){
      document.getElementById("addLat").value=lat.toFixed(6);
      document.getElementById("addLng").value=lng.toFixed(6);
      placeAdminMarker(lat,lng,pan);
    }
    function placeAdminMarker(lat,lng,pan){
      if(adminMarker){ adminMarker.setLatLng([lat,lng]); }
      else { adminMarker=L.marker([lat,lng]).addTo(adminMap); }
      if(pan) adminMap.setView([lat,lng], 13);
    }

    // ===== ЛОГИН =====
    function showLogin(){ document.getElementById("loginModal").style.display="flex"; }
    function hideLogin(){ document.getElementById("loginModal").style.display="none"; }
    function login(){
      const u=document.getElementById("loginUser").value.trim();
      const p=document.getElementById("loginPass").value.trim();
      if(u===adminUser && p===adminPass){
        logged=true; hideLogin();
        document.getElementById("adminObjects").style.display="";
        document.getElementById("adminConfig").style.display="";
      } else alert("Неверные данные");
    }

    // ===== ФОТО ПРЕВЬЮ =====
    const addPhotos=document.getElementById("addPhotos");
    addPhotos?.addEventListener("change", ()=>{
      const box=document.getElementById("photoPreview"); box.innerHTML="";
      [...addPhotos.files].forEach((f,i)=>{
        const r=new FileReader();
        r.onload=e=>{
          const img=document.createElement("img");
          img.src=e.target.result; box.appendChild(img);
        };
        r.readAsDataURL(f);
      });
    });

    // ===== РЕНДЕР РЕЗУЛЬТАТОВ И МАРКЕРОВ =====
    function renderResults(list){
      const res=document.getElementById("results"); res.innerHTML="";
      markersLayer.clearLayers(); markerById={};
      list.forEach(o=>{
        const photos=(o.photos||[]).map(p=>`<img src="${p}">`).join("");
        const url = location.origin + location.pathname + "?id=" + o.id;
        res.insertAdjacentHTML("beforeend",`
          <div class="item" data-id="${o.id}">
            <div class="hdr"><b>${o.title}</b><span class="price">${o.price?o.price+" $":""}</span></div>
            <div>${o.categoryLabel||"-"} • ${o.statusLabel||"-"}</div>
            <div>${o.rooms||"-"} комн • ${o.area||"-"} м²</div>
            <div class="gallery">${photos}</div>
            <div class="inline">
              <a target="_blank" href="https://t.me/${TELEGRAM_USER}?text=${encodeURIComponent("Здравствуйте, интересует объявление: "+url)}">Написать в Telegram</a>
              <button class="btn" onclick="editObject('${o.id}')">✏️ Редактировать</button>
              <button class="btn btn-danger" onclick="deleteObject('${o.id}')">🗑 Удалить</button>
            </div>
          </div>
        `);
        if(o.lat!=null && o.lng!=null){
          const m=L.marker([o.lat,o.lng]).addTo(markersLayer);
          m.bindPopup(`<b>${o.title}</b><br>${o.price?o.price+" $":""}<br>${o.categoryLabel||""}, ${o.statusLabel||""}`);
          markerById[o.id]=m;
        }
      });
    }
    // ===== CMS-ДЕРЕВО: Утилиты =====
    const KINDS = ["group","category","status"]; // пока используем эти
    function findNodeById(list,id){
      for(const n of list){
        if(n.id===id) return n;
        const f=findNodeById(n.children||[],id);
        if(f) return f;
      }
      return null;
    }
    function removeNodeById(list,id){
      for(let i=0;i<list.length;i++){
        if(list[i].id===id){ list.splice(i,1); return true; }
        if(removeNodeById(list[i].children||[],id)) return true;
      }
      return false;
    }

    // ===== CMS-ДЕРЕВО: Рендер =====
    function renderTreeUI(){
      const root=document.getElementById("tree");
      root.innerHTML="";
      cmsTree.forEach(n=> root.appendChild(renderNode(n,0)));
      persistTree();
      rebuildDynamicUI(); // как только дерево поменялось — пересобираем фильтры и формы
    }

    function renderNode(node,depth){
      const li=document.createElement("li");
      const row=document.createElement("div"); row.className="node-row";
      const label=document.createElement("span"); label.className="node-label"; label.textContent=node.label;
      const kindSel=document.createElement("select");
      KINDS.forEach(k=>{
        const opt=document.createElement("option"); opt.value=k; opt.textContent=k;
        if(node.kind===k) opt.selected=true; kindSel.appendChild(opt);
      });
      kindSel.onchange=()=>{ node.kind=kindSel.value; persistTree(); rebuildDynamicUI(); };

      const actions=document.createElement("div"); actions.className="node-actions";
      const btnAdd=document.createElement("button"); btnAdd.className="btn"; btnAdd.textContent="+ Подветка";
      const btnRename=document.createElement("button"); btnRename.className="btn"; btnRename.textContent="Переименовать";
      const btnDel=document.createElement("button"); btnDel.className="btn btn-danger"; btnDel.textContent="Удалить";

      btnAdd.onclick=()=>{
        if(!node.children) node.children=[];
        node.children.push({id:uid(),label:"Новый пункт",kind:"group",children:[]});
        renderTreeUI();
      };
      btnRename.onclick=()=>{
        const v=prompt("Новое имя узла:", node.label);
        if(v){ node.label=v.trim(); renderTreeUI(); }
      };
      btnDel.onclick=()=>{
        if(!confirm("Удалить узел и все подветки?")) return;
        removeNodeById(cmsTree,node.id); renderTreeUI();
      };

      row.appendChild(label);
      const tag=document.createElement("span"); tag.className="node-kind"; tag.textContent=node.kind;
      row.appendChild(tag);
      row.appendChild(kindSel);
      actions.appendChild(btnAdd); actions.appendChild(btnRename); actions.appendChild(btnDel);
      row.appendChild(actions);
      li.appendChild(row);

      // дети
      const ul=document.createElement("ul"); ul.className="tree children";
      (node.children||[]).forEach(ch=> ul.appendChild(renderNode(ch,depth+1)));
      li.appendChild(ul);
      return li;
    }

    // Кнопки дерева
    function addRoot(){
      cmsTree.push({id:uid(),label:"Новый корень",kind:"group",children:[]});
      renderTreeUI();
    }
    function expandAll(){ // сейчас простая структура — всё уже развернуто
      alert("Здесь всё уже развернуто. В 1.7.1 сделаем сворачивание/разворачивание узлов.");
    }
    function collapseAll(){
      alert("Свертывание узлов добавим в 1.7.1 (чтобы не усложнять сейчас).");
    }

    // ===== ДИНАМИЧЕСКИЕ СПИСКИ из дерева =====
    function getAllCategories(){
      const out=[];
      function walk(nodes){
        for(const n of nodes){
          if(n.kind==="category") out.push({id:n.id,label:n.label,node:n});
          if(n.children) walk(n.children);
        }
      }
      walk(cmsTree);
      return out;
    }
    function getStatusesForCategoryId(catId){
      const cat=findNodeById(cmsTree,catId);
      if(!cat) return [];
      const out=[];
      function collectStatuses(n){
        if(n.kind==="status") out.push({id:n.id,label:n.label});
        (n.children||[]).forEach(collectStatuses);
      }
      (cat.children||[]).forEach(collectStatuses);
      return out;
    }

    // применить дерево в фильтрах и форме добавления
    function rebuildDynamicUI(){
      // Фильтры
      const fc=document.getElementById("filterCategory");
      const fs=document.getElementById("filterStatus");
      const cats=getAllCategories();
      fc.innerHTML='<option value="">Любая</option>';
      cats.forEach(c=> fc.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      fs.innerHTML='<option value="">Любой</option>';

      fc.onchange=()=>{
        const sts=getStatusesForCategoryId(fc.value);
        fs.innerHTML='<option value="">Любой</option>';
        sts.forEach(s=> fs.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      };

      // Форма добавления
      const ac=document.getElementById("addCategory");
      const as=document.getElementById("addStatus");
      ac.innerHTML=""; cats.forEach(c=> ac.insertAdjacentHTML("beforeend",`<option value="${c.id}">${c.label}</option>`));
      const initCat=ac.value||cats[0]?.id||"";
      fillAddStatus(initCat);

      ac.onchange=()=> fillAddStatus(ac.value);

      function fillAddStatus(catId){
        const sts=getStatusesForCategoryId(catId);
        as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      }
    }

    // ===== CRUD ОБЪЕКТОВ =====
    function saveObject(){
      const title=document.getElementById("addTitle").value.trim();
      if(!title) return alert("Введите заголовок");
      const catId=document.getElementById("addCategory").value;
      const catObj=getAllCategories().find(c=>c.id===catId);
      const status=document.getElementById("addStatus").value;
      const price=+document.getElementById("addPrice").value||null;
      const rooms=+document.getElementById("addRooms").value||null;
      const area=+document.getElementById("addArea").value||null;
      const lat=parseFloat(document.getElementById("addLat").value)||null;
      const lng=parseFloat(document.getElementById("addLng").value)||null;

      const photos=[];
      document.querySelectorAll("#photoPreview img").forEach(img=> photos.push(img.src));

      const obj={
        id: editId || uid(),
        title, price, rooms, area, lat, lng,
        categoryId: catId,
        categoryLabel: catObj?.label || "",
        statusLabel: status,
        photos
      };

      if(editId){
        const i=objects.findIndex(o=>o.id===editId);
        if(i>=0) objects[i]=obj;
        editId=null;
      } else {
        objects.push(obj);
      }
      persistObjects();
      renderResults(objects);
      resetForm();
    }

    function editObject(id){
      const o=objects.find(x=>x.id===id); if(!o) return;
      editId=id;
      document.getElementById("addTitle").value=o.title||"";
      document.getElementById("addPrice").value=o.price||"";
      document.getElementById("addRooms").value=o.rooms||"";
      document.getElementById("addArea").value=o.area||"";
      document.getElementById("addLat").value=o.lat||"";
      document.getElementById("addLng").value=o.lng||"";
      document.getElementById("addCategory").value=o.categoryId||"";
      // перезаполнить статусы по категории и выбрать текущий
      const sts=getStatusesForCategoryId(o.categoryId);
      const as=document.getElementById("addStatus");
      as.innerHTML=""; sts.forEach(s=> as.insertAdjacentHTML("beforeend",`<option value="${s.label}">${s.label}</option>`));
      as.value=o.statusLabel||"";

      const box=document.getElementById("photoPreview"); box.innerHTML="";
      (o.photos||[]).forEach(src=>{ const img=document.createElement("img"); img.src=src; box.appendChild(img); });

      if(o.lat!=null && o.lng!=null) placeAdminMarker(o.lat,o.lng,true);
      document.getElementById("adminObjects").scrollIntoView({behavior:"smooth"});
    }

    function deleteObject(id){
      if(!confirm("Удалить объект?")) return;
      objects=objects.filter(o=>o.id!==id);
      persistObjects(); renderResults(objects);
    }

    function resetForm(){
      document.querySelectorAll("#adminObjects input").forEach(el=> el.value="");
      document.getElementById("photoPreview").innerHTML="";
      editId=null;
    }

    // ===== ФИЛЬТРАЦИЯ =====
    function applyFilters(){
      const catId=document.getElementById("filterCategory").value;
      const status=document.getElementById("filterStatus").value;
      const pmin=+document.getElementById("filterPriceMin").value||0;
      const pmax=+document.getElementById("filterPriceMax").value||Infinity;

      let list=objects.slice();
      if(catId) list=list.filter(o=>o.categoryId===catId);
      if(status) list=list.filter(o=>o.statusLabel===status);
      list=list.filter(o=>{
        const p=o.price??0;
        return p>=pmin && p<=pmax;
      });
      renderResults(list);
    }

    function resetFilters(){
      document.getElementById("filterCategory").value="";
      document.getElementById("filterStatus").value="";
      document.getElementById("filterPriceMin").value="";
      document.getElementById("filterPriceMax").value="";
      renderResults(objects);
    }

    // ===== INIT =====
    renderResults(objects);
    renderTreeUI(); // это же вызовет rebuildDynamicUI()

    // deeplink ?id=...
    const qs=new URLSearchParams(location.search);
    const openId=qs.get("id");
    if(openId){
      const o=objects.find(x=>x.id===openId);
      if(o?.lat!=null && o?.lng!=null){ map.setView([o.lat,o.lng], 15); }
      requestAnimationFrame(()=> markerById[openId]?.openPopup());
    }
  </script>
</body>
</html>
